<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TMS Dashboard - Transition Management</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #01A982 0%, #00856A 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .header h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        /* Main tab buttons */
        .main-tab-btn {
            background: rgba(255, 255, 255, 0.14);
            color: #e8f6f1;
            border: 1px solid rgba(255, 255, 255, 0.28);
            backdrop-filter: blur(6px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
        }

        .main-tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.22);
            color: #ffffff;
            transform: translateY(-1px);
        }

        .main-tab-btn.active {
            background: #f9fbfd;
            color: #0b5d4a;
            border-color: #d6e7df;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.14);
            transform: translateY(0);
        }
        
        .header p {
            color: #666;
            font-size: 1.1em;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px rgba(0,0,0,0.2);
        }
        
        .stat-card h3 {
            color: #666;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }
        
        .stat-card .value {
            font-size: 2.5em;
            font-weight: bold;
            color: #01A982;
        }
        
        .data-table {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            overflow-x: auto;
        }
        
        .data-table h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background: #f8f9fa;
            color: #333;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85em;
            letter-spacing: 0.5px;
        }
        
        th.sortable {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 25px;
        }
        
        th.sortable:hover {
            background: #e9ecef;
        }
        
        th.sortable::after {
            content: '‚áÖ';
            position: absolute;
            right: 8px;
            opacity: 0.3;
        }
        
        th.sortable.sort-asc::after {
            content: '‚Üë';
            opacity: 1;
        }
        
        th.sortable.sort-desc::after {
            content: '‚Üì';
            opacity: 1;
        }
        
        tr:hover {
            background: #f8f9fa;
        }
        
        code {
            background: #f5f5f5;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', Consolas, monospace;
            font-size: 0.9em;
        }
        
        .badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .badge-success {
            background: #d4edda;
            color: #155724;
        }
        
        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .badge-danger {
            background: #f8d7da;
            color: #721c24;
        }
        
        .badge-secondary {
            background: #e2e3e5;
            color: #383d41;
        }
        
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-healthy {
            background: #28a745;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .refresh-btn {
            background: #01A982;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-bottom: 20px;
        }
        
        .refresh-btn:hover {
            background: #00856A;
        }
        
        .search-box {
            width: 100%;
            max-width: 400px;
            padding: 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            margin-bottom: 20px;
            transition: border-color 0.3s ease;
        }
        
        .search-box:focus {
            outline: none;
            border-color: #01A982;
        }
        
        .server-info {
            background: #e7f3ff;
            border-left: 4px solid #01A982;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .server-info strong {
            color: #333;
        }
        
        .data-source-panel {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .data-source-panel h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
        }
        
        .tab-btn {
            background: transparent;
            border: none;
            padding: 12px 25px;
            font-size: 1em;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .tab-btn.active {
            color: #01A982;
            border-bottom-color: #01A982;
        }
        
        .tab-btn:hover {
            color: #01A982;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 500;
            font-size: 0.95em;
        }
        
        .form-group input[type="text"],
        .form-group input[type="password"],
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
            font-family: inherit;
        }
        
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #01A982;
        }
        
        .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 0.95em;
            transition: border-color 0.3s ease;
            font-family: inherit;
            background-color: white;
            cursor: pointer;
        }
        
        .form-group textarea {
            min-height: 200px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            resize: vertical;
        }
        
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #01A982;
            color: white;
        }
        
        .btn-primary:hover {
            background: #00856A;
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #d0d0d0;
        }
        
        .hint-text {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }
        
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-error {
            background: #fee;
            border-left: 4px solid #dc3545;
            color: #721c24;
        }
        
        .alert-success {
            background: #d4edda;
            border-left: 4px solid #28a745;
            color: #155724;
        }
        
        .clickable-hint {
            font-size: 0.75em;
            color: #999;
            margin-top: 5px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .stat-card:hover .clickable-hint {
            opacity: 1;
        }
        
        .view-section {
            display: none;
        }
        
        .view-section.active {
            display: block;
            width: 100%;
        }
        
        #mainView.active {
            display: block;
            position: relative;
            z-index: 1;
        }
        
        #stateView.active {
            display: block !important;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 1000;
            background: linear-gradient(135deg, #01A982 0%, #00856A 100%);
            overflow-y: auto;
            padding: 0;
            width: 100%;
            height: 100%;
            margin: 0;
        }
        
        #stateView .container {
            padding: 20px;
        }
        
        #stateView .data-table, 
        #stateView .state-details-header {
            background: white;
            margin-bottom: 20px;
        }
        
        .stat-card {
            cursor: pointer;
        }
        
        .back-button {
            background: #01A982;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-bottom: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-button:hover {
            background: #00856A;
        }
        
        .state-details-header {
            background: white;
            color: #333;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            border-left: 6px solid #01A982;
        }
        
        .state-details-header h2 {
            margin: 0;
            font-size: 2em;
            color: #01A982;
        }
        
        .state-details-header p {
            margin: 10px 0 0 0;
            opacity: 0.8;
            font-size: 1.1em;
            color: #666;
        }
        
        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            overflow: auto;
        }
        
        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 900px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 15px;
        }
        
        .modal-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8em;
        }
        
        .close-modal {
            background: #f0f0f0;
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            font-size: 1.5em;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }
        
        .close-modal:hover {
            background: #dc3545;
            color: white;
        }
        
        .app-status-table {
            margin-top: 20px;
        }
        
        .app-status-table table {
            width: 100%;
        }
        
        .status-ready {
            background: #d4edda;
            color: #155724;
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .status-failure {
            background: #f8d7da;
            color: #721c24;
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .status-transiting {
            background: #fff3cd;
            color: #856404;
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .status-unknown {
            background: #e2e3e5;
            color: #383d41;
            padding: 5px 12px;
            border-radius: 5px;
            font-weight: 600;
        }
        
        .customer-id-link {
            color: #01A982;
            text-decoration: underline;
            cursor: pointer;
            transition: color 0.3s ease;
            font-weight: 600;
        }
        
        .customer-id-link:hover {
            color: #00856A;
            text-decoration: none;
        }
        
        /* Audit History Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(3px);
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            background: linear-gradient(135deg, #01A982 0%, #00856A 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 1.5em;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5em;
            width: 35px;
            height: 35px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }
        
        .modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .modal-body {
            padding: 30px;
            max-height: calc(85vh - 90px);
            overflow-y: auto;
        }
        
        .audit-entry {
            background: #f8f9fa;
            border-left: 4px solid #01A982;
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 8px;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .audit-entry:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        
        .audit-entry.failure {
            border-left-color: #dc3545;
            background: #fff5f5;
        }
        
        .audit-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .audit-action {
            font-weight: 700;
            color: #333;
            font-size: 1.1em;
        }
        
        .audit-timestamp {
            color: #666;
            font-size: 0.9em;
        }
        
        .audit-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }
        
        .audit-detail-item {
            display: flex;
            flex-direction: column;
        }
        
        .audit-detail-label {
            color: #666;
            font-size: 0.85em;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 3px;
        }
        
        .audit-detail-value {
            color: #333;
            font-weight: 500;
        }
        
        .audit-status-badge {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .audit-status-badge.success {
            background: #d4edda;
            color: #155724;
        }
        
        .audit-status-badge.failure {
            background: #f8d7da;
            color: #721c24;
        }
        
        .no-audit-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .loading-spinner {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #01A982;
        }
        
        .aggregated-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .app-stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #01A982;
            box-shadow: 0 3px 10px rgba(0,0,0,0.1);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        .app-stat-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.15);
        }
        
        .app-stat-card h4 {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 1.1em;
            font-weight: 600;
        }
        
        .app-stat-card h4 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 1.1em;
        }
        
        .app-stat-summary {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }
        
        .stat-item {
            flex: 1;
            text-align: center;
        }
        
        .stat-item .label {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 5px;
        }
        
        .stat-item .value {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .stat-item.success .value {
            color: #28a745;
        }
        
        .stat-item.failure .value {
            color: #dc3545;
        }
        
        .chart-container {
            max-width: 300px;
            margin: 20px auto;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #01A982;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #01A982;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .scrollable-table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .scrollable-table-container table {
            margin: 0;
        }
        
        .scrollable-table-container thead {
            position: sticky;
            top: 0;
            z-index: 10;
            background: #f8f9fa;
        }
        
        #aggregatedStatusContainer {
            margin-top: 30px;
            display: none;
        }
        
        #aggregatedStatusContainer.active {
            display: block;
        }
        
        .aggregated-header {
            background: white;
            color: #333;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 6px solid #01A982;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }
        
        .aggregated-header h3 {
            margin: 0;
            font-size: 1.5em;
            color: #01A982;
        }
        
        .aggregated-header p {
            color: #666;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        const clusterConfig = {
            "us-west-2": "https://tms.us-west-2.np.cloud.hpe.com",
            "us-east-2": "https://tms.us-east-2.np.cloud.hpe.com",
            "eu-central-1": "https://tms.eu-central-1.np.cloud.hpe.com",
            "ap-northeast-1": "https://tms.ap-northeast-1.np.cloud.hpe.com",
            "ap-southeast-2": "https://tms.ap-southeast-2.np.cloud.hpe.com"
        };
    </script>
</head>
<body>
    <div class="container">
        <!-- Main Dashboard View -->
        <div id="mainView" class="view-section active">
        <div class="header">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/4/46/Hewlett_Packard_Enterprise_logo.svg" alt="HPE Logo" style="height: 50px;">
                    <div>
                        <h1>HPE Networking TMS Dashboard</h1>
                        <p>Transition Management System - Real-time Status Monitor</p>
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 20px;">
                    <div style="text-align: right; color: #666;">
                        <div style="font-size: 0.9em; margin-bottom: 3px;">Logged in as:</div>
                        <div id="currentUser" style="font-weight: 600; color: #01A982; font-size: 1.1em;">Loading...</div>
                    </div>
                    <button onclick="handleLogout()" style="background: #00856A; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 8px rgba(0, 133, 106, 0.3);" onmouseover="this.style.background='#01A982'" onmouseout="this.style.background='#00856A'">
                        üö™ Logout
                    </button>
                </div>
            </div>
            <div class="server-info">
                <span class="status-indicator status-healthy"></span>
                <strong>Server Status:</strong> <span id="serverStatus">Checking...</span> | 
                <strong>Last Updated:</strong> <span id="lastUpdate">Never</span>
            </div>
        </div>
        
        <!-- Main Tab Navigation -->
        <div style="display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 3px solid rgba(255,255,255,0.3);">
            <button class="main-tab-btn active" data-tab="token" onclick="switchMainTab('token')" style="flex: 1; padding: 15px; border: none; border-radius: 10px 10px 0 0; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                üîë CNX Token Generation
            </button>
            <button class="main-tab-btn" data-tab="proddata" onclick="switchMainTab('proddata')" style="flex: 1; padding: 15px; border: none; border-radius: 10px 10px 0 0; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                üì¶ Prod Customer Data
            </button>
            <button class="main-tab-btn" data-tab="set" onclick="switchMainTab('set')" style="flex: 1; padding: 15px; border: none; border-radius: 10px 10px 0 0; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                ‚öôÔ∏è TMS Customer Set
            </button>
            <button class="main-tab-btn" data-tab="status" onclick="switchMainTab('status')" style="flex: 1; padding: 15px; border: none; border-radius: 10px 10px 0 0; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                üìä TMS Customer Status
            </button>
            <button class="main-tab-btn" data-tab="audit" onclick="switchMainTab('audit')" style="flex: 1; padding: 15px; border: none; border-radius: 10px 10px 0 0; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: all 0.3s;">
                üìã User Jobs Audit
            </button>
        </div>
        
        <!-- Prod Customer Data Tab -->
        <div id="proddataTab" class="main-tab-content" style="display: none;">
            <style>
                .prod-card {background: #f7f9fb; border-radius: 12px; padding: 20px; box-shadow: 0 4px 14px rgba(0,0,0,0.05); border: 1px solid #e4e7ec;}
                .prod-row {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px;}
                .prod-row-top {display: grid; grid-template-columns: 0.8fr 0.8fr 1fr 1fr auto auto; gap: 12px; align-items: end;}
                .prod-field label {display: block; margin-bottom: 6px; font-weight: 600; color: #1f2933;}
                .prod-field label .required {color: #e74c3c;}
                .prod-field select, .prod-field input, .prod-field textarea {width: 100%; padding: 10px 12px; border: 1px solid #cfd5df; border-radius: 8px; font-size: 0.95em; background: #fff;}
                .prod-field textarea {min-height: 160px; resize: vertical;}
                .prod-field-error {border-color: #e74c3c !important; background-color: #fef5f5;}
                .prod-error-msg {color: #e74c3c; font-size: 0.8em; margin-top: 4px;}
                .prod-actions {display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 16px; align-items: end;}
                .prod-btn-primary {width: 100%; padding: 12px; background: #01A982; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 6px 14px rgba(1,169,130,0.15); transition: transform 0.1s ease, box-shadow 0.1s ease;}
                .prod-btn-primary:hover {transform: translateY(-1px); box-shadow: 0 8px 18px rgba(1,169,130,0.22);}
                .prod-btn-run {padding: 10px 18px; background: #01A982; color: #fff; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; box-shadow: 0 4px 10px rgba(1,169,130,0.15); transition: transform 0.1s ease, box-shadow 0.1s ease; white-space: nowrap; height: fit-content;}
                .prod-btn-run:hover {transform: translateY(-1px); box-shadow: 0 6px 14px rgba(1,169,130,0.22);}
                .prod-btn-secondary {padding: 10px 14px; background: #4b5563; color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;}
                .prod-table {margin-top: 22px; border: 1px solid #d4d9e1; border-radius: 10px; overflow: hidden; background: #fff;}
                .prod-table thead {background: #f0f4f8; color: #1f2933; text-transform: uppercase; font-size: 0.85em; letter-spacing: 0.5px;}
                .prod-table th, .prod-table td {padding: 12px 14px; border-bottom: 1px solid #e6e9ef;}
                .prod-table tbody tr:last-child td {border-bottom: none;}
                .prod-table button {padding: 8px 12px; border-radius: 6px; border: 1px solid #cfd5df; background: #fff; cursor: pointer; font-weight: 600;}
                .prod-muted {color: #6b7280; font-size: 0.9em; margin-top: 6px;}
                .prod-customer-summary {font-size: 1.1em; font-weight: 600; color: #01A982; padding: 12px; background: #f0f9f7; border-radius: 8px; border: 1px solid #d4e9e4; text-align: center; margin-bottom: 16px;}
                @media (max-width: 640px) {.prod-actions {grid-template-columns: 1fr;} .prod-row-top {grid-template-columns: 1fr;}}
            </style>

            <!-- Section 1: Prod Customer Data (Admin Only) -->
            <div id="prodCustomerDataSection" class="prod-card">
                <div style="display: flex; justify-content: space-between; align-items: baseline; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <h2 style="margin: 0;">üì¶ Prod Customer Data</h2>
                        <div style="color: #556070;">Fetch customer data from source API and check stored records</div>
                    </div>
                    <button class="prod-btn-secondary" onclick="clearProdDataForm()">Clear</button>
                </div>

                <div class="prod-row-top" style="margin-top: 14px;">
                    <div class="prod-field">
                        <label for="prodDataApiUrl">Data Source URL <span class="required">*</span></label>
                        <input id="prodDataApiUrl" type="text" placeholder="Enter API endpoint URL" onchange="clearProdDataResults()" />
                        <div id="prodDataApiUrlError" class="prod-error-msg" style="display: none;"></div>
                    </div>
                    <div class="prod-field">
                        <label for="prodBearerToken">Bearer Token <span class="required">*</span></label>
                        <input id="prodBearerToken" type="password" placeholder="Enter Bearer token" onchange="clearProdDataResults()" />
                        <div id="prodBearerTokenError" class="prod-error-msg" style="display: none;"></div>
                    </div>
                    <div class="prod-field">
                        <label for="prodClusterSelect">Cluster <span class="required">*</span></label>
                        <select id="prodClusterSelect" onchange="clearProdDataResults()">
                            <option value="">Loading clusters...</option>
                        </select>
                        <div id="prodClusterSelectError" class="prod-error-msg" style="display: none;"></div>
                    </div>
                    <div class="prod-field">
                        <label for="prodDeviceSelect">Device Selection <span class="required">*</span></label>
                        <select id="prodDeviceSelect" onchange="clearProdDataResults()">
                            <option value="">Loading devices...</option>
                        </select>
                        <div id="prodDeviceSelectError" class="prod-error-msg" style="display: none;"></div>
                    </div>
                    <button class="prod-btn-run" onclick="showProdDataConfirmation()">Run</button>
                </div>

                <!-- Customer ID Input Options Section -->
                <div class="prod-field" style="margin-top: 18px; padding: 14px; background: #f3f5f8; border-radius: 8px; border: 1px solid #d9dce3;">
                    <label style="font-weight: 700; color: #1f2933; margin-bottom: 12px; display: block;">Customer ID Input Options</label>
                    <div style="color: #556070; font-size: 0.9em; margin-bottom: 14px;">Select one method below. If API URL is provided, it will take priority. Otherwise, CSV or manual entry will be used.</div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                        <!-- CSV Upload Option -->
                        <div class="prod-field">
                            <label for="prodCsvUpload" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-weight: 600;">
                                üì§ Upload CSV
                            </label>
                            <input id="prodCsvUpload" type="file" accept=".csv" onchange="handleProdCsvUpload(event)" />
                            <div id="prodCsvFileName" style="font-size: 0.85em; color: #6b7280; margin-top: 6px;">No file selected</div>
                        </div>
                        
                        <!-- Manual Entry Option -->
                        <div class="prod-field">
                            <label for="prodManualEntry" style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px; font-weight: 600;">
                                ‚úçÔ∏è Manual Entry
                            </label>
                            <textarea id="prodManualEntry" placeholder="One CID per line or comma-separated&#10;Example:&#10;CUST001&#10;CUST002&#10;CUST003" style="min-height: 80px; resize: vertical; font-family: monospace; font-size: 0.9em;" onchange="clearProdDataResults()"></textarea>
                        </div>
                    </div>
                    
                    <div style="margin-top: 10px; padding: 10px; background: #e8f4f8; border-radius: 6px; border-left: 3px solid #01A982; font-size: 0.85em; color: #556070;">
                        <strong>Helper:</strong> Provide customer IDs manually or upload a CSV. If API URL is provided, CSV/manual input will be ignored.
                    </div>
                </div>

                <div class="prod-field" style="margin-top: 18px;">
                    <label>Customer ID's (TOTAL)</label>
                    <div id="prodDataCustomerIdCount" style="font-size: 1.2em; font-weight: 600; color: #01A982; padding: 12px; background: #f0f9f7; border-radius: 8px; border: 1px solid #d4e9e4; text-align: center;">‚Äî</div>
                    <div id="prodDataSuccessMessage" style="display: none; background: #d4edda; color: #155724; padding: 10px; border-radius: 6px; margin-top: 10px; border: 1px solid #c3e6cb; font-size: 0.95em; text-align: center;"></div>
                </div>

                <div class="prod-field" style="margin-top: 18px;">
                    <label>Data Store</label>
                    <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: end;">
                        <div id="prodStoredDataDisplay" style="font-size: 0.95em; color: #556070; padding: 10px; background: #f7f9fb; border-radius: 6px; border: 1px solid #e4e7ec; text-align: center;">‚Äî</div>
                        <button class="prod-btn-primary" style="padding: 10px 16px; font-size: 0.9em; white-space: nowrap;" onclick="checkProdStoredData()">Check Stored</button>
                    </div>
                </div>

                <div id="prodDataResponse" style="display: none; background: #d4edda; color: #155724; padding: 12px; border-radius: 8px; margin-top: 16px; border: 1px solid #c3e6cb;"></div>
                <div id="prodDataError" style="display: none; background: #f8d7da; color: #721c24; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid #f5c6cb;"></div>

                <!-- Confirmation Modal -->
                <div id="prodConfirmationModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 20px 0; color: #1f2933; font-size: 1.2em;">Confirm Run Parameters</h3>
                        <div style="background: #f7f9fb; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e4e7ec;">
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-weight: 600; color: #556070; font-size: 0.85em;">Data Source URL</label>
                                <div id="prodConfirmDataSourceUrl" style="color: #1f2933; margin-top: 4px; word-break: break-all;">‚Äî</div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-weight: 600; color: #556070; font-size: 0.85em;">Bearer Token</label>
                                <div id="prodConfirmToken" style="color: #1f2933; margin-top: 4px; font-family: monospace; word-break: break-all;">‚Äî</div>
                            </div>
                            <div style="margin-bottom: 12px;">
                                <label style="display: block; font-weight: 600; color: #556070; font-size: 0.85em;">Cluster</label>
                                <div id="prodConfirmCluster" style="color: #1f2933; margin-top: 4px;">‚Äî</div>
                            </div>
                            <div>
                                <label style="display: block; font-weight: 600; color: #556070; font-size: 0.85em;">Device Type</label>
                                <div id="prodConfirmDevice" style="color: #1f2933; margin-top: 4px;">‚Äî</div>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="closeProdDataConfirmation()" style="padding: 10px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
                            <button onclick="confirmProdDataRun()" style="padding: 10px; background: #01A982; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Confirm</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- End Section 1: Prod Customer Data -->

            <!-- Section 2: Generate Batch ID's (Admin Only) -->
            <div id="generateBatchSection" class="prod-card" style="margin-top: 24px;">
                <div style="display: flex; justify-content: space-between; align-items: baseline; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <h2 style="margin: 0;">üîÑ Generate Batch ID's</h2>
                        <div style="color: #556070;">Create and manage batch IDs for device assignment</div>
                    </div>
                </div>

                <div class="prod-row-top" style="margin-top: 14px;">
                    <div class="prod-field">
                        <label for="batchClusterSelect">Cluster <span class="required">*</span></label>
                        <select id="batchClusterSelect" onchange="onBatchClusterDeviceChange()">
                            <option value="">Loading clusters...</option>
                        </select>
                    </div>
                    <div class="prod-field">
                        <label for="batchDeviceSelect">Device Selection <span class="required">*</span></label>
                        <select id="batchDeviceSelect" onchange="onBatchClusterDeviceChange()">
                            <option value="">Loading devices...</option>
                        </select>
                    </div>
                    <div class="prod-field">
                        <label for="batchTotalDevices">Total Devices <span class="required">*</span></label>
                        <input id="batchTotalDevices" type="number" min="1" placeholder="e.g., 100" onchange="onTotalDevicesChange()" />
                    </div>
                    <div class="prod-field">
                        <label for="prodDevicePerBatch">Device Per Batch <span class="required">*</span></label>
                        <input id="prodDevicePerBatch" type="number" min="1" placeholder="e.g., 10" onchange="onDevicePerBatchChange()" />
                        <div id="prodDevicePerBatchWarning" class="prod-error-msg" style="display: none; color: #ff9800;"></div>
                    </div>
                    <button class="prod-btn-run" id="generateBatchBtn" onclick="generateBatches()" disabled style="opacity: 0.5; cursor: not-allowed; height: fit-content; white-space: nowrap;">Generate</button>
                    <button class="prod-btn-secondary" id="deleteBatchBtn" onclick="showDeleteBatchConfirmation()" disabled style="background: #dc3545; opacity: 0.5; cursor: not-allowed; height: fit-content; white-space: nowrap;">Delete ID's</button>
                </div>

                <div id="batchStatusMessage" style="display: none; background: #f0f9f7; color: #01A982; padding: 12px; border-radius: 8px; margin-top: 14px; border: 1px solid #d4e9e4; font-size: 0.95em;"></div>
                <div id="batchErrorMessage" style="display: none; background: #fef5f5; color: #e74c3c; padding: 12px; border-radius: 8px; margin-top: 10px; border: 1px solid #f5c6cb; font-size: 0.95em;"></div>
                <div id="batchCountHint" style="display: none; font-size: 0.9em; color: #556070; margin-top: 10px;">Existing batches: <strong id="batchCountValue">0</strong></div>

                <div id="batchPreviewSection" style="display: none; background: #f7f9fb; padding: 16px; border-radius: 8px; margin-top: 14px; border: 1px solid #e4e7ec;">
                    <div style="font-weight: 600; color: #1f2933; margin-bottom: 12px;">Batch Preview</div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; font-size: 0.9em;">
                        <div>
                            <label style="color: #556070; font-size: 0.85em;">Total Customers</label>
                            <div style="color: #1f2933; font-weight: 600; margin-top: 4px;" id="previewTotalCustomers">‚Äî</div>
                        </div>
                        <div>
                            <label style="color: #556070; font-size: 0.85em;">Total Devices</label>
                            <div style="color: #1f2933; font-weight: 600; margin-top: 4px;" id="previewTotalDevices">‚Äî</div>
                        </div>
                        <div>
                            <label style="color: #556070; font-size: 0.85em;">Avg Devices/Customer</label>
                            <div style="color: #1f2933; font-weight: 600; margin-top: 4px;" id="previewAvgDevices">‚Äî</div>
                        </div>
                        <div>
                            <label style="color: #556070; font-size: 0.85em;">Customers Per Batch</label>
                            <div style="color: #1f2933; font-weight: 600; margin-top: 4px;" id="previewCustomersPerBatch">‚Äî</div>
                        </div>
                        <div>
                            <label style="color: #556070; font-size: 0.85em;">Estimated Batches</label>
                            <div style="color: #1f2933; font-weight: 600; margin-top: 4px;" id="previewEstimatedBatches">‚Äî</div>
                        </div>
                    </div>
                </div>

                <div class="prod-table" style="margin-top: 22px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="text-align: left;">Batch ID</th>
                                <th style="width: 100px; text-align: center;">Status</th>
                                <th style="width: 120px; text-align: center;">Assigned To</th>
                                <th style="width: 90px; text-align: center;">Select</th>
                                <th style="width: 110px; text-align: center;">Assign</th>
                            </tr>
                        </thead>
                        <tbody id="prodBatchListBody">
                            <tr>
                                <td colspan="5" style="text-align: center; color: #6b7280;">No batches generated yet</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Delete Batch Confirmation Modal -->
                <div id="deleteBatchModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; border-radius: 12px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                        <h3 style="margin: 0 0 20px 0; color: #dc3545; font-size: 1.2em;">Delete Batches</h3>
                        <div style="background: #fef5f5; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #f5c6cb;">
                            <p style="margin: 0 0 12px 0; color: #1f2933;">Delete all batches for <strong id="deleteConfirmCluster">‚Äî</strong> / <strong id="deleteConfirmDevice">‚Äî</strong>?</p>
                            <p style="margin: 0; color: #721c24; font-size: 0.95em;">This will permanently delete all generated batch IDs for this cluster/device selection. This cannot be undone.</p>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <button onclick="closeDeleteBatchConfirmation()" style="padding: 10px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
                            <button onclick="confirmDeleteBatches()" style="padding: 10px; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Confirm Delete</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Assign Selected Batches Confirmation Modal -->
            <div id="assignSelectedModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                <div style="background: white; border-radius: 12px; padding: 30px; max-width: 450px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
                    <h3 style="margin: 0 0 20px 0; color: #01A982; font-size: 1.2em;">Confirm Assignment</h3>
                    <div style="background: #eef9f7; padding: 16px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #b8e5dd;">
                        <p style="margin: 0 0 12px 0; color: #1f2933;">You selected <strong id="confirmSelectedCount">0</strong> batch(es). Do you want to assign them to yourself?</p>
                        <div id="assignSkippedWarning" style="display: none; margin-top: 12px; padding: 12px; background: #fff3cd; border-radius: 6px; border-left: 4px solid #ffc107; color: #856404; font-size: 0.9em;">
                            <p style="margin: 0;"><strong>Note:</strong> Some batches may already be assigned and will be skipped.</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <button onclick="closeAssignSelectedConfirmation()" style="padding: 10px; background: #6b7280; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Cancel</button>
                        <button onclick="confirmAssignSelected()" style="padding: 10px; background: #01A982; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Assign</button>
                    </div>
                </div>
            </div>
            <!-- End Assign Selected Modal -->
            <!-- End Section 2: Generate Batch ID's -->
            
            <!-- Section 3: Batch Assignment (Non-Admin Users Only) -->
            <div id="batchAssignmentSection" class="prod-card" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: baseline; gap: 10px; margin-bottom: 10px;">
                    <div>
                        <h2 style="margin: 0;">üìã Assign Batches</h2>
                        <div style="color: #556070;">Select and assign batch IDs for processing</div>
                    </div>
                </div>
                
                <!-- Cluster and Device Selection Row -->
                <div class="prod-row-top" style="grid-template-columns: 0.8fr 0.8fr auto; gap: 16px; margin-bottom: 20px;">
                    <div class="prod-field">
                        <label for="batchAssignClusterSelect">Cluster <span class="required">*</span></label>
                        <select id="batchAssignClusterSelect" onchange="onBatchAssignClusterDeviceChange()">
                            <option value="">Loading clusters...</option>
                        </select>
                    </div>
                    <div class="prod-field">
                        <label for="batchAssignDeviceSelect">Device Selection <span class="required">*</span></label>
                        <select id="batchAssignDeviceSelect" onchange="onBatchAssignClusterDeviceChange()">
                            <option value="">Loading devices...</option>
                        </select>
                    </div>
                    <button class="prod-btn" id="loadBatchesBtn" onclick="loadBatchesForAssignment()" disabled style="height: fit-content; white-space: nowrap; background: #01A982; color: white; padding: 12px 20px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em; align-self: flex-end;">Load Batches</button>
                </div>
                
                <!-- Status Messages -->
                <div id="assignStatusMessage" style="display: none; background: #d4edda; color: #155724; padding: 12px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #28a745;"></div>
                <div id="assignErrorMessage" style="display: none; background: #f8d7da; color: #721c24; padding: 12px; border-radius: 6px; margin-bottom: 16px; border-left: 4px solid #f5c6cb;"></div>
                
                <!-- Batch Assignment Table -->
                <div class="prod-table" style="margin-top: 22px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr>
                                <th style="width: 40px; text-align: center;"><input type="checkbox" id="selectAllBatches" onchange="toggleSelectAllBatches()" /></th>
                                <th style="text-align: left;">Batch ID</th>
                                <th style="width: 100px; text-align: center;">Customers</th>
                                <th style="width: 100px; text-align: center;">Status</th>
                                <th style="width: 120px; text-align: center;">Assigned To</th>
                                <th style="width: 100px; text-align: center;">Download</th>
                            </tr>
                        </thead>
                        <tbody id="assignBatchListBody">
                            <tr>
                                <td colspan="6" style="text-align: center; color: #6b7280;">Select cluster and device to load batches</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- Assign Selected Button -->
                <div style="display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px;">
                    <button id="assignSelectedBtn" class="prod-btn" onclick="showAssignSelectedConfirmation()" disabled style="background: #01A982; color: white; padding: 12px 24px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1em;">
                        Assign Selected (<span id="selectedCountBadge">0</span>)
                    </button>
                </div>
            </div>
            <!-- End Section 3: Batch Assignment -->
        </div>
        
        <!-- Set Action Tab -->
        <div id="setTab" class="main-tab-content" style="display: none;">
            <div class="data-table">
                <h2>‚öôÔ∏è Set Customer State / Action</h2>
                <p style="color: #666; margin-bottom: 20px;">Update customer states using the TMS /set/action API</p>
                
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; border-left: 4px solid #01A982;">
                    <div class="form-grid">
                        <div class="form-group" style="flex: 1; min-width: 250px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">API Base URL <span style="color: #dc3545;">*</span></label>
                            <input type="text" id="setActionApiBase" placeholder="e.g., https://cnx-apigw-evian3.arubadev.cloud.hpe.com" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;" />
                            <div style="margin-top: 6px; font-size: 0.85em; color: #666;">Used to construct: {API Base}/tms/v1/set/action</div>
                        </div>
                        <div class="form-group" style="flex: 1; min-width: 250px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Select Action <span style="color: #dc3545;">*</span></label>
                            <select id="actionSelect" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                                <option value="">-- Choose an action --</option>
                                <option value="Tran-Begin">Tran-Begin</option>
                                <option value="PE-Enable">PE-Enable</option>
                                <option value="T-Enable">T-Enable</option>
                                <option value="PE-Finalize">PE-Finalize</option>
                                <option value="PE-Direct">PE-Direct</option>
                            </select>
                        </div>
                        
                        <div class="form-group" style="flex: 1; min-width: 250px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Bearer Token <span style="color: #dc3545;">*</span></label>
                            <input type="password" id="setActionToken" placeholder="Enter your Bearer token" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em;">
                        </div>
                    </div>
                    
                    <!-- Load Assigned Batches Section (Non-Admin Only) -->
                    <div id="loadAssignedBatchesSection" style="display: none; margin-top: 25px; padding: 20px; background: #f0f9f7; border: 2px solid #d4e9e4; border-radius: 8px;">
                        <h3 style="margin: 0 0 15px 0; color: #01A982; font-size: 1.1em;">üì¶ Load Assigned Batches</h3>
                        
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-bottom: 15px;">
                            <div class="form-group" style="margin: 0;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 0.9em;">Cluster <span style="color: #dc3545;">*</span></label>
                                <select id="setBatchClusterSelect" style="width: 100%; padding: 10px; border: 1px solid #cfd5df; border-radius: 6px;">
                                    <option value="">Select Cluster</option>
                                    <option value="APAC">AP-APAC</option>
                                    <option value="APACEAST">AP-APAC EAST</option>
                                    <option value="APAC SOUTH">AP-APAC SOUTH</option>
                                    <option value="EU">EU</option>
                                    <option value="EU2">EU2</option>
                                    <option value="EU3">EU3</option>
                                    <option value="PROD">PROD</option>
                                    <option value="PROD2">PROD2</option>
                                    <option value="STARMAN">STARMAN</option>
                                    <option value="US4">US4</option>
                                    <option value="US5">US5</option>
                                    <option value="US EAST1">US EAST1</option>
                                    <option value="test">test</option>
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin: 0;">
                                <label style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 0.9em;">Device Selection <span style="color: #dc3545;">*</span></label>
                                <select id="setBatchDeviceSelect" style="width: 100%; padding: 10px; border: 1px solid #cfd5df; border-radius: 6px;">
                                    <option value="">Select Device</option>
                                    <option value="AOS8">AOS8</option>
                                    <option value="AOS10 Small">AOS10 Small</option>
                                    <option value="AOS10 Medium">AOS10 Medium</option>
                                    <option value="AOS10 Large">AOS10 Large</option>
                                    <option value="AOS10 Xlarge">AOS10 Xlarge</option>
                                    <option value="dummy">dummy</option>
                                </select>
                            </div>
                            
                            <div style="display: flex; align-items: flex-end; gap: 10px;">
                                <button class="btn btn-primary" onclick="loadMyAssignedBatches()" style="flex: 1; padding: 12px; white-space: nowrap;">Load My Batches</button>
                            </div>
                        </div>
                        
                        <div id="setBatchLoadingMessage" style="display: none; padding: 10px; background: #e7f3ff; border-left: 4px solid #01A982; border-radius: 4px; color: #0055b8; font-size: 0.9em;">Loading batches...</div>
                        
                        <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: start; margin-bottom: 12px;">
                            <div class="form-group" style="margin: 0; grid-column: 1;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333; font-size: 0.9em;">Assigned Batches <span style="color: #dc3545;">*</span></label>
                                <div id="setBatchCheckboxContainer" style="border: 1px solid #cfd5df; border-radius: 6px; padding: 10px; background: #fff; max-height: 250px; overflow-y: auto;">
                                    <div style="padding: 20px; text-align: center; color: #999; font-size: 0.9em;">Load batches to see options</div>
                                </div>
                                <div id="setBatchError" style="display: none; color: #dc3545; font-size: 0.85em; margin-top: 6px;"></div>
                            </div>
                            
                            <div style="padding-top: 30px;">
                                <button class="btn btn-secondary" onclick="selectAllSetBatches()" id="selectAllBtn" style="padding: 8px 12px; display: none; white-space: nowrap;">‚òë Select All</button>
                            </div>
                            
                            <div style="padding-top: 30px;">
                                <button class="btn btn-secondary" onclick="clearAllSetBatches()" id="clearAllBtn" style="padding: 8px 12px; display: none; white-space: nowrap;">Clear</button>
                            </div>
                        </div>
                        
                        <div id="setBatchSummary" style="display: none; padding: 12px; background: #f0f9f7; border: 1px solid #d4e9e4; border-radius: 6px; font-size: 0.9em; color: #556070; margin-bottom: 12px;">
                            <div>Selected batches: <strong id="setBatchSelectedCount">0</strong></div>
                            <div style="margin-top: 6px;">Total customers: <strong id="setBatchTotalCustomers">0</strong></div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: start;">
                            <div></div>
                            <a href="#" id="setBatchDownloadLink" onclick="downloadSetBatchCustomersCSV(); return false;" style="display: none; color: #01A982; text-decoration: none; font-weight: 600; white-space: nowrap; padding-top: 6px;">üì• Download Selected</a>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #333;">Customer IDs (one per line or comma-separated) <span style="color: #dc3545;">*</span></label>
                        
                        <!-- CSV Upload Section -->
                        <div style="display: flex; gap: 10px; margin-bottom: 12px; align-items: center; flex-wrap: wrap;">
                            <label for="csvFileInput" class="btn btn-secondary" style="margin: 0; padding: 8px 16px; cursor: pointer; display: inline-flex; align-items: center; gap: 8px;">
                                üìÅ Upload CSV
                                <input type="file" id="csvFileInput" accept=".csv" style="display: none;" onchange="handleCSVUpload(event)">
                            </label>
                            <a href="/static/sample_customers.csv" download="sample_customers.csv" class="btn btn-secondary" style="margin: 0; padding: 8px 16px; text-decoration: none; display: inline-flex; align-items: center; gap: 8px;">
                                üì• Download Sample CSV
                            </a>
                            <span id="csvFileName" style="color: #666; font-size: 0.9em;"></span>
                            <button class="btn btn-secondary" onclick="clearCustomerIds()" style="margin: 0; padding: 8px 16px;">
                                Clear All
                            </button>
                        </div>
                        
                        <textarea id="customerIds" placeholder="Enter customer IDs&#10;Example:&#10;e106b3d0fb0111efb2cdda09530d43d0&#10;948ef156c19511f08f342664b3b9825e&#10;Or: id1,id2,id3&#10;&#10;Or upload a CSV file with customer IDs" 
                                  style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1em; font-family: monospace; min-height: 120px; max-height: 400px; overflow-y: auto; resize: vertical;"></textarea>
                        <div class="hint-text" style="margin-top: 8px;">
                            üí° Enter one customer ID per line, comma-separated, or upload a CSV file with customer IDs
                            <span id="customerCount" style="margin-left: 10px; font-weight: 600; color: #01A982;"></span>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button class="btn btn-primary" onclick="executeSetAction()" style="flex: 1; padding: 12px;">
                        üöÄ Set Action
                    </button>
                    <button class="btn btn-secondary" onclick="clearSetForm()">
                        Clear Form
                    </button>
                </div>
                
                <!-- Response Area -->
                <div id="setActionResponse" style="display: none; margin-top: 25px; padding: 20px; border-radius: 10px; border-left: 4px solid #01A982;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 id="responseTitle" style="margin: 0; color: #01A982;">‚úÖ Success</h3>
                        <button onclick="document.getElementById('setActionResponse').style.display='none'" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">‚úï</button>
                    </div>
                    <div id="responseContent" style="color: #333;"></div>
                </div>
                
                <!-- Error Area -->
                <div id="setActionError" style="display: none; margin-top: 25px; padding: 20px; border-radius: 10px; background: #fff3cd; border-left: 4px solid #dc3545;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 style="margin: 0; color: #dc3545;">‚ùå Error</h3>
                        <button onclick="document.getElementById('setActionError').style.display='none'" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">‚úï</button>
                    </div>
                    <div id="errorContent" style="color: #333;"></div>
                </div>
            </div>
        </div>
        
        <!-- Status Tab -->
        <div id="statusTab" class="main-tab-content" style="display: none;">
        
        <!-- Data Source Configuration -->
        <div class="data-source-panel">
            <h2>üì° Data Source</h2>
            
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('api')">Fetch via API</button>
                <button class="tab-btn" onclick="switchTab('paste')">Paste JSON</button>
            </div>
            
            <!-- API Mode -->
            <div id="apiTab" class="tab-content active">
                <div class="form-grid">
                    <div class="form-group">
                        <label>API Base URL</label>
                        <input type="text" id="apiBaseUrl" placeholder="Enter API base URL">
                    </div>
                    <div class="form-group">
                        <label>Transition Endpoint Path</label>
                        <input type="text" id="transitionPath" placeholder="v1/get/action?cid=ALL" value="v1/get/action?cid=ALL">
                    </div>
                    <div class="form-group">
                        <label>Bearer Token (optional)</label>
                        <input type="password" id="bearerToken" placeholder="Paste your token here">
                        <div class="hint-text">‚ö†Ô∏è Tokens are proxied through the server for security</div>
                    </div>
                    <div class="form-group">
                        <label>Job ID (optional)</label>
                        <input type="text" id="jobIdFilter" placeholder="Enter Job ID to filter customers (e.g., 550e8400-e29b-41d4-a716-446655440000)">
                        <div class="hint-text">‚ÑπÔ∏è Leave empty to show all customers. When provided, dashboard filters to this job's customers only</div>
                    </div>
                </div>
                
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="fetchFromAPI()" id="fetchBtn">
                        üîÑ Fetch Transition States
                    </button>
                    <button class="btn btn-secondary" onclick="clearToken()">
                        Clear Token
                    </button>
                </div>
                
                <div id="apiError" class="alert alert-error" style="display: none; margin-top: 20px;"></div>
                <div id="apiSuccess" class="alert alert-success" style="display: none; margin-top: 20px;"></div>
            </div>
            
            <!-- Paste JSON Mode -->
            <div id="pasteTab" class="tab-content">
                <div class="form-group">
                    <label>Paste Transition JSON</label>
                    <textarea id="jsonInput" placeholder='Paste your JSON here, e.g.:
{
  "685102e6fc1511ef9ee8561b853a244c": { "action_code": 5, "action_desc": "pe-direct" },
  "6866cf36c19511f0a69e0a3464f46ecd": { "action_code": 2, "action_desc": "pe-enable" }
}'></textarea>
                    <div class="hint-text">Expected format: Object with customer IDs as keys</div>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="loadFromJSON()">
                        üì• Load JSON
                    </button>
                    <button class="btn btn-secondary" onclick="clearJSON()">
                        Clear
                    </button>
                </div>
                
                <div id="jsonError" class="alert alert-error" style="display: none; margin-top: 20px;"></div>
                <div id="jsonSuccess" class="alert alert-success" style="display: none; margin-top: 20px;"></div>
            </div>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <h3>Total Customers</h3>
                <div class="value" id="totalCustomers">0</div>
            </div>
            <div class="stat-card" onclick="showStateDetails('Tran-Begin')">
                <h3>Tran-Begin</h3>
                <div class="value" id="tranBegin">0</div>
                <div class="clickable-hint">Click to view customers</div>
            </div>
            <div class="stat-card" onclick="showStateDetails('PE-Enable')">
                <h3>PE-Enable</h3>
                <div class="value" id="peEnable">0</div>
                <div class="clickable-hint">Click to view customers</div>
            </div>
            <div class="stat-card" onclick="showStateDetails('T-Enable')">
                <h3>T-Enable</h3>
                <div class="value" id="tEnable">0</div>
                <div class="clickable-hint">Click to view customers</div>
            </div>
            <div class="stat-card" onclick="showStateDetails('PE-Finalize')">
                <h3>PE-Finalize</h3>
                <div class="value" id="peFinalize">0</div>
                <div class="clickable-hint">Click to view customers</div>
            </div>
            <div class="stat-card" onclick="showStateDetails('PE-Direct')">
                <h3>PE-Direct</h3>
                <div class="value" id="peDirect">0</div>
                <div class="clickable-hint">Click to view customers</div>
            </div>
        </div>
        
        <div class="data-table">
            <h2>Customer Transition States</h2>
            
            <div style="background: #e7f3ff; border-left: 4px solid #01A982; padding: 12px 20px; border-radius: 6px; margin-bottom: 20px; color: #555; font-size: 0.95em;">
                <strong>üí° Note:</strong> Click on a Customer ID to view the transition history.
            </div>
            <button class="refresh-btn" onclick="loadData()">üîÑ Refresh Data</button>
            <input type="text" class="search-box" id="searchBox" placeholder="üîç Search by Customer ID or State...">
            <div id="tableContainer">
                <div class="loading">Loading data...</div>
            </div>
        </div>
        </div>
    </div>
        
    <!-- State Details View -->
    <div id="stateView" class="view-section">
        <div class="container" style="padding-top: 30px;">
            <button class="back-button" onclick="showMainView()">
                ‚Üê Back to Dashboard
            </button>
            
            <div class="state-details-header">
                <h2 id="stateViewTitle">State Details</h2>
                <p id="stateViewSubtitle">Loading...</p>
            </div>
            
            <div class="data-table">
                <div class="action-buttons" id="stateActionButtons" style="display: none;">
                    <div style="width: 100%; margin-bottom: 15px;">
                        <h3 style="margin: 0 0 15px 0; color: #333; font-size: 1.2em;">üìä Application Status Configuration</h3>
                    </div>
                    
                    <div class="form-group" style="flex: 1; margin: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 0.9em;">API Base URL</label>
                        <input type="text" id="appStatusApiUrl" placeholder="API Base URL" 
                               value="https://cnx-apigw-evian3.arubadev.cloud.hpe.com" style="width: 100%;">
                    </div>
                    <div class="form-group" style="flex: 0 0 250px; margin: 0;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 500; color: #333; font-size: 0.9em;">Bearer Token <span style="color: #dc3545;">*</span></label>
                        <input type="password" id="appStatusToken" placeholder="Enter Bearer Token" style="width: 100%;">
                    </div>
                    <div style="width: 100%; margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="fetchAggregatedAppStatus()" id="fetchAggregatedBtn">
                            üìä View APP Status
                        </button>
                        <button class="btn btn-secondary" onclick="hideAggregatedStatus()" id="hideAggregatedBtn" style="display: none;">
                            ‚úï Hide APP Status
                        </button>
                    </div>
                </div>
                <div style="background: #e7f3ff; border-left: 4px solid #01A982; padding: 12px 20px; border-radius: 6px; margin-bottom: 20px; color: #555; font-size: 0.95em;">
                    <strong>üí° Note:</strong> Click on a Customer ID to view the transition history of the customer.
                </div>
                <input type="text" class="search-box" id="stateSearchBox" placeholder="üîç Search by Customer ID...">
                <div class="scrollable-table-container" id="stateTableContainer">
                    <div class="loading">Loading...</div>
                </div>
                
                <!-- Aggregated Status Section -->
                <div id="aggregatedStatusContainer">
                    <div style="border-top: 2px solid #e0e0e0; margin: 30px 0 20px 0;"></div>
                    <div class="aggregated-header">
                        <h3>üìä APP Status</h3>
                        <p id="aggregatedSubtitle" style="margin: 5px 0 0 0; opacity: 0.9;">Loading...</p>
                    </div>
                    <div id="aggregatedStatusContent"></div>
                    
                    <!-- Customer Drill-Down Section -->
                    <div id="customerDrillDown" style="display: none; margin-top: 30px; background: white; padding: 25px; border-radius: 10px; border-left: 4px solid #01A982; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                            <h3 style="margin: 0; color: #01A982;">üìã Customer List</h3>
                            <button class="btn btn-secondary" onclick="hideCustomerDrillDown()" style="padding: 5px 15px;">‚úï Close</button>
                        </div>
                        <p id="drillDownTitle" style="color: #666; margin-bottom: 15px; font-size: 1.05em;"></p>
                        <input type="text" class="search-box" id="drillDownSearch" placeholder="üîç Search customers..." style="margin-bottom: 15px;">
                        <div id="drillDownContent"></div>
                    </div>
                </div>
            </div>
        </div>
        </div>
        
        <!-- App Status Modal -->
        <div id="appStatusModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2 id="modalTitle">App Status</h2>
                    <button class="close-modal" onclick="closeAppStatusModal()">√ó</button>
                </div>
                <div id="modalBody">
                    <div class="loading">Loading...</div>
                </div>
            </div>
        </div>
        
        <!-- User Jobs Audit Tab -->
        <div id="auditTab" class="main-tab-content" style="display: none;">
            <div class="data-table">
                <h2>üìã User Jobs Audit</h2>
                <p style="color: #666; margin-bottom: 20px;">View all jobs you've executed today and previously</p>
                
                <div style="display: flex; justify-content: flex-end; margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="loadUserJobsAudit()" style="padding: 10px 20px; display: flex; align-items: center; gap: 8px;">
                        üîÑ Refresh
                    </button>
                </div>
                
                <div style="overflow-x: auto;">
                    <table id="userJobsTable" style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                        <thead>
                            <tr style="background: #f8f9fa; border-bottom: 2px solid #e0e0e0;">
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">Job ID</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">Action</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">Customers</th>
                                <th style="padding: 12px; text-align: center; font-weight: 600; color: #333;">Status</th>
                                <th style="padding: 12px; text-align: left; font-weight: 600; color: #333;">Timestamp</th>
                            </tr>
                        </thead>
                        <tbody id="userJobsTableBody">
                            <tr>
                                <td colspan="5" style="padding: 20px; text-align: center; color: #999;">Loading jobs...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 15px; font-size: 0.85em; color: #666; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #01A982;">
                    <strong>ÔøΩ Copy Job ID:</strong> Click on the Job ID to copy it to your clipboard. Use the full UUID in your APIs or integrations.
                </div>
                
                <div style="margin-top: 10px; font-size: 0.85em; color: #666;">
                    <span id="jobsCount">No jobs found</span>
                </div>
            </div>
        </div>
        
        <!-- CNX Token Generation Tab -->
        <div id="tokenTab" class="main-tab-content" style="display: block;">
            <div class="data-source-panel">
                <h2>üîë CNX OAuth Token Generation</h2>
                <p style="color: #666; margin-bottom: 20px;">Generate OAuth2 access tokens using client credentials flow</p>
                
                <div class="form-grid">
                    <div class="form-group">
                        <label>OAuth Token Endpoint</label>
                        <input type="text" id="tokenEndpoint" placeholder="https://sso.common.cloud.hpe.com/as/token.oauth2" 
                               value="https://sso.common.cloud.hpe.com/as/token.oauth2">
                        <div class="hint-text">HPE SSO OAuth2 token endpoint</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Client ID <span style="color: #dc3545;">*</span></label>
                        <input type="text" id="clientId" placeholder="Enter your client ID">
                        <div class="hint-text">OAuth2 client identifier</div>
                    </div>
                    
                    <div class="form-group">
                        <label>Client Secret <span style="color: #dc3545;">*</span></label>
                        <input type="password" id="clientSecret" placeholder="Enter your client secret">
                        <div class="hint-text">‚ö†Ô∏è Secret will be cleared after generation</div>
                    </div>
                </div>
                
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn btn-primary" onclick="generateCNXToken()" id="generateTokenBtn">
                        üîë Generate Token
                    </button>
                    <button class="btn btn-secondary" onclick="clearTokenForm()">
                        Clear Form
                    </button>
                </div>
                
                <div id="tokenError" class="alert alert-error" style="display: none; margin-top: 20px;"></div>
                <div id="tokenSuccess" class="alert alert-success" style="display: none; margin-top: 20px;"></div>
            </div>
            
            <!-- Token Display Section -->
            <div id="tokenResultSection" style="display: none; margin-top: 30px; background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-left: 4px solid #01A982;">
                <h3 style="margin: 0 0 20px 0; color: #01A982; display: flex; align-items: center; gap: 10px;">
                    ‚úÖ Token Generated Successfully
                </h3>
                
                <div class="form-group">
                    <label style="display: flex; justify-content: space-between; align-items: center;">
                        <span>Access Token</span>
                        <button class="btn btn-secondary" onclick="copyToClipboard('accessToken', event)" style="padding: 5px 15px; font-size: 0.9em;">
                            üìã Copy Token
                        </button>
                    </label>
                    <textarea id="accessToken" readonly style="font-family: monospace; font-size: 0.85em; min-height: 120px; resize: vertical; background: #f8f9fa;"></textarea>
                </div>
                
                <div class="form-grid" style="margin-top: 20px;">
                    <div class="stat-card" style="text-align: center;">
                        <h4 style="margin: 0 0 10px 0; color: #666; font-size: 0.9em;">Token Type</h4>
                        <div id="tokenType" style="font-size: 1.2em; font-weight: bold; color: #01A982;">-</div>
                    </div>
                    
                    <div class="stat-card" style="text-align: center;">
                        <h4 style="margin: 0 0 10px 0; color: #666; font-size: 0.9em;">Expires In</h4>
                        <div id="expiresIn" style="font-size: 1.2em; font-weight: bold; color: #01A982;">-</div>
                    </div>
                    
                    <div class="stat-card" style="text-align: center;">
                        <h4 style="margin: 0 0 10px 0; color: #666; font-size: 0.9em;">Scope</h4>
                        <div id="tokenScope" style="font-size: 1.2em; font-weight: bold; color: #01A982;">-</div>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107; color: #856404;">
                    <strong>üîí Security Note:</strong> Store this token securely. It provides access to your resources. The client secret has been cleared from the form.
                </div>
            </div>
        </div>
        
    </div>
    
    <script>
        console.log('=== PAGE LOADED - JavaScript executing ===', new Date().toISOString());
        let allData = [];
        let currentMode = 'none'; // 'api' or 'paste' (demo mode removed)
        
        // ===== TOKEN MANAGEMENT =====
        let tokenAutoHideTimeout = null; // Store timeout ID for cleanup
        let lastTokenGeneratedAt = null; // Store generation timestamp
        
        // ===== USER SESSION MANAGEMENT =====
        async function loadCurrentUser() {
            try {
                const response = await fetch('/api/user/info');
                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('currentUser').textContent = data.user_id || 'Unknown';
                } else {
                    document.getElementById('currentUser').textContent = 'Guest';
                }
            } catch (error) {
                console.error('Error loading user info:', error);
                document.getElementById('currentUser').textContent = 'Error';
            }
        }
        
        async function handleLogout() {
            if (!confirm('Are you sure you want to logout?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                if (response.ok) {
                    window.location.href = '/login';
                } else {
                    alert('Logout failed. Please try again.');
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Error during logout. Please try again.');
            }
        }
        
        // ===== PROD CUSTOMER DATA FUNCTIONS =====
        function fetchProdCustomerData() {
            const cluster = document.getElementById('prodClusterSelect').value.trim();
            const apiUrl = document.getElementById('prodDataApiUrl').value.trim();
            const deviceType = document.getElementById('prodDeviceSelect').value.trim();
            const devicesPerBatch = document.getElementById('prodDevicePerBatch').value.trim();
            
            if (!cluster || !apiUrl || !deviceType) {
                showProdDataError('Please fill in cluster, source URL, and device selection.');
                return;
            }

            if (!devicesPerBatch || parseInt(devicesPerBatch, 10) <= 0) {
                showProdDataError('Please provide a valid Device Per Batch value.');
                return;
            }

            // Simulate API call to get customer count
            // In production, this would call your actual API endpoint
            const customerCount = Math.floor(Math.random() * 1000) + 100; // Mock data
            const perBatch = parseInt(devicesPerBatch, 10);
            const batchCount = Math.ceil(customerCount / perBatch);

            updateProdCustomerIdCount(customerCount);
            showProdDataSuccess(`Prepared ${batchCount} batch(es) for ${customerCount} customer(s).`);
            renderProdBatchList(batchCount);
        }
        
        function updateProdCustomerIdCount(count) {
            const countDisplay = document.getElementById('prodDataCustomerIdCount');
            countDisplay.textContent = count.toLocaleString();
            countDisplay.style.color = '#01A982';
        }
        
        function clearProdDataForm() {
            document.getElementById('prodDataApiUrl').value = '';
            document.getElementById('prodBearerToken').value = '';
            document.getElementById('prodClusterSelect').value = '';
            document.getElementById('prodDeviceSelect').value = '';
            document.getElementById('prodDevicePerBatch').value = '';
            document.getElementById('prodCsvUpload').value = '';
            document.getElementById('prodManualEntry').value = '';
            document.getElementById('prodCsvFileName').textContent = 'No file selected';
            document.getElementById('prodDataCustomerIdCount').textContent = '‚Äî';
            document.getElementById('prodDataSuccessMessage').style.display = 'none';
            document.getElementById('prodDataSuccessMessage').textContent = '';
            document.getElementById('prodStoredDataDisplay').textContent = '‚Äî';
            document.getElementById('prodDataResponse').style.display = 'none';
            document.getElementById('prodDataError').style.display = 'none';
            
            // Clear error messages and styling
            document.getElementById('prodDataApiUrlError').style.display = 'none';
            document.getElementById('prodBearerTokenError').style.display = 'none';
            document.getElementById('prodClusterSelectError').style.display = 'none';
            document.getElementById('prodDeviceSelectError').style.display = 'none';
            document.getElementById('prodDataApiUrl').classList.remove('prod-field-error');
            document.getElementById('prodBearerToken').classList.remove('prod-field-error');
            document.getElementById('prodClusterSelect').classList.remove('prod-field-error');
            document.getElementById('prodDeviceSelect').classList.remove('prod-field-error');
            
            renderProdBatchList(0);
        }
        
        function showProdDataSuccess(message) {
            const responseDiv = document.getElementById('prodDataResponse');
            responseDiv.textContent = message;
            responseDiv.style.display = 'block';
            document.getElementById('prodDataError').style.display = 'none';
        }
        
        function showProdDataError(message) {
            const errorDiv = document.getElementById('prodDataError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('prodDataResponse').style.display = 'none';
        }
        
        function handleProdCsvUpload(event) {
            const file = event.target.files[0];
            if (!file) {
                document.getElementById('prodCsvFileName').textContent = 'No file selected';
                return;
            }
            
            // Store file content for later use
            const reader = new FileReader();
            reader.onload = function(e) {
                window.prodCsvContent = e.target.result;
                document.getElementById('prodCsvFileName').textContent = `‚úì ${file.name}`;
                clearProdDataResults();
            };
            reader.readAsText(file);
        }

        function renderProdBatchList(batchCount) {
            const tbody = document.getElementById('prodBatchListBody');
            tbody.innerHTML = '';

            if (!batchCount || batchCount < 1) {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; color: #6b7280;">No batches generated yet</td></tr>';
                return;
            }

            for (let i = 1; i <= batchCount; i++) {
                const row = document.createElement('tr');
                const batchCell = document.createElement('td');
                batchCell.textContent = `Batch-${i}`;

                const selectCell = document.createElement('td');
                selectCell.style.textAlign = 'center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                selectCell.appendChild(checkbox);

                const assignCell = document.createElement('td');
                assignCell.style.textAlign = 'center';
                const assignBtn = document.createElement('button');
                assignBtn.textContent = 'Assign';
                assignCell.appendChild(assignBtn);

                row.appendChild(batchCell);
                row.appendChild(selectCell);
                row.appendChild(assignCell);
                tbody.appendChild(row);
            }
        }
        
        function showProdDataConfirmation() {
            // Clear all previous error messages
            document.getElementById('prodDataApiUrlError').style.display = 'none';
            document.getElementById('prodBearerTokenError').style.display = 'none';
            document.getElementById('prodClusterSelectError').style.display = 'none';
            document.getElementById('prodDeviceSelectError').style.display = 'none';
            
            const dataSourceUrl = document.getElementById('prodDataApiUrl').value.trim();
            const bearerToken = document.getElementById('prodBearerToken').value.trim();
            const cluster = document.getElementById('prodClusterSelect').value.trim();
            const device = document.getElementById('prodDeviceSelect').value.trim();
            const csvContent = window.prodCsvContent || '';
            const manualEntry = document.getElementById('prodManualEntry').value.trim();
            
            let hasError = false;
            
            // Validate cluster and device (always required)
            if (!cluster) {
                document.getElementById('prodClusterSelectError').textContent = 'Cluster is required';
                document.getElementById('prodClusterSelectError').style.display = 'block';
                document.getElementById('prodClusterSelect').classList.add('prod-field-error');
                hasError = true;
            } else {
                document.getElementById('prodClusterSelect').classList.remove('prod-field-error');
            }
            
            if (!device) {
                document.getElementById('prodDeviceSelectError').textContent = 'Device Selection is required';
                document.getElementById('prodDeviceSelectError').style.display = 'block';
                document.getElementById('prodDeviceSelect').classList.add('prod-field-error');
                hasError = true;
            } else {
                document.getElementById('prodDeviceSelect').classList.remove('prod-field-error');
            }
            
            // Check if at least one CID source is provided
            const hasApiSource = dataSourceUrl && bearerToken;
            const hasCsvSource = csvContent;
            const hasManualSource = manualEntry;
            
            if (!hasApiSource && !hasCsvSource && !hasManualSource) {
                // Show error for at least one source
                const errorMsg = 'Please provide Customer IDs via API, CSV upload, or manual entry.';
                showProdDataError(errorMsg);
                hasError = true;
            }
            
            // If API source is selected, validate URL and token
            if (hasApiSource) {
                if (!dataSourceUrl) {
                    document.getElementById('prodDataApiUrlError').textContent = 'Data Source URL is required for API source';
                    document.getElementById('prodDataApiUrlError').style.display = 'block';
                    document.getElementById('prodDataApiUrl').classList.add('prod-field-error');
                    hasError = true;
                } else {
                    document.getElementById('prodDataApiUrl').classList.remove('prod-field-error');
                }
                
                if (!bearerToken) {
                    document.getElementById('prodBearerTokenError').textContent = 'Bearer Token is required for API source';
                    document.getElementById('prodBearerTokenError').style.display = 'block';
                    document.getElementById('prodBearerToken').classList.add('prod-field-error');
                    hasError = true;
                } else {
                    document.getElementById('prodBearerToken').classList.remove('prod-field-error');
                }
            } else {
                // API source not selected, clear any errors
                document.getElementById('prodDataApiUrl').classList.remove('prod-field-error');
                document.getElementById('prodBearerToken').classList.remove('prod-field-error');
            }
            
            if (hasError) {
                return;
            }
            
            // Show modal with confirmed values
            let sourceDisplay = '';
            if (dataSourceUrl && bearerToken) {
                sourceDisplay = `API: ${dataSourceUrl}`;
                document.getElementById('prodConfirmDataSourceUrl').textContent = dataSourceUrl;
                document.getElementById('prodConfirmToken').textContent = bearerToken.substring(0, 20) + (bearerToken.length > 20 ? '...' : '');
                document.getElementById('prodConfirmToken').parentElement.style.display = 'block';
            } else if (csvContent) {
                sourceDisplay = 'CSV Upload';
                document.getElementById('prodConfirmDataSourceUrl').textContent = 'CSV Upload';
                document.getElementById('prodConfirmToken').parentElement.style.display = 'none';
            } else if (manualEntry) {
                sourceDisplay = 'Manual Entry';
                document.getElementById('prodConfirmDataSourceUrl').textContent = 'Manual Entry (text)';
                document.getElementById('prodConfirmToken').parentElement.style.display = 'none';
            }

            document.getElementById('prodConfirmCluster').textContent = cluster;
            document.getElementById('prodConfirmDevice').textContent = device;
            document.getElementById('prodConfirmationModal').style.display = 'flex';
        }
        
        function closeProdDataConfirmation() {
            document.getElementById('prodConfirmationModal').style.display = 'none';
        }
        
        function clearProdDataResults() {
            // Clear customer count and summary when any input field changes
            document.getElementById('prodDataCustomerIdCount').textContent = '‚Äî';
            document.getElementById('prodDataSuccessMessage').style.display = 'none';
            document.getElementById('prodDataSuccessMessage').textContent = '';
            document.getElementById('prodStoredDataDisplay').textContent = '‚Äî';
            document.getElementById('prodDataResponse').style.display = 'none';
            document.getElementById('prodDataError').style.display = 'none';
        }
        
        function confirmProdDataRun() {
            const dataSourceUrl = document.getElementById('prodDataApiUrl').value.trim();
            const bearerToken = document.getElementById('prodBearerToken').value.trim();
            const cluster = document.getElementById('prodClusterSelect').value.trim();
            const device = document.getElementById('prodDeviceSelect').value.trim();
            const clusterLabel = document.getElementById('prodClusterSelect').options[document.getElementById('prodClusterSelect').selectedIndex].text;
            const deviceLabel = document.getElementById('prodDeviceSelect').options[document.getElementById('prodDeviceSelect').selectedIndex].text;
            const csvContent = window.prodCsvContent || '';
            const manualEntry = document.getElementById('prodManualEntry').value.trim();
            
            closeProdDataConfirmation();
            
            // Determine which source to use (API > CSV > Manual)
            let customerIds = [];
            let dataSource = '';
            
            if (dataSourceUrl && bearerToken) {
                // API Source - Fetch from URL
                dataSource = 'API';
                console.log('[PROD-DATA] Using API source');
                
                fetch(dataSourceUrl, {
                    method: 'GET',
                    headers: { 
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${bearerToken}`
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`API returned ${response.status}: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(rawText => {
                    console.log('[PROD-DATA] Raw response received, length:', rawText.length);
                    
                    let totalDevices = 0;
                    
                    // Try to parse as JSON first
                    try {
                        const data = JSON.parse(rawText);
                        console.log('[PROD-DATA] Successfully parsed as JSON');
                        
                        if (Array.isArray(data)) {
                            customerIds = data;
                        } else if (data.customer_ids && Array.isArray(data.customer_ids)) {
                            customerIds = data.customer_ids;
                        } else if (data.customers && Array.isArray(data.customers)) {
                            customerIds = data.customers;
                        }
                        
                        if (data.total_devices && typeof data.total_devices === 'number') {
                            totalDevices = data.total_devices;
                        }
                    } catch (jsonError) {
                        console.log('[PROD-DATA] Response is not JSON, parsing as plain text');
                        
                        const lines = rawText.split(/\r?\n/)
                            .map(line => line.trim())
                            .filter(line => line.length > 0);
                        
                        customerIds = lines.filter(line => line.toLowerCase() !== 'cust_id');
                    }
                    
                    if (!Array.isArray(customerIds) || customerIds.length === 0) {
                        throw new Error('No customer IDs found in API response');
                    }
                    
                    if (!totalDevices || totalDevices <= 0) {
                        totalDevices = customerIds.length * 2;
                    }
                    
                    return saveProdCustomerDataToBackend(cluster, device, dataSourceUrl, customerIds, totalDevices, clusterLabel, deviceLabel);
                })
                .catch(error => {
                    showProdDataError(`Error: ${error.message}`);
                });
            } else if (csvContent) {
                // CSV Source
                dataSource = 'CSV';
                console.log('[PROD-DATA] Using CSV source');
                
                // Send CSV content to backend for parsing
                fetch('/api/prod-customer-data/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cluster: cluster,
                        device_type: device,
                        data_source_url: 'CSV Upload',
                        csv_content: csvContent
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    const fullString = `${clusterLabel} / ${deviceLabel} ‚Üí Total: ${result.total_customers.toLocaleString()} customers`;
                    document.getElementById('prodDataCustomerIdCount').textContent = fullString;
                    
                    const successMsg = `Successfully loaded ${result.total_customers.toLocaleString()} customers from CSV for ${clusterLabel} / ${deviceLabel}.`;
                    const successDiv = document.getElementById('prodDataSuccessMessage');
                    successDiv.textContent = successMsg;
                    successDiv.style.display = 'block';
                })
                .catch(error => {
                    showProdDataError(`Error: ${error.message}`);
                });
            } else if (manualEntry) {
                // Manual Entry Source
                dataSource = 'Manual Entry';
                console.log('[PROD-DATA] Using manual entry source');
                
                fetch('/api/prod-customer-data/run', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        cluster: cluster,
                        device_type: device,
                        data_source_url: 'Manual Entry',
                        manual_entry: manualEntry
                    })
                })
                .then(response => response.json())
                .then(result => {
                    if (result.error) {
                        throw new Error(result.error);
                    }
                    
                    const fullString = `${clusterLabel} / ${deviceLabel} ‚Üí Total: ${result.total_customers.toLocaleString()} customers`;
                    document.getElementById('prodDataCustomerIdCount').textContent = fullString;
                    
                    const successMsg = `Successfully loaded ${result.total_customers.toLocaleString()} customers from manual entry for ${clusterLabel} / ${deviceLabel}.`;
                    const successDiv = document.getElementById('prodDataSuccessMessage');
                    successDiv.textContent = successMsg;
                    successDiv.style.display = 'block';
                })
                .catch(error => {
                    showProdDataError(`Error: ${error.message}`);
                });
            } else {
                showProdDataError('Please provide Customer IDs via API, CSV, or manual entry.');
            }
        }
        
        function saveProdCustomerDataToBackend(cluster, device, dataSourceUrl, customerIds, totalDevices, clusterLabel, deviceLabel) {
            return fetch('/api/prod-customer-data/run', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    data_source_url: dataSourceUrl,
                    cluster: cluster,
                    device_type: device,
                    customer_ids: customerIds,
                    total_devices: totalDevices
                })
            }).then(response => response.json())
              .then(dbResult => {
                if (dbResult.error) {
                    throw new Error(dbResult.error);
                }
                
                const fullString = `${clusterLabel} / ${deviceLabel} ‚Üí Total: ${dbResult.total_customers.toLocaleString()} customers`;
                document.getElementById('prodDataCustomerIdCount').textContent = fullString;
                
                const successMsg = `Successfully fetched and saved ${dbResult.total_customers.toLocaleString()} customers for ${clusterLabel} / ${deviceLabel}.`;
                const successDiv = document.getElementById('prodDataSuccessMessage');
                successDiv.textContent = successMsg;
                successDiv.style.display = 'block';
              });
        }
        
        function checkProdStoredData() {
            // Get currently selected cluster and device
            const cluster = document.getElementById('prodClusterSelect').value.trim();
            const device = document.getElementById('prodDeviceSelect').value.trim();
            const clusterLabel = document.getElementById('prodClusterSelect').options[document.getElementById('prodClusterSelect').selectedIndex].text;
            const deviceLabel = document.getElementById('prodDeviceSelect').options[document.getElementById('prodDeviceSelect').selectedIndex].text;
            
            if (!cluster || !device) {
                document.getElementById('prodStoredDataDisplay').textContent = 'Please select Cluster and Device Selection';
                return;
            }
            
            // Call backend to fetch stored data metadata
            fetch(`/api/prod-customer-data/metadata?cluster=${encodeURIComponent(cluster)}&device_type=${encodeURIComponent(device)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.total_customers) {
                        let displayText = `${clusterLabel} / ${deviceLabel} ‚Üí Stored: ${data.total_customers.toLocaleString()} customers`;
                        if (data.updated_at) {
                            displayText += ` | Last updated: ${data.updated_at}`;
                        }
                        if (data.created_by) {
                            displayText += ` | By: ${data.created_by}`;
                        }
                        document.getElementById('prodStoredDataDisplay').textContent = displayText;
                    } else {
                        document.getElementById('prodStoredDataDisplay').textContent = `No stored data found for ${clusterLabel} / ${deviceLabel}.`;
                    }
                })
                .catch(error => {
                    console.log(`[PROD-DATA] Error checking stored data: ${error.message}`);
                    document.getElementById('prodStoredDataDisplay').textContent = `Error checking stored data: ${error.message}`;
                });
        }
        
        // ===== BATCH GENERATION FUNCTIONS =====
        
        function resetGenerateState() {
            // Clear all status and error messages
            clearBatchMessages();
            
            // Hide preview section
            hideBatchPreview();
            
            // Clear batch table (show "No batches generated yet")
            renderProdBatchList(0);
            
            // Hide batch count hint
            document.getElementById('batchCountHint').style.display = 'none';
        }
        
        function onBatchClusterDeviceChange() {
            const cluster = document.getElementById('batchClusterSelect').value.trim();
            const device = document.getElementById('batchDeviceSelect').value.trim();
            
            resetGenerateState();
            
            if (cluster && device) {
                // Check if stored customer data exists for this combo
                checkStoredDataForBatch(cluster, device);
            }
            
            updateGenerateButtonState();
        }
        
        function onTotalDevicesChange() {
            resetGenerateState();
            const totalDevices = document.getElementById('batchTotalDevices').value;
            
            if (totalDevices && parseInt(totalDevices) <= 0) {
                document.getElementById('batchErrorMessage').textContent = 'Total Devices must be a positive integer.';
                document.getElementById('batchErrorMessage').style.display = 'block';
            } else {
                document.getElementById('batchErrorMessage').style.display = 'none';
                // Recalculate preview if all inputs are available
                updateBatchPreview();
            }
            
            updateGenerateButtonState();
        }
        
        function onDevicePerBatchChange() {
            resetGenerateState();
            const devicePerBatch = document.getElementById('prodDevicePerBatch').value;
            
            if (devicePerBatch && parseInt(devicePerBatch) > 2000) {
                document.getElementById('prodDevicePerBatchWarning').textContent = '‚ö† Warning: Large batch sizes (>2000) may take longer to process.';
                document.getElementById('prodDevicePerBatchWarning').style.display = 'block';
            } else {
                document.getElementById('prodDevicePerBatchWarning').style.display = 'none';
            }
            
            // Recalculate preview if all inputs are available
            updateBatchPreview();
            updateGenerateButtonState();
        }
        
        function checkStoredDataForBatch(cluster, device) {
            fetch(`/api/prod-batch/check-stored?cluster=${encodeURIComponent(cluster)}&device_selection=${encodeURIComponent(device)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.found) {
                        // Store customer count for preview calculations
                        window.batchStoredCustomers = data.total_customers;
                        window.batchStoredCustomerIds = data.customer_ids;
                        updateBatchPreview();
                    } else {
                        showBatchError(data.message || 'No stored customer data found.');
                        window.batchStoredCustomers = null;
                        window.batchStoredCustomerIds = null;
                    }
                    updateGenerateButtonState();
                    
                    // Auto-load existing batches for this cluster/device
                    loadBatchListForClusterDevice(cluster, device);
                })
                .catch(error => {
                    showBatchError(`Error: ${error.message}`);
                    window.batchStoredCustomers = null;
                    window.batchStoredCustomerIds = null;
                    updateGenerateButtonState();
                    updateBatchCount();
                });
        }
        
        function updateBatchPreview() {
            const totalDevices = document.getElementById('batchTotalDevices').value;
            const deviceCap = document.getElementById('prodDevicePerBatch').value;
            const totalCustomers = window.batchStoredCustomers;
            
            if (!totalCustomers || !totalDevices || !deviceCap) {
                hideBatchPreview();
                return;
            }
            
            const totalDevicesInt = parseInt(totalDevices);
            const deviceCapInt = parseInt(deviceCap);
            
            if (totalDevicesInt <= 0 || deviceCapInt <= 0) {
                hideBatchPreview();
                return;
            }
            
            // Calculate batch parameters
            const avg = totalDevicesInt / totalCustomers;
            const customersPerBatch = Math.max(1, Math.floor(deviceCapInt / avg));
            const estimatedBatches = Math.ceil(totalCustomers / customersPerBatch);
            
            document.getElementById('previewTotalCustomers').textContent = totalCustomers.toLocaleString();
            document.getElementById('previewTotalDevices').textContent = totalDevicesInt.toLocaleString();
            document.getElementById('previewAvgDevices').textContent = avg.toFixed(2);
            document.getElementById('previewCustomersPerBatch').textContent = customersPerBatch.toLocaleString();
            document.getElementById('previewEstimatedBatches').textContent = estimatedBatches.toLocaleString();
            
            document.getElementById('batchPreviewSection').style.display = 'block';
        }
        
        function showBatchPreview(totalCustomers, totalDevices, deviceCap) {
            const section = document.getElementById('batchPreviewSection');
            
            if (!deviceCap || parseInt(deviceCap) <= 0) {
                hideBatchPreview();
                return;
            }
            
            // Calculate batch parameters
            const deviceCapInt = parseInt(deviceCap);
            const avg = totalDevices / totalCustomers;
            const customersPerBatch = Math.max(1, Math.floor(deviceCapInt / avg));
            const estimatedBatches = Math.ceil(totalCustomers / customersPerBatch);
            
            document.getElementById('previewTotalCustomers').textContent = totalCustomers.toLocaleString();
            document.getElementById('previewTotalDevices').textContent = totalDevices.toLocaleString();
            document.getElementById('previewAvgDevices').textContent = avg.toFixed(2);
            document.getElementById('previewCustomersPerBatch').textContent = customersPerBatch.toLocaleString();
            document.getElementById('previewEstimatedBatches').textContent = estimatedBatches.toLocaleString();
            
            section.style.display = 'block';
        }
        
        function hideBatchPreview() {
            document.getElementById('batchPreviewSection').style.display = 'none';
        }
        
        function updateGenerateButtonState() {
            const cluster = document.getElementById('batchClusterSelect').value.trim();
            const device = document.getElementById('batchDeviceSelect').value.trim();
            const devicePerBatch = document.getElementById('prodDevicePerBatch').value.trim();
            const totalDevices = document.getElementById('batchTotalDevices').value.trim();
            const button = document.getElementById('generateBatchBtn');
            const hasStoredData = window.batchStoredCustomers && window.batchStoredCustomers > 0;
            
            const isValid = cluster && device && devicePerBatch && parseInt(devicePerBatch) > 0 
                         && totalDevices && parseInt(totalDevices) > 0 && hasStoredData;
            const errorDiv = document.getElementById('batchErrorMessage');
            
            if (isValid && errorDiv.style.display === 'none') {
                // Only enable if there's no error message shown and stored data exists
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            } else {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            }
        }
        
        function clearBatchMessages() {
            document.getElementById('batchStatusMessage').style.display = 'none';
            document.getElementById('batchErrorMessage').style.display = 'none';
        }
        
        function showBatchStatus(message) {
            clearBatchMessages();
            const statusDiv = document.getElementById('batchStatusMessage');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            updateGenerateButtonState();
        }
        
        function showBatchError(message) {
            clearBatchMessages();
            const errorDiv = document.getElementById('batchErrorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            document.getElementById('generateBatchBtn').disabled = true;
            document.getElementById('generateBatchBtn').style.opacity = '0.5';
            document.getElementById('generateBatchBtn').style.cursor = 'not-allowed';
        }
        
        function generateBatches() {
            const cluster = document.getElementById('batchClusterSelect').value.trim();
            const device = document.getElementById('batchDeviceSelect').value.trim();
            const devicePerBatch = parseInt(document.getElementById('prodDevicePerBatch').value);
            const totalDevices = parseInt(document.getElementById('batchTotalDevices').value);
            
            if (!cluster || !device || !devicePerBatch || devicePerBatch <= 0) {
                showBatchError('Please fill in Cluster, Device Selection, and Device Per Batch.');
                return;
            }
            
            if (!totalDevices || totalDevices <= 0) {
                showBatchError('Please provide a valid Total Devices value.');
                return;
            }
            
            if (!window.batchStoredCustomerIds || window.batchStoredCustomerIds.length === 0) {
                showBatchError('No stored customer IDs found. Please run Prod Customer Data first.');
                return;
            }
            
            clearBatchMessages();
            document.getElementById('generateBatchBtn').disabled = true;
            document.getElementById('generateBatchBtn').textContent = 'Generating...';
            
            const customerIds = window.batchStoredCustomerIds;
            const totalCustomers = customerIds.length;
            
            // Generate batches with user-provided inputs and stored customer data
            fetch('/api/prod-batch/generate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    cluster: cluster,
                    device_selection: device,
                    device_cap: devicePerBatch,
                    total_customers: totalCustomers,
                    total_devices: totalDevices,
                    customer_ids: customerIds
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showBatchStatus(`‚úì Successfully generated ${result.total_batches} batch(es)! Customers per batch: ${result.customers_per_batch}`);
                        // Reload batch table
                        loadBatchList(cluster, device);
                    } else {
                        throw new Error(result.error || 'Generation failed.');
                    }
                })
                .catch(error => {
                    showBatchError(`Error: ${error.message}`);
                })
                .finally(() => {
                    document.getElementById('generateBatchBtn').disabled = false;
                    document.getElementById('generateBatchBtn').textContent = 'Generate';
                    updateGenerateButtonState();
                });
        }
        
        function loadBatchListForClusterDevice(cluster, device) {
            // Auto-load existing batches when cluster/device is selected
            fetch(`/api/prod-batch/list?cluster=${encodeURIComponent(cluster)}&device_selection=${encodeURIComponent(device)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.batches && data.batches.length > 0) {
                        renderBatchTable(data.batches);
                        document.getElementById('batchCountValue').textContent = data.batches.length;
                        document.getElementById('batchCountHint').style.display = 'block';
                    } else {
                        renderProdBatchList(0);
                        document.getElementById('batchCountHint').style.display = 'none';
                    }
                    updateBatchCount();
                })
                .catch(error => {
                    console.log(`Error loading batches: ${error.message}`);
                    renderProdBatchList(0);
                    document.getElementById('batchCountHint').style.display = 'none';
                    updateBatchCount();
                });
        }
        
        function loadBatchList(cluster, device) {
            fetch(`/api/prod-batch/list?cluster=${encodeURIComponent(cluster)}&device_selection=${encodeURIComponent(device)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.batches && data.batches.length > 0) {
                        renderBatchTable(data.batches);
                    }
                    updateBatchCount();
                })
                .catch(error => {
                    console.log(`Error loading batches: ${error.message}`);
                    updateBatchCount();
                });
        }
        
        function renderBatchTable(batches) {
            const tbody = document.getElementById('prodBatchListBody');
            tbody.innerHTML = '';
            
            batches.forEach(batch => {
                const row = document.createElement('tr');
                const statusBadge = getStatusBadge(batch.status);
                const assignedTo = batch.assigned_to || '‚Äî';
                row.innerHTML = `
                    <td style="font-family: monospace; word-break: break-all; max-width: 300px;">${batch.batch_id}</td>
                    <td style="text-align: center;">${statusBadge}</td>
                    <td style="text-align: center;">${assignedTo}</td>
                    <td style="text-align: center;">
                        <input type="checkbox" class="batch-select" data-batch-id="${batch.batch_id}" />
                    </td>
                    <td style="text-align: center;">
                        <button class="prod-table button" onclick="assignBatch('${batch.batch_id}')">Assign</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function getStatusBadge(status) {
            const statusColors = {
                'NEW': '#10b981',
                'ASSIGNED': '#3b82f6',
                'RUNNING': '#f59e0b',
                'DONE': '#6b7280'
            };
            const color = statusColors[status] || '#6b7280';
            return `<span style="background-color: ${color}; color: white; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500;">${status}</span>`;
        }
        
        function assignBatch(batchId) {
            console.log('Assign batch:', batchId);
            // TODO: Implement batch assignment logic
        }
        
        function renderProdBatchList(count) {
            const tbody = document.getElementById('prodBatchListBody');
            if (count === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: #6b7280;">No batches generated yet</td></tr>';
            }
        }
        
        // ===== DELETE BATCH FUNCTIONS =====
        
        function updateBatchCount() {
            const cluster = document.getElementById('batchClusterSelect').value.trim();
            const device = document.getElementById('batchDeviceSelect').value.trim();
            const deleteBtn = document.getElementById('deleteBatchBtn');
            const countHint = document.getElementById('batchCountHint');
            
            if (!cluster || !device) {
                deleteBtn.disabled = true;
                deleteBtn.style.opacity = '0.5';
                deleteBtn.style.cursor = 'not-allowed';
                countHint.style.display = 'none';
                return;
            }
            
            // Fetch batch count for this cluster/device
            fetch(`/api/prod-batch/list?cluster=${encodeURIComponent(cluster)}&device_selection=${encodeURIComponent(device)}`)
                .then(response => response.json())
                .then(data => {
                    const batchCount = data.batches ? data.batches.length : 0;
                    
                    if (batchCount > 0) {
                        deleteBtn.disabled = false;
                        deleteBtn.style.opacity = '1';
                        deleteBtn.style.cursor = 'pointer';
                        document.getElementById('batchCountValue').textContent = batchCount;
                        countHint.style.display = 'block';
                    } else {
                        deleteBtn.disabled = true;
                        deleteBtn.style.opacity = '0.5';
                        deleteBtn.style.cursor = 'not-allowed';
                        countHint.style.display = 'none';
                    }
                })
                .catch(error => {
                    console.log(`Error checking batch count: ${error.message}`);
                    deleteBtn.disabled = true;
                    deleteBtn.style.opacity = '0.5';
                    deleteBtn.style.cursor = 'not-allowed';
                    countHint.style.display = 'none';
                });
        }
        
        function showDeleteBatchConfirmation() {
            const cluster = document.getElementById('batchClusterSelect').value.trim();
            const device = document.getElementById('batchDeviceSelect').value.trim();
            const clusterLabel = document.getElementById('batchClusterSelect').options[document.getElementById('batchClusterSelect').selectedIndex].text;
            const deviceLabel = document.getElementById('batchDeviceSelect').options[document.getElementById('batchDeviceSelect').selectedIndex].text;
            
            if (!cluster || !device) {
                showBatchError('Please select Cluster and Device Selection first.');
                return;
            }
            
            // Show confirmation modal
            document.getElementById('deleteConfirmCluster').textContent = clusterLabel;
            document.getElementById('deleteConfirmDevice').textContent = deviceLabel;
            document.getElementById('deleteBatchModal').style.display = 'flex';
        }
        
        function closeDeleteBatchConfirmation() {
            document.getElementById('deleteBatchModal').style.display = 'none';
        }
        
        function confirmDeleteBatches() {
            const cluster = document.getElementById('batchClusterSelect').value.trim();
            const device = document.getElementById('batchDeviceSelect').value.trim();
            const clusterLabel = document.getElementById('batchClusterSelect').options[document.getElementById('batchClusterSelect').selectedIndex].text;
            const deviceLabel = document.getElementById('batchDeviceSelect').options[document.getElementById('batchDeviceSelect').selectedIndex].text;
            
            closeDeleteBatchConfirmation();
            clearBatchMessages();
            
            // Call backend to delete all batches for this cluster/device
            fetch('/api/prod-batch/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    cluster: cluster,
                    device_selection: device
                })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        showBatchStatus(`‚úì Deleted all batches for ${clusterLabel} / ${deviceLabel}.`);
                        // Clear batch table
                        renderProdBatchList(0);
                        // Update batch count hint
                        updateBatchCount();
                    } else {
                        throw new Error(result.error || 'Delete failed.');
                    }
                })
                .catch(error => {
                    showBatchError(`Error: ${error.message}`);
                });
        }
        
        // ===== BATCH ASSIGNMENT FUNCTIONS (Non-Admin Users) =====
        
        function onBatchAssignClusterDeviceChange() {
            const cluster = document.getElementById('batchAssignClusterSelect').value.trim();
            const device = document.getElementById('batchAssignDeviceSelect').value.trim();
            const loadBtn = document.getElementById('loadBatchesBtn');
            
            // Clear messages and table
            clearAssignMessages();
            renderAssignBatchList(0);
            
            if (cluster && device) {
                loadBtn.disabled = false;
            } else {
                loadBtn.disabled = true;
            }
        }
        
        function loadBatchesForAssignment() {
            const cluster = document.getElementById('batchAssignClusterSelect').value.trim();
            const device = document.getElementById('batchAssignDeviceSelect').value.trim();
            
            if (!cluster || !device) {
                showAssignError('Please select both cluster and device.');
                return;
            }
            
            fetch(`/api/prod-batch/list?cluster=${encodeURIComponent(cluster)}&device_selection=${encodeURIComponent(device)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.batches && data.batches.length > 0) {
                        renderAssignBatchTable(data.batches);
                    } else {
                        renderAssignBatchList(0);
                        showAssignStatus('No batches available for this cluster/device combination.');
                    }
                })
                .catch(error => {
                    showAssignError(`Error loading batches: ${error.message}`);
                    renderAssignBatchList(0);
                });
        }
        
        function renderAssignBatchTable(batches) {
            const tbody = document.getElementById('assignBatchListBody');
            tbody.innerHTML = '';
            
            batches.forEach(batch => {
                const row = document.createElement('tr');
                const statusBadge = getStatusBadge(batch.status);
                const assignedTo = batch.assigned_to || '‚Äî';
                const isAssigned = batch.assigned_to !== null;
                const customersCount = batch.customers_in_batch || batch.customer_ids.length || 0;
                
                // Disable checkbox if already assigned to someone else
                const checkboxDisabled = isAssigned;
                
                row.innerHTML = `
                    <td style="text-align: center;">
                        <input type="checkbox" class="batch-assign-select" data-batch-id="${batch.batch_id}" ${checkboxDisabled ? 'disabled' : ''} onchange="updateAssignSelectedButton()" />
                    </td>
                    <td style="font-family: monospace; word-break: break-all; max-width: 300px;">${batch.batch_id}</td>
                    <td style="text-align: center; font-weight: 600;">${customersCount}</td>
                    <td style="text-align: center;">${statusBadge}</td>
                    <td style="text-align: center;">${assignedTo}</td>
                    <td style="text-align: center;">
                        <a href="#" onclick="downloadBatchCustomersCSV('${batch.batch_id}'); return false;" style="color: #01A982; text-decoration: none; font-weight: 600; cursor: pointer;">CSV</a>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Reset select all checkbox
            document.getElementById('selectAllBatches').checked = false;
            updateAssignSelectedButton();
        }
        
        function renderAssignBatchList(count) {
            const tbody = document.getElementById('assignBatchListBody');
            if (count === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; color: #6b7280;">No batches available</td></tr>';
            }
        }
        
        function toggleSelectAllBatches() {
            const selectAll = document.getElementById('selectAllBatches').checked;
            const checkboxes = document.querySelectorAll('.batch-assign-select:not(:disabled)');
            checkboxes.forEach(cb => cb.checked = selectAll);
            updateAssignSelectedButton();
        }
        
        function updateAssignSelectedButton() {
            const selectedCount = document.querySelectorAll('.batch-assign-select:checked').length;
            const btn = document.getElementById('assignSelectedBtn');
            const badge = document.getElementById('selectedCountBadge');
            
            badge.textContent = selectedCount;
            
            if (selectedCount > 0) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            } else {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            }
        }
        
        function getSelectedBatchIds() {
            const checkboxes = document.querySelectorAll('.batch-assign-select:checked');
            return Array.from(checkboxes).map(cb => cb.dataset.batchId);
        }
        
        function showAssignSelectedConfirmation() {
            const selectedIds = getSelectedBatchIds();
            
            if (selectedIds.length === 0) {
                showAssignError('Please select at least one batch.');
                return;
            }
            
            document.getElementById('confirmSelectedCount').textContent = selectedIds.length;
            document.getElementById('assignSelectedModal').style.display = 'flex';
        }
        
        function closeAssignSelectedConfirmation() {
            document.getElementById('assignSelectedModal').style.display = 'none';
        }
        
        function confirmAssignSelected() {
            const selectedIds = getSelectedBatchIds();
            
            if (selectedIds.length === 0) {
                showAssignError('No batches selected.');
                return;
            }
            
            closeAssignSelectedConfirmation();
            
            fetch('/api/batches/assign-bulk', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ batch_ids: selectedIds })
            })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        const assigned = result.assigned || [];
                        const skipped = result.skipped || [];
                        
                        let message = `‚úì Assigned ${assigned.length} batch(es)`;
                        if (skipped.length > 0) {
                            message += ` (${skipped.length} already assigned)`;
                        }
                        
                        showAssignStatus(message);
                        
                        // Reload batches to reflect changes
                        setTimeout(() => {
                            loadBatchesForAssignment();
                        }, 500);
                    } else {
                        throw new Error(result.error || 'Assignment failed.');
                    }
                })
                .catch(error => {
                    showAssignError(`Error: ${error.message}`);
                });
        }
        
        function clearAssignMessages() {
            document.getElementById('assignStatusMessage').style.display = 'none';
            document.getElementById('assignErrorMessage').style.display = 'none';
        }
        
        function showAssignStatus(message) {
            clearAssignMessages();
            const statusDiv = document.getElementById('assignStatusMessage');
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            setTimeout(() => { statusDiv.style.display = 'none'; }, 5000);
        }
        
        function showAssignError(message) {
            clearAssignMessages();
            const errorDiv = document.getElementById('assignErrorMessage');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => { errorDiv.style.display = 'none'; }, 5000);
        }
        
        function downloadBatchCustomersCSV(batchId) {
            // Create a download link and trigger the download
            const downloadUrl = `/api/batches/${encodeURIComponent(batchId)}/customers.csv`;
            
            // Create a temporary anchor element to trigger download
            const link = document.createElement('a');
            link.href = downloadUrl;
            link.download = `${batchId}_customers.csv`;
            
            // Trigger download
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        var currentUsername = '';
        
        // ===== CLUSTER DROPDOWN POPULATION =====
        function populateClusterDropdowns() {
            /**
             * Fetch clusters from /api/clusters and populate all 3 dropdowns
             * with the same data from a single source
             */
            fetch('/api/clusters')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const clusters = data.data;
                        
                        // Populate all 3 cluster dropdowns
                        populateDropdown('prodClusterSelect', clusters);
                        populateDropdown('batchClusterSelect', clusters);
                        populateDropdown('batchAssignClusterSelect', clusters);
                        
                        console.log(`‚úì Populated 3 cluster dropdowns with ${clusters.length} clusters`);
                    } else {
                        console.error('Failed to fetch clusters:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching clusters:', error);
                    // Fallback: keep the default "Loading clusters..." option
                });
        }
        
        function populateDeviceDropdowns() {
            /**
             * Fetch devices from /api/devices and populate all 3 dropdowns
             * with the same data from a single source
             */
            fetch('/api/devices')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const devices = data.data;
                        
                        // Populate all 3 device dropdowns
                        populateDeviceDropdown('prodDeviceSelect', devices);
                        populateDeviceDropdown('batchDeviceSelect', devices);
                        populateDeviceDropdown('batchAssignDeviceSelect', devices);
                        
                        console.log(`‚úì Populated 3 device dropdowns with ${devices.length} devices`);
                    } else {
                        console.error('Failed to fetch devices:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error fetching devices:', error);
                    // Fallback: keep the default "Loading devices..." option
                });
        }
        
        function populateDropdown(elementId, clusters) {
            /**
             * Populate a dropdown with cluster options
             * @param {string} elementId - ID of the select element
             * @param {array} clusters - Array of cluster objects from API
             */
            const select = document.getElementById(elementId);
            if (!select) return;
            
            // Clear existing options except the first one (placeholder)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Update placeholder text
            select.options[0].text = 'Select Cluster';
            
            // Add cluster options
            clusters.forEach(cluster => {
                const option = document.createElement('option');
                option.value = cluster.code;
                option.text = cluster.name;
                option.title = cluster.description;
                select.appendChild(option);
            });
        }
        
        function populateDeviceDropdown(elementId, devices) {
            /**
             * Populate a dropdown with device options
             * @param {string} elementId - ID of the select element
             * @param {array} devices - Array of device objects from API
             */
            const select = document.getElementById(elementId);
            if (!select) return;
            
            // Clear existing options except the first one (placeholder)
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            // Update placeholder text
            select.options[0].text = 'Select Device';
            
            // Add device options
            devices.forEach(device => {
                const option = document.createElement('option');
                option.value = device.code;
                option.text = device.name;
                option.title = `${device.description} (Capacity: ${device.device_capacity})`;
                select.appendChild(option);
            });
        }
        
        function initializeCurrentUsername() {
            // Get username from the page or session
            // This is set when user logs in - you may need to pass this from server
            fetch('/api/user/role')
                .then(response => response.json())
                .then(data => {
                    currentUsername = data.user_id || '';
                })
                .catch(error => {
                    console.log('Error getting username:', error);
                });
        }
        
        // Initialize username on page load
        document.addEventListener('DOMContentLoaded', function() {
            initializeCurrentUsername();
            populateClusterDropdowns();
            populateDeviceDropdowns();
        });
        
        // ===== MAIN TAB SWITCHING =====
        function switchMainTab(tab) {
            // Clear Set Action notifications when switching away from Set tab
            if (tab !== 'set') {
                clearSetActionNotifications();
            }
            
            // Hide/show tabs
            document.getElementById('setTab').style.display = tab === 'set' ? 'block' : 'none';
            document.getElementById('statusTab').style.display = tab === 'status' ? 'block' : 'none';
            document.getElementById('tokenTab').style.display = tab === 'token' ? 'block' : 'none';
            document.getElementById('proddataTab').style.display = tab === 'proddata' ? 'block' : 'none';
            document.getElementById('auditTab').style.display = tab === 'audit' ? 'block' : 'none';
            
            // Ensure main view is active when switching tabs
            const mainView = document.getElementById('mainView');
            const stateView = document.getElementById('stateView');
            mainView.classList.add('active');
            stateView.classList.remove('active');
            
            // Update button styles using data-tab mapping
            const buttons = document.querySelectorAll('.main-tab-btn');
            buttons.forEach(btn => {
                if (btn.dataset.tab === tab) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            // Load user jobs audit table when Audit or Set Action tab is opened
            if (tab === 'audit' || tab === 'set') {
                loadUserJobsAudit().catch(err => console.error('[AUDIT_TABLE] Failed to load on tab switch:', err));
            }
        }
        
        
        // ===== SET ACTION FUNCTIONS =====
        async function executeSetAction() {
            const action = document.getElementById('actionSelect').value.trim();
            const token = document.getElementById('setActionToken').value.trim();
            const customerIdInput = document.getElementById('customerIds').value.trim();
            
            // Clear previous error highlighting
            document.getElementById('actionSelect').style.borderColor = '';
            document.getElementById('setActionToken').style.borderColor = '';
            document.getElementById('customerIds').style.borderColor = '';
            
            // Validation
            if (!action) {
                document.getElementById('actionSelect').style.borderColor = '#dc3545';
                showSetActionError('‚ùå Please select an action');
                return;
            }
            
            if (!token) {
                document.getElementById('setActionToken').style.borderColor = '#dc3545';
                showSetActionError('‚ùå Bearer token is mandatory. Please enter a valid token');
                return;
            }
            
            if (!customerIdInput) {
                document.getElementById('customerIds').style.borderColor = '#dc3545';
                showSetActionError('‚ùå Please enter at least one customer ID');
                return;
            }
            
            // Parse customer IDs (support both line breaks and comma-separated)
            const cids = customerIdInput
                .split(/[\n,]/)
                .map(id => id.trim())
                .filter(id => id.length > 0);
            
            if (cids.length === 0) {
                document.getElementById('customerIds').style.borderColor = '#dc3545';
                showSetActionError('‚ùå No valid customer IDs found. Check your input format');
                return;
            }
            
            // Show confirmation dialog
            showConfirmationDialog(action, cids, token);
        }
        
        function showConfirmationDialog(action, cids, token, batchSourceMessage = null) {
            // Store data in a temporary variable that the button can access
            window._pendingSetAction = { action, cids, token };
            
            // Build the confirmation details HTML
            let detailsHTML = `
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #666; font-size: 0.9em; font-weight: 600; margin-bottom: 5px;">Action</label>
                    <div style="font-size: 1.3em; color: #01A982; font-weight: bold;">${action}</div>
                </div>
                
                <div style="margin-bottom: 15px;">
                    <label style="display: block; color: #666; font-size: 0.9em; font-weight: 600; margin-bottom: 5px;">Number of Customers</label>
                    <div style="font-size: 1.3em; color: #01A982; font-weight: bold;">${cids.length}</div>
                </div>
            `;
            
            if (batchSourceMessage) {
                detailsHTML += `
                    <div style="margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #e0e0e0;">
                        <label style="display: block; color: #666; font-size: 0.9em; font-weight: 600; margin-bottom: 5px;">Source</label>
                        <div style="font-size: 0.95em; color: #556070;">${batchSourceMessage}</div>
                    </div>
                `;
            }
            
            detailsHTML += `
                <div style="margin-top: 15px; border-top: 1px solid #e0e0e0; padding-top: 15px;">
                    <label style="display: block; color: #666; font-size: 0.9em; font-weight: 600; margin-bottom: 8px;">Customer IDs</label>
                    <div style="background: white; padding: 10px; border-radius: 5px; max-height: 150px; overflow-y: auto; font-size: 0.85em; font-family: monospace; color: #333;">
                        ${cids.map(id => '<div style="padding: 3px 0; word-break: break-all;">' + id + '</div>').join('')}
                    </div>
                </div>
            `;
            
            // Create modal overlay
            const modalHTML = `
                <div id="confirmationModal" style="display: flex; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
                    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 500px; width: 90%;">
                        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 20px;">
                            <span style="font-size: 2em;">‚ö†Ô∏è</span>
                            <h2 style="margin: 0; color: #333;">Confirm Action</h2>
                        </div>
                        
                        <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; border-left: 4px solid #01A982; margin-bottom: 20px;">
                            ${detailsHTML}
                        </div>
                        
                        <div style="background: #fff3cd; padding: 15px; border-radius: 8px; border-left: 4px solid #ffc107; margin-bottom: 20px; color: #856404;">
                            <strong>‚ö° Note:</strong> This action will be applied to all listed customers.
                        </div>
                        
                        <div style="display: flex; gap: 10px; justify-content: flex-end;">
                            <button onclick="closeConfirmationDialog()" style="padding: 10px 20px; border: 2px solid #e0e0e0; background: white; border-radius: 8px; font-size: 1em; font-weight: 600; color: #333; cursor: pointer; transition: all 0.3s;">
                                ‚ùå Cancel
                            </button>
                            <button onclick="proceedWithSetAction()" style="padding: 10px 20px; border: none; background: #01A982; border-radius: 8px; font-size: 1em; font-weight: 600; color: white; cursor: pointer; transition: all 0.3s;">
                                ‚úÖ Yes, Proceed
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing modal
            const existingModal = document.getElementById('confirmationModal');
            if (existingModal) existingModal.remove();
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            
            // Focus the proceed button
            setTimeout(() => {
                const proceedBtn = document.querySelector('[onclick*="proceedWithSetAction"]');
                if (proceedBtn) proceedBtn.focus();
            }, 100);
        }
        
        function closeConfirmationDialog() {
            const modal = document.getElementById('confirmationModal');
            if (modal) modal.remove();
            // Clean up temporary storage
            delete window._pendingSetAction;
        }
        
        async function proceedWithSetAction() {
            // Retrieve the stored action data
            const pending = window._pendingSetAction;
            if (!pending) {
                console.error('No pending action data found');
                return;
            }
            
            const { action, token, cids } = pending;
            closeConfirmationDialog();
            
            const btn = document.querySelector('[onclick*="executeSetAction"]');
            
            try {
                // Show loading state
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = '‚è≥ Processing...';
                }
                
                // Prepare request body
                const requestBody = {
                    action: action,
                    cids: cids
                };
                
                // Read and validate API Base URL
                const apiBaseInput = document.getElementById('setActionApiBase');
                let apiBase = (apiBaseInput ? apiBaseInput.value.trim() : '') || localStorage.getItem('tmsApiBase') || 'https://cnx-apigw-evian3.arubadev.cloud.hpe.com';
                if (!apiBase) {
                    if (apiBaseInput) apiBaseInput.style.borderColor = '#dc3545';
                    showSetActionError('‚ùå API Base URL is required. Please provide a valid URL.');
                    if (btn) { btn.disabled = false; btn.textContent = 'üöÄ Set Action'; }
                    return;
                }
                // Persist for future sessions
                try { localStorage.setItem('tmsApiBase', apiBase); } catch(e) {}
                // Normalize base (remove trailing slashes)
                apiBase = apiBase.replace(/\/+$/, '');
                // Construct target URL
                const targetUrl = `${apiBase}/tms/v1/set/action`;
                
                // Call the set/action API via proxy with 30-second timeout
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 30000); // 30 seconds
                
                const response = await fetch('/proxy_fetch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        url: targetUrl,
                        token: token,
                        isPost: true,
                        postData: requestBody
                    }),
                    signal: controller.signal
                });
                
                clearTimeout(timeoutId);
                
                const result = await response.json();
                
                // Restore button state
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üöÄ Set Action';
                }
                
                // Handle proxy wrapper response
                // The proxy wraps the API response in { status: 'success', data: {...}, httpStatus: 200 }
                let actualResult = result;
                if (result.status === 'success' && result.data) {
                    actualResult = result.data;
                }
                
                // Always check the API's success field first (most authoritative)
                // If API says success: false, treat it as an error even if HTTP 200
                if (actualResult.success === false) {
                    handleSetActionError(actualResult, response.status);
                    return;
                }
                
                // Handle successful response
                if (actualResult.status === 'success' || actualResult.success === true) {
                    // NOTE: Job creation is handled by the backend in /proxy_fetch
                    // The backend creates the job and returns the job_id in the response wrapper
                    // So we just need to display the job_id from the response (no duplicate creation needed)
                    
                    // IMPORTANT: job_id is in the wrapper (result), not in actualResult (which is the inner data)
                    const jobId = result.job_id;
                    console.log('[SET_ACTION] Backend created job:', jobId);
                    
                    let jobIdDisplay = jobId ? `<strong>Job ID:</strong> ${jobId}<br>` : '';
                    showSetActionSuccess(`
                        <strong>‚úÖ Action Executed Successfully!</strong><br><br>
                        ${jobIdDisplay}
                        <strong>Action:</strong> ${action}<br>
                        <strong>Customer IDs Processed:</strong> ${cids.length}<br>
                        <strong>Timestamp:</strong> ${new Date().toLocaleTimeString()}<br><br>
                        <strong>Request Payload:</strong>
                        <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; margin-top: 10px;">
${JSON.stringify(requestBody, null, 2)}
                        </pre>
                    `);
                    return;
                }
                
                // Handle error responses (API returns success: false)
                handleSetActionError(result, response.status);
                
            } catch (error) {
                // Restore button state
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'üöÄ Set Action';
                }
                
                // Handle network and other errors
                if (error.name === 'TypeError' && error.message.includes('Failed to fetch')) {
                    showSetActionError(`
                        <strong>üåê Network Error</strong><br><br>
                        Unable to connect to the server. This could be due to:<br>
                        <ul style="margin: 10px 0; padding-left: 20px;">
                            <li>Internet connection issues</li>
                            <li>Server is down or unreachable</li>
                            <li>Firewall or proxy blocking the request</li>
                            <li>CORS policy restrictions</li>
                        </ul>
                        <strong>üí° What to do:</strong><br>
                        ‚Ä¢ Check your internet connection<br>
                        ‚Ä¢ Verify the server is running<br>
                        ‚Ä¢ Contact your system administrator
                    `);
                } else if (error.name === 'AbortError') {
                    showSetActionError(`
                        <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 5px solid #ffc107;">
                            <strong style="color: #856404; font-size: 1.1em;">‚è±Ô∏è Request Timeout (30 seconds)</strong><br><br>
                            <strong>Important:</strong> The request took longer than 30 seconds to complete. Your action <strong>may still have been processed successfully</strong> on the server, even though the client timed out.<br><br>
                            <strong>üí° What to do:</strong><br>
                            <ul style="margin: 10px 0; padding-left: 20px; color: #856404;">
                                <li>Go to the <a href="javascript:void(0);" onclick="document.getElementById('customerStatusTab').click(); return false;" style="color: #0066cc; text-decoration: underline; font-weight: 600;">Customer Status</a> tab to verify if your action was processed</li>
                                <li>Search for your customer IDs to check their current action status</li>
                                <li>If the action did not process, you can retry from the Set Action tab</li>
                            </ul>
                            <br>
                            <strong>This typically means:</strong><br>
                            <ul style="margin: 10px 0; padding-left: 20px; color: #856404;">
                                <li>The server is processing a large number of customers</li>
                                <li>Backend API is experiencing high load</li>
                                <li>Network latency is higher than usual</li>
                            </ul>
                        </div>
                    `);
                } else {
                    showSetActionError(`
                        <strong>‚ùå Unexpected Error</strong><br><br>
                        ${error.message}<br><br>
                        <strong>üí° What to do:</strong><br>
                        ‚Ä¢ Try refreshing the page<br>
                        ‚Ä¢ Check browser console for details (F12)<br>
                        ‚Ä¢ Contact support if issue persists
                    `);
                }
            }
        }
        
        function handleSetActionError(result, statusCode) {
            const message = result.message || 'Unknown error occurred';
            
            // Extract status code from message if available (format: "API returned status XXX: ...")
            const statusMatch = message.match(/status (\d+)/);
            const httpStatus = statusMatch ? parseInt(statusMatch[1]) : statusCode;
            
            let errorHTML = '';
            
            // Special handling for 408 timeout - action may have succeeded despite the timeout
            if (httpStatus === 408 || statusCode === 408) {
                errorHTML = `
                    <div style="background: #fff3cd; padding: 20px; border-radius: 8px; border-left: 5px solid #ffc107; margin-bottom: 15px;">
                        <strong style="color: #856404; font-size: 1.1em;">‚ö†Ô∏è Request Timeout (408)</strong><br><br>
                        <strong>Important:</strong> The request took longer than 30 seconds to complete. Your action <strong>may still have been processed successfully</strong> on the server, even though the client timed out.<br><br>
                        <strong>üí° What to do:</strong><br>
                        <ul style="margin: 10px 0; padding-left: 20px; color: #856404;">
                            <li>Go to the <a href="javascript:void(0);" onclick="document.getElementById('customerStatusTab').click(); return false;" style="color: #0066cc; text-decoration: underline; font-weight: 600;">Customer Status</a> tab to verify if your action was processed</li>
                            <li>Search for your customer IDs to check their current action status</li>
                            <li>If the action did not process, you can retry from the Set Action tab</li>
                        </ul>
                        <br>
                        <strong>Possible causes:</strong><br>
                        <ul style="margin: 10px 0; padding-left: 20px; color: #856404;">
                            <li>Server is processing a large number of customers (slow operation)</li>
                            <li>Backend API is experiencing high load</li>
                            <li>Network latency between client and server</li>
                        </ul>
                    </div>
                `;
                showSetActionError(errorHTML);
                return;
            }
            
            // Default error display with API response
            errorHTML = `
                <strong style="color: #d32f2f;">‚ùå API Error Response</strong><br><br>
                <strong style="color: #d32f2f;">HTTP Status:</strong> ${statusCode}<br>
                <strong style="color: #d32f2f;">Success:</strong> ${result.success === false ? '‚ùå Failed' : result.success === true ? '‚úÖ Success' : 'Unknown'}<br><br>
                
                <strong>Error Details:</strong>
                <div style="background: #ffebee; padding: 15px; border-radius: 8px; border-left: 4px solid #d32f2f; margin: 10px 0;">
                    <div style="font-weight: 600; color: #d32f2f; margin-bottom: 8px;">Message from API:</div>
                    <div style="background: white; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 0.9em; color: #333; word-break: break-word;">
                        ${message}
                    </div>
                </div>
                
                <strong>Full API Response:</strong>
                <details style="margin-top: 10px;">
                    <summary style="cursor: pointer; color: #01A982; font-weight: 600; padding: 8px 0;">Click to view complete response</summary>
                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; overflow-x: auto; margin-top: 10px; font-size: 0.85em; border: 1px solid #e0e0e0;">${JSON.stringify(result, null, 2)}</pre>
                </details>
            `;
            
            // Check for authorization-related errors in the message
            if (message.toLowerCase().includes('authorization') || message.toLowerCase().includes('cannot set')) {
                errorHTML += `
                    <br><strong>üí° This is an Authorization Error</strong><br>
                    <strong>Possible causes:</strong><br>
                    <ul style="margin: 10px 0; padding-left: 20px;">
                        <li>Bearer token doesn't have permission to perform this action</li>
                        <li>Token has expired or is invalid</li>
                        <li>User account lacks required permissions</li>
                        <li>Customer(s) cannot be set to this action due to their current state</li>
                        <li>Action is not allowed on these customer IDs</li>
                    </ul>
                    
                    <strong>üí° What to do:</strong><br>
                    ‚Ä¢ Verify the Bearer token is valid and not expired<br>
                    ‚Ä¢ Check if your account has permissions to perform this action<br>
                    ‚Ä¢ Verify customer IDs are valid and in the correct state<br>
                    ‚Ä¢ Contact your administrator if you need additional permissions<br>
                `;
            }
            
            showSetActionError(errorHTML);
        }
        
        function clearSetForm() {
            document.getElementById('actionSelect').value = '';
            document.getElementById('setActionToken').value = '';
            document.getElementById('customerIds').value = '';
            document.getElementById('setActionResponse').style.display = 'none';
            document.getElementById('setActionError').style.display = 'none';
            document.getElementById('csvFileName').textContent = '';
            document.getElementById('customerCount').textContent = '';
            document.getElementById('csvFileInput').value = '';
            // Clear border highlighting
            document.getElementById('customerIds').style.borderColor = '';
            document.getElementById('setActionToken').style.borderColor = '';
        }
        
        // ===== BATCH-BASED CUSTOMER ID LOADING (NON-ADMIN) =====
        
        // Check on page load whether to show batch section
        function initializeSetTabForNonAdmins() {
            fetch('/api/user/role')
                .then(response => response.json())
                .then(data => {
                    const isAdmin = data.is_admin;
                    const batchSection = document.getElementById('loadAssignedBatchesSection');
                    if (batchSection) {
                        batchSection.style.display = isAdmin ? 'none' : 'block';
                    }
                })
                .catch(error => {
                    console.log('[SET_TAB] Error checking user role:', error);
                });
        }
        
        // Call this when set tab is opened
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize on page load
            initializeSetTabForNonAdmins();
        });
        
        // Also initialize when switching to set tab
        const originalSwitchMainTab = window.switchMainTab;
        window.switchMainTab = function(tab) {
            originalSwitchMainTab(tab);
            if (tab === 'set') {
                initializeSetTabForNonAdmins();
            }
        };
        
        async function loadMyAssignedBatches() {
            const cluster = document.getElementById('setBatchClusterSelect').value.trim();
            const device = document.getElementById('setBatchDeviceSelect').value.trim();
            
            if (!cluster || !device) {
                showSetBatchError('‚ùå Please select both Cluster and Device');
                return;
            }
            
            // Show loading
            document.getElementById('setBatchLoadingMessage').style.display = 'block';
            document.getElementById('setBatchError').style.display = 'none';
            
            try {
                const response = await fetch(`/api/batches/assigned?cluster=${encodeURIComponent(cluster)}&device=${encodeURIComponent(device)}`);
                const data = await response.json();
                
                document.getElementById('setBatchLoadingMessage').style.display = 'none';
                
                if (!data.success || data.count === 0) {
                    showSetBatchError(`‚ÑπÔ∏è No assigned batches found for ${cluster}/${device}. Please assign batches in Prod Customer Data first.`);
                    document.getElementById('setBatchCheckboxContainer').innerHTML = '<div style="padding: 20px; text-align: center; color: #999; font-size: 0.9em;">No batches available</div>';
                    document.getElementById('selectAllBtn').style.display = 'none';
                    document.getElementById('clearAllBtn').style.display = 'none';
                    document.getElementById('setBatchSummary').style.display = 'none';
                    document.getElementById('setBatchDownloadLink').style.display = 'none';
                    return;
                }
                
                // Store batches globally for later use
                window._availableSetBatches = data.batches;
                
                // Populate checkboxes
                const container = document.getElementById('setBatchCheckboxContainer');
                container.innerHTML = '';
                
                data.batches.forEach((batch, index) => {
                    const checkboxId = `setBatchCheckbox_${index}`;
                    const checkboxLabel = document.createElement('label');
                    checkboxLabel.style.cssText = 'display: flex; align-items: center; padding: 8px 4px; cursor: pointer; font-size: 0.9em;';
                    // Get customer count from API response (customer_count field)
                    const customerCount = batch.customer_count !== undefined ? batch.customer_count : (batch.customers_in_batch || 0);
                    checkboxLabel.innerHTML = `
                        <input type="checkbox" id="${checkboxId}" class="set-batch-checkbox" data-batch-id="${batch.batch_id}" data-batch-index="${index}" onchange="updateSetBatchSelection()" style="margin-right: 8px; cursor: pointer;" />
                        <span style="word-break: break-all; white-space: normal; flex: 1;">${batch.batch_id} (${customerCount} customers)</span>
                    `;
                    container.appendChild(checkboxLabel);
                });
                
                document.getElementById('selectAllBtn').style.display = 'inline-block';
                document.getElementById('clearAllBtn').style.display = 'inline-block';
                document.getElementById('setBatchError').style.display = 'none';
                updateSetBatchSelection();
            } catch (error) {
                showSetBatchError(`‚ùå Error loading batches: ${error.message}`);
                document.getElementById('setBatchCheckboxContainer').innerHTML = '<div style="padding: 20px; text-align: center; color: #999; font-size: 0.9em;">Error loading</div>';
                document.getElementById('selectAllBtn').style.display = 'none';
                document.getElementById('clearAllBtn').style.display = 'none';
            }
        }
        
        function updateSetBatchSelection() {
            const checkboxes = document.querySelectorAll('.set-batch-checkbox:checked');
            const selectedIndices = Array.from(checkboxes).map(cb => parseInt(cb.dataset.batchIndex));
            
            // Collect all customer IDs from selected batches (with deduplication)
            const allCustomerIds = new Set();
            const selectedBatchIds = [];
            
            selectedIndices.forEach(index => {
                const batch = window._availableSetBatches[index];
                if (batch) {
                    selectedBatchIds.push(batch.batch_id);
                    // Fetch customer IDs for this batch
                    fetch(`/api/batches/${encodeURIComponent(batch.batch_id)}/customers`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success && data.customer_ids) {
                                data.customer_ids.forEach(id => allCustomerIds.add(id));
                            }
                        })
                        .catch(err => console.log('[BATCH_SELECTION] Error fetching customers:', err));
                }
            });
            
            // Store selected batch IDs and aggregate customer IDs for later use
            window._selectedSetBatchIds = selectedBatchIds;
            
            // Update summary
            const summaryDiv = document.getElementById('setBatchSummary');
            const selectedCount = checkboxes.length;
            
            if (selectedCount === 0) {
                summaryDiv.style.display = 'none';
                document.getElementById('setBatchDownloadLink').style.display = 'none';
            } else {
                summaryDiv.style.display = 'block';
                document.getElementById('setBatchSelectedCount').textContent = selectedCount;
                
                // Calculate total customers with deduplication
                let totalCustomers = 0;
                const uniqueCustomerIds = new Set();
                
                selectedIndices.forEach(index => {
                    const batch = window._availableSetBatches[index];
                    if (batch) {
                        // This is a synchronous approach - we'll improve with Promise.all
                        fetch(`/api/batches/${encodeURIComponent(batch.batch_id)}/customers`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success && data.customer_ids) {
                                    data.customer_ids.forEach(id => uniqueCustomerIds.add(id));
                                    document.getElementById('setBatchTotalCustomers').textContent = uniqueCustomerIds.size;
                                }
                            })
                            .catch(err => console.log('[BATCH_SELECTION] Error:', err));
                    }
                });
                
                document.getElementById('setBatchDownloadLink').style.display = 'inline';
            }
        }
        
        function selectAllSetBatches() {
            document.querySelectorAll('.set-batch-checkbox').forEach(cb => cb.checked = true);
            updateSetBatchSelection();
        }
        
        function clearAllSetBatches() {
            document.querySelectorAll('.set-batch-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('setBatchSummary').style.display = 'none';
            document.getElementById('setBatchDownloadLink').style.display = 'none';
            window._selectedSetBatchIds = [];
        }

        
        function showSetBatchError(message) {
            const errorDiv = document.getElementById('setBatchError');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        async function downloadSetBatchCustomersCSV() {
            const selectedBatchIds = window._selectedSetBatchIds || [];
            
            if (selectedBatchIds.length === 0) {
                showSetBatchError('‚ùå Please select at least one batch');
                return;
            }
            
            if (selectedBatchIds.length === 1) {
                // Single batch - download directly
                const downloadUrl = `/api/batches/${encodeURIComponent(selectedBatchIds[0])}/customers.csv`;
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `${selectedBatchIds[0]}_customers.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                // Multiple batches - aggregate and download
                const allCustomerIds = new Set();
                
                for (const batchId of selectedBatchIds) {
                    try {
                        const response = await fetch(`/api/batches/${encodeURIComponent(batchId)}/customers`);
                        const data = await response.json();
                        if (data.success && data.customer_ids) {
                            data.customer_ids.forEach(id => allCustomerIds.add(id));
                        }
                    } catch (error) {
                        console.log('[DOWNLOAD] Error fetching batch:', error);
                    }
                }
                
                // Create CSV content
                let csvContent = 'cust_id\n';
                allCustomerIds.forEach(id => {
                    csvContent += id + '\n';
                });
                
                // Download aggregated CSV
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.href = url;
                link.download = `assigned_batches_customers.csv`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }
        }
        
        // Override executeSetAction to use batch customer IDs if batch is selected
        const originalExecuteSetAction = window.executeSetAction;
        window.executeSetAction = async function() {
            const selectedBatchIds = window._selectedSetBatchIds || [];
            const manualCustomerInput = document.getElementById('customerIds').value.trim();
            
            // Determine which customers to use
            let customerIds = [];
            let batchSource = null;
            
            // Priority 1: Use batch customers if any batches are selected
            if (selectedBatchIds.length > 0) {
                const allCustomerIds = new Set();
                
                for (const batchId of selectedBatchIds) {
                    try {
                        const response = await fetch(`/api/batches/${encodeURIComponent(batchId)}/customers`);
                        const data = await response.json();
                        if (data.success && data.customer_ids) {
                            data.customer_ids.forEach(id => allCustomerIds.add(id));
                        }
                    } catch (error) {
                        console.log('[SET_ACTION] Error fetching batch:', error);
                    }
                }
                
                customerIds = Array.from(allCustomerIds);
                batchSource = `${selectedBatchIds.length} batch(es)`;
            } 
            // Priority 2: Use manual entry if no batches selected
            else if (manualCustomerInput) {
                // Parse customer IDs (support both line breaks and comma-separated)
                customerIds = manualCustomerInput
                    .split(/[\n,]/)
                    .map(id => id.trim())
                    .filter(id => id.length > 0);
                batchSource = 'manual entry';
            }
            
            // Validation
            const action = document.getElementById('actionSelect').value.trim();
            const token = document.getElementById('setActionToken').value.trim();
            
            // Clear previous error highlighting
            document.getElementById('actionSelect').style.borderColor = '';
            document.getElementById('setActionToken').style.borderColor = '';
            document.getElementById('customerIds').style.borderColor = '';
            
            if (!action) {
                document.getElementById('actionSelect').style.borderColor = '#dc3545';
                showSetActionError('‚ùå Please select an action');
                return;
            }
            
            if (!token) {
                document.getElementById('setActionToken').style.borderColor = '#dc3545';
                showSetActionError('‚ùå Bearer token is mandatory. Please enter a valid token');
                return;
            }
            
            if (customerIds.length === 0) {
                if (selectedBatchIds.length === 0) {
                    document.getElementById('customerIds').style.borderColor = '#dc3545';
                }
                showSetActionError('‚ùå Please select at least one batch or provide customer IDs');
                return;
            }
            
            // Show confirmation dialog with batch information
            const confirmationMessage = batchSource ? 
                `You are about to run <strong>${action}</strong> on:<br>Source: ${batchSource}<br>Customers: ${customerIds.length}` :
                null;
            
            showConfirmationDialog(action, customerIds, token, confirmationMessage);
        };
        
        // ===== CSV UPLOAD FUNCTIONS =====
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            
            if (!file) {
                return;
            }
            
            // Validate file type
            if (!file.name.toLowerCase().endsWith('.csv')) {
                showSetActionError('‚ùå Please upload a valid CSV file');
                event.target.value = '';
                return;
            }
            
            // Update filename display
            document.getElementById('csvFileName').textContent = `üìÑ ${file.name}`;
            
            // Read and parse CSV file
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const customerIds = parseCSV(content);
                    
                    if (customerIds.length === 0) {
                        showSetActionError('‚ùå No valid customer IDs found in CSV file');
                        return;
                    }
                    
                    // Populate textarea with customer IDs (one per line)
                    const textarea = document.getElementById('customerIds');
                    textarea.value = customerIds.join('\n');
                    
                    // Update customer count
                    updateCustomerCount(customerIds.length);
                    
                    // Show success message
                    showSetActionSuccess(`‚úÖ Successfully loaded ${customerIds.length} customer ID(s) from CSV`);
                    
                    // Clear border highlighting
                    textarea.style.borderColor = '#01A982';
                    setTimeout(() => {
                        textarea.style.borderColor = '';
                    }, 2000);
                    
                } catch (error) {
                    console.error('CSV parsing error:', error);
                    showSetActionError('‚ùå Error parsing CSV file: ' + error.message);
                }
            };
            
            reader.onerror = function() {
                showSetActionError('‚ùå Error reading CSV file');
                document.getElementById('csvFileName').textContent = '';
            };
            
            reader.readAsText(file);
        }
        
        function parseCSV(content) {
            const customerIds = new Set(); // Use Set to avoid duplicates
            
            // Split by lines
            const lines = content.split(/\r?\n/);
            
            for (let line of lines) {
                // Skip empty lines
                if (!line.trim()) continue;
                
                // Split by comma, semicolon, tab, or pipe
                const values = line.split(/[,;\t|]/).map(v => v.trim());
                
                for (let value of values) {
                    // Remove quotes if present
                    value = value.replace(/^["']|["']$/g, '').trim();
                    
                    // Skip empty values and common header names
                    if (!value || 
                        value.toLowerCase() === 'customer_id' ||
                        value.toLowerCase() === 'customerid' ||
                        value.toLowerCase() === 'id' ||
                        value.toLowerCase() === 'cid' ||
                        value.toLowerCase() === 'customer') {
                        continue;
                    }
                    
                    // Validate customer ID format (basic validation)
                    // Assuming customer IDs are alphanumeric with possible hyphens/underscores
                    if (value.length >= 8 && /^[a-zA-Z0-9_-]+$/.test(value)) {
                        customerIds.add(value);
                    }
                }
            }
            
            return Array.from(customerIds);
        }
        
        function clearCustomerIds() {
            document.getElementById('customerIds').value = '';
            document.getElementById('csvFileName').textContent = '';
            document.getElementById('customerCount').textContent = '';
            document.getElementById('csvFileInput').value = '';
            document.getElementById('customerIds').style.borderColor = '';
        }
        
        // ===== ROLE-BASED ACCESS CONTROL =====
        
        var isAdminUser = false;
        
        function initializeRoleBasedAccess() {
            // Check if user is admin by attempting to access admin-only endpoint
            fetch('/api/user/role')
                .then(response => response.json())
                .then(data => {
                    isAdminUser = data.is_admin || false;
                    updateProdDataUIBasedOnRole();
                })
                .catch(error => {
                    console.log('Error checking user role:', error);
                    isAdminUser = false;
                    updateProdDataUIBasedOnRole();
                });
        }
        
        function updateProdDataUIBasedOnRole() {
            const adminSection = document.getElementById('prodCustomerDataSection');
            const generateSection = document.getElementById('generateBatchSection');
            const nonAdminSection = document.getElementById('batchAssignmentSection');
            
            if (isAdminUser) {
                // Admin: show everything
                if (adminSection) adminSection.style.display = 'block';
                if (generateSection) generateSection.style.display = 'block';
                if (nonAdminSection) nonAdminSection.style.display = 'none';
            } else {
                // Non-admin: show only assignment section
                if (adminSection) adminSection.style.display = 'none';
                if (generateSection) generateSection.style.display = 'none';
                if (nonAdminSection) nonAdminSection.style.display = 'block';
            }
        }
        
        function updateCustomerCount(count) {
            const countElement = document.getElementById('customerCount');
            if (count > 0) {
                countElement.textContent = `(${count} customer${count !== 1 ? 's' : ''} loaded)`;
            } else {
                countElement.textContent = '';
            }
        }
        
        // Global timeout tracker for Set Action notifications
        let setActionTimeoutId = null;
        
        function showSetActionSuccess(message) {
            console.log('[SET_ACTION] ===== SHOW SUCCESS CALLED =====');
            console.log('[SET_ACTION] Showing success message, will auto-clear in 30 seconds');
            
            const responseDiv = document.getElementById('setActionResponse');
            const titleDiv = document.getElementById('responseTitle');
            const contentDiv = document.getElementById('responseContent');
            
            if (!responseDiv || !titleDiv || !contentDiv) {
                console.error('[SET_ACTION] ‚úó CRITICAL ERROR: Missing HTML elements!');
                console.error('[SET_ACTION] responseDiv:', !!responseDiv);
                console.error('[SET_ACTION] titleDiv:', !!titleDiv);
                console.error('[SET_ACTION] contentDiv:', !!contentDiv);
                return;
            }
            
            titleDiv.textContent = '‚úÖ Success';
            titleDiv.style.color = '#01A982';
            contentDiv.innerHTML = message;
            responseDiv.style.borderColor = '#01A982';
            responseDiv.style.background = '#e8f6f1';
            responseDiv.style.display = 'block';
            console.log('[SET_ACTION] ‚úì Success message displayed');
            
            // Hide error if visible
            document.getElementById('setActionError').style.display = 'none';
            
            // Clear previous timeout if exists
            if (setActionTimeoutId) {
                console.log('[SET_ACTION] ‚úì Cancelling previous timeout:', setActionTimeoutId);
                clearTimeout(setActionTimeoutId);
            }
            
            // Auto-clear notification and token after 30 seconds
            console.log('[SET_ACTION] Setting new timeout for 30 seconds (30000ms)...');
            const TIMEOUT_DURATION = 30000;
            console.log('[SET_ACTION] TIMEOUT_DURATION constant =', TIMEOUT_DURATION, 'ms');
            setActionTimeoutId = setTimeout(() => {
                console.log('[SET_ACTION] ===== TIMEOUT CALLBACK FIRED! =====');
                console.log('[SET_ACTION] 30-second timeout triggered, clearing notifications');
                clearSetActionNotifications();
            }, TIMEOUT_DURATION);
            
            // Load user jobs audit table to show newly created job
            console.log('[SET_ACTION] Loading user jobs audit table...');
            loadUserJobsAudit().catch(err => console.error('[SET_ACTION] Failed to load audit table:', err));
            
            console.log('[SET_ACTION] ‚úì Timeout set with ID:', setActionTimeoutId);
            console.log('[SET_ACTION] ===== SHOW SUCCESS COMPLETE =====\n');
        }
        
        // Add event listener to update count on manual input
        document.addEventListener('DOMContentLoaded', function() {
            const customerIdsTextarea = document.getElementById('customerIds');
            if (customerIdsTextarea) {
                customerIdsTextarea.addEventListener('input', function() {
                    const value = this.value.trim();
                    if (value) {
                        const ids = value.split(/[\n,]/).map(id => id.trim()).filter(id => id.length > 0);
                        updateCustomerCount(ids.length);
                    } else {
                        updateCustomerCount(0);
                    }
                });
            }
        });

        // Initialize and persist API Base URL input
        document.addEventListener('DOMContentLoaded', function() {
            const apiBaseInput = document.getElementById('setActionApiBase');
            if (apiBaseInput) {
                try {
                    const saved = localStorage.getItem('tmsApiBase');
                    apiBaseInput.value = saved || 'https://cnx-apigw-evian3.arubadev.cloud.hpe.com';
                } catch (e) {
                    apiBaseInput.value = 'https://cnx-apigw-evian3.arubadev.cloud.hpe.com';
                }
                apiBaseInput.addEventListener('change', function() {
                    try { localStorage.setItem('tmsApiBase', this.value.trim()); } catch(e) {}
                    apiBaseInput.style.borderColor = '';
                });
            }
        });
        
        // Initialize role-based access control
        document.addEventListener('DOMContentLoaded', function() {
            initializeRoleBasedAccess();
        });
        
        // ===== CNX TOKEN GENERATION FUNCTIONS =====
        async function generateCNXToken() {
            const endpoint = document.getElementById('tokenEndpoint').value.trim();
            const clientId = document.getElementById('clientId').value.trim();
            const clientSecret = document.getElementById('clientSecret').value.trim();
            
            // Clear previous validation highlighting
            document.getElementById('tokenEndpoint').style.borderColor = '';
            document.getElementById('clientId').style.borderColor = '';
            document.getElementById('clientSecret').style.borderColor = '';
            
            // Hide previous messages
            document.getElementById('tokenError').style.display = 'none';
            document.getElementById('tokenSuccess').style.display = 'none';
            document.getElementById('tokenResultSection').style.display = 'none';
            
            // Validation
            if (!endpoint) {
                document.getElementById('tokenEndpoint').style.borderColor = '#dc3545';
                showTokenError('‚ùå Please enter the OAuth token endpoint');
                return;
            }
            
            if (!clientId) {
                document.getElementById('clientId').style.borderColor = '#dc3545';
                showTokenError('‚ùå Client ID is required');
                return;
            }
            
            if (!clientSecret) {
                document.getElementById('clientSecret').style.borderColor = '#dc3545';
                showTokenError('‚ùå Client Secret is required');
                return;
            }
            
            // Show loading state
            const generateBtn = document.getElementById('generateTokenBtn');
            const originalBtnText = generateBtn.textContent;
            generateBtn.textContent = 'üîÑ Generating...';
            generateBtn.disabled = true;
            
            try {
                // Prepare form-urlencoded body
                const formBody = new URLSearchParams({
                    grant_type: 'client_credentials',
                    client_id: clientId,
                    client_secret: clientSecret
                }).toString();
                
                // Call proxy endpoint
                const response = await fetch('/proxy_fetch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: endpoint,
                        isPost: true,
                        postData: formBody,
                        contentType: 'application/x-www-form-urlencoded'
                    })
                });
                
                // Check if response is JSON
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`Server returned non-JSON response: ${text.substring(0, 100)}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success' && result.data) {
                    // Parse the token response
                    const tokenData = typeof result.data === 'string' ? JSON.parse(result.data) : result.data;
                    
                    if (tokenData.access_token) {
                        displayTokenResult(tokenData);
                        showTokenSuccess('‚úÖ Token generated successfully!');
                        
                        // Clear the client secret for security
                        document.getElementById('clientSecret').value = '';
                    } else {
                        handleTokenError(result, result.httpStatus);
                    }
                } else {
                    handleTokenError(result, result.httpStatus);
                }
            } catch (error) {
                console.error('Token generation error:', error);
                
                // Check for network errors
                if (error instanceof TypeError && error.message.includes('fetch')) {
                    showTokenError(`
                        <strong>üåê Network Error</strong><br><br>
                        Unable to connect to the server.<br><br>
                        <strong>üí° What to do:</strong><br>
                        ‚Ä¢ Check your internet connection<br>
                        ‚Ä¢ Verify the OAuth endpoint URL<br>
                        ‚Ä¢ Check if you're behind a proxy/firewall<br>
                        ‚Ä¢ Try again in a few moments
                    `);
                } else {
                    showTokenError(`‚ùå An unexpected error occurred: ${error.message}`);
                }
            } finally {
                // Restore button state
                generateBtn.textContent = originalBtnText;
                generateBtn.disabled = false;
            }
        }
        
        function handleTokenError(result, statusCode) {
            let errorMessage = result.message || result.error || 'Token generation failed';
            let errorHTML = '';
            
            // Use the same comprehensive error handling as setAction
            if (statusCode) {
                const httpStatus = parseInt(statusCode);
                
                // 4xx errors
                if (httpStatus >= 400 && httpStatus < 500) {
                    switch (httpStatus) {
                        case 400:
                            errorHTML = `
                                <strong>‚ùå 400 - Bad Request</strong><br><br>
                                The OAuth server couldn't process your request.<br><br>
                                <strong>Common causes:</strong><br>
                                <ul style="margin: 10px 0; padding-left: 20px;">
                                    <li>Invalid client credentials</li>
                                    <li>Incorrect grant type</li>
                                    <li>Malformed request parameters</li>
                                </ul>
                                <strong>üí° What to do:</strong><br>
                                ‚Ä¢ Verify your client ID and secret<br>
                                ‚Ä¢ Check the OAuth endpoint URL<br>
                                ‚Ä¢ Ensure credentials are active<br><br>
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #01A982; font-weight: 600;">View Error Details</summary>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto; font-size: 0.85em;">${errorMessage}</pre>
                                </details>
                            `;
                            break;
                        
                        case 401:
                            errorHTML = `
                                <strong>üîí 401 - Unauthorized</strong><br><br>
                                Authentication failed. Your client credentials are invalid.<br><br>
                                <strong>üí° What to do:</strong><br>
                                ‚Ä¢ Double-check your Client ID<br>
                                ‚Ä¢ Verify your Client Secret is correct<br>
                                ‚Ä¢ Ensure credentials haven't expired<br>
                                ‚Ä¢ Check if credentials are for the correct environment<br><br>
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #01A982; font-weight: 600;">View Error Details</summary>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto; font-size: 0.85em;">${errorMessage}</pre>
                                </details>
                            `;
                            break;
                        
                        case 403:
                            errorHTML = `
                                <strong>‚õî 403 - Forbidden</strong><br><br>
                                You don't have permission to generate tokens.<br><br>
                                <strong>üí° What to do:</strong><br>
                                ‚Ä¢ Verify your client has the required scopes<br>
                                ‚Ä¢ Contact your administrator for access<br>
                                ‚Ä¢ Check if your client is enabled<br><br>
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #01A982; font-weight: 600;">View Error Details</summary>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto; font-size: 0.85em;">${errorMessage}</pre>
                                </details>
                            `;
                            break;
                        
                        case 429:
                            errorHTML = `
                                <strong>üö¶ 429 - Too Many Requests</strong><br><br>
                                Rate limit exceeded.<br><br>
                                <strong>üí° What to do:</strong><br>
                                ‚Ä¢ Wait a few minutes before trying again<br>
                                ‚Ä¢ Reduce the frequency of token requests<br>
                                ‚Ä¢ Consider implementing token caching<br><br>
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #01A982; font-weight: 600;">View Error Details</summary>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto; font-size: 0.85em;">${errorMessage}</pre>
                                </details>
                            `;
                            break;
                        
                        default:
                            errorHTML = `
                                <strong>‚ö†Ô∏è ${httpStatus} - Client Error</strong><br><br>
                                ${errorMessage}<br><br>
                                <strong>üí° What to do:</strong><br>
                                ‚Ä¢ Review your credentials<br>
                                ‚Ä¢ Check the OAuth endpoint<br>
                                ‚Ä¢ Try again or contact support<br><br>
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #01A982; font-weight: 600;">View Error Details</summary>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto; font-size: 0.85em;">${errorMessage}</pre>
                                </details>
                            `;
                    }
                }
                // 5xx errors
                else if (httpStatus >= 500) {
                    switch (httpStatus) {
                        case 500:
                            errorHTML = `
                                <strong>‚ö†Ô∏è 500 - Internal Server Error</strong><br><br>
                                The OAuth server encountered an error.<br><br>
                                <strong>üí° What to do:</strong><br>
                                ‚Ä¢ Wait a moment and try again<br>
                                ‚Ä¢ Check service status page<br>
                                ‚Ä¢ Contact support if issue persists<br><br>
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #01A982; font-weight: 600;">View Error Details</summary>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto; font-size: 0.85em;">${errorMessage}</pre>
                                </details>
                            `;
                            break;
                        
                        case 502:
                        case 503:
                        case 504:
                            errorHTML = `
                                <strong>‚è∞ ${httpStatus} - Service Unavailable</strong><br><br>
                                The OAuth service is temporarily unavailable.<br><br>
                                <strong>üí° What to do:</strong><br>
                                ‚Ä¢ Wait and try again in a few minutes<br>
                                ‚Ä¢ Check service status<br>
                                ‚Ä¢ Contact support if issue persists<br><br>
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #01A982; font-weight: 600;">View Error Details</summary>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto; font-size: 0.85em;">${errorMessage}</pre>
                                </details>
                            `;
                            break;
                        
                        default:
                            errorHTML = `
                                <strong>‚ö†Ô∏è ${httpStatus} - Server Error</strong><br><br>
                                The server encountered an error.<br><br>
                                <strong>üí° What to do:</strong><br>
                                ‚Ä¢ Try again in a few moments<br>
                                ‚Ä¢ Contact system administrator<br><br>
                                <details style="margin-top: 10px;">
                                    <summary style="cursor: pointer; color: #01A982; font-weight: 600;">View Error Details</summary>
                                    <pre style="background: #f5f5f5; padding: 10px; border-radius: 5px; margin-top: 10px; overflow-x: auto; font-size: 0.85em;">${errorMessage}</pre>
                                </details>
                            `;
                    }
                }
            } else {
                errorHTML = `
                    <strong>‚ùå Token Generation Failed</strong><br><br>
                    ${errorMessage}<br><br>
                    <strong>üí° What to do:</strong><br>
                    ‚Ä¢ Verify your credentials<br>
                    ‚Ä¢ Check the OAuth endpoint<br>
                    ‚Ä¢ Try again or contact support
                `;
            }
            
            showTokenError(errorHTML);
        }
        
        function displayTokenResult(tokenData) {
            // Show the result section
            document.getElementById('tokenResultSection').style.display = 'block';
            
            // Display access token
            document.getElementById('accessToken').value = tokenData.access_token;
            
            // Display metadata
            document.getElementById('tokenType').textContent = tokenData.token_type || 'Bearer';
            
            // Format expires_in
            const expiresIn = tokenData.expires_in;
            if (expiresIn) {
                const hours = Math.floor(expiresIn / 3600);
                const minutes = Math.floor((expiresIn % 3600) / 60);
                const seconds = expiresIn % 60;
                
                let expiryText = '';
                if (hours > 0) expiryText += `${hours}h `;
                if (minutes > 0) expiryText += `${minutes}m `;
                if (seconds > 0 || expiryText === '') expiryText += `${seconds}s`;
                
                document.getElementById('expiresIn').textContent = expiryText.trim();
            } else {
                document.getElementById('expiresIn').textContent = 'N/A';
            }
            
            // Display scope
            document.getElementById('tokenScope').textContent = tokenData.scope || 'Default';
            
            // Scroll to result
            document.getElementById('tokenResultSection').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            
            // ===== START 5-MINUTE AUTO-HIDE TIMER =====
            lastTokenGeneratedAt = Date.now();
            
            // Clear any existing timeout
            if (tokenAutoHideTimeout) {
                clearTimeout(tokenAutoHideTimeout);
            }
            
            // Set new timeout to hide token panel after 5 minutes (300 seconds = 300000ms)
            tokenAutoHideTimeout = setTimeout(() => {
                hideTokenPanel();
                console.log('[TOKEN] Auto-hiding token panel after 5 minutes');
            }, 300000);
            
            console.log('[TOKEN] Token generated. Panel will auto-hide in 5 minutes.');
        }
        
        function hideTokenPanel() {
            // Hide the token result section
            document.getElementById('tokenResultSection').style.display = 'none';
            
            // Clear the token from the textarea (security)
            document.getElementById('accessToken').value = '';
            
            // Reset generation timestamp
            lastTokenGeneratedAt = null;
            
            // Clear any pending timeout
            if (tokenAutoHideTimeout) {
                clearTimeout(tokenAutoHideTimeout);
                tokenAutoHideTimeout = null;
            }
            
            console.log('[TOKEN] Token panel hidden and cleared for security');
        }
        
        function copyToClipboard(elementIdOrText, event) {
            let textToCopy;
            const element = document.getElementById(elementIdOrText);

            if (element) {
                textToCopy = element.value;
            } else {
                textToCopy = elementIdOrText;
            }
            
            if (!textToCopy) {
                alert('No text to copy!');
                return;
            }
            
            // Try modern Clipboard API first, fallback to old method
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(textToCopy).then(() => {
                    showCopySuccess(event);
                }).catch(err => {
                    console.log('Clipboard API failed, using fallback:', err);
                    fallbackCopyToClipboard(textToCopy, event);
                });
            } else {
                // Fallback for non-HTTPS contexts
                fallbackCopyToClipboard(textToCopy, event);
            }
        }
        
        function fallbackCopyToClipboard(text, event) {
            // Create a temporary textarea
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            
            try {
                textarea.select();
                textarea.setSelectionRange(0, 99999); // For mobile devices
                const successful = document.execCommand('copy');
                
                if (successful) {
                    showCopySuccess(event);
                } else {
                    alert('Failed to copy to clipboard. Please copy manually.');
                }
            } catch (err) {
                console.error('Fallback copy failed:', err);
                alert('Failed to copy to clipboard. Please copy manually.');
            } finally {
                document.body.removeChild(textarea);
            }
        }
        
        function showCopySuccess(event) {
            const btn = event ? event.target : null;
            if (btn) {
                const originalText = btn.textContent;
                const originalBg = btn.style.background;
                const originalBorder = btn.style.borderColor;
                
                btn.textContent = '‚úÖ Copied!';
                btn.style.background = '#28a745';
                btn.style.borderColor = '#28a745';
                
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = originalBg;
                    btn.style.borderColor = originalBorder;
                }, 2000);
            } else {
                alert('Token copied to clipboard!');
            }
        }
        
        function clearTokenForm() {
            document.getElementById('clientId').value = '';
            document.getElementById('clientSecret').value = '';
            document.getElementById('tokenError').style.display = 'none';
            document.getElementById('tokenSuccess').style.display = 'none';
            document.getElementById('tokenResultSection').style.display = 'none';
            
            // Clear border highlighting
            document.getElementById('tokenEndpoint').style.borderColor = '';
            document.getElementById('clientId').style.borderColor = '';
            document.getElementById('clientSecret').style.borderColor = '';
            
            // Clear token management state
            hideTokenPanel();
        }
        
        function showTokenSuccess(message) {
            const successDiv = document.getElementById('tokenSuccess');
            successDiv.innerHTML = message;
            successDiv.style.display = 'block';
            document.getElementById('tokenError').style.display = 'none';
            
            // Scroll to message
            successDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        
        function showTokenError(message) {
            const errorDiv = document.getElementById('tokenError');
            errorDiv.innerHTML = message;
            errorDiv.style.display = 'block';
            document.getElementById('tokenSuccess').style.display = 'none';
            
            // Scroll to error
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
        

        function showSetActionError(message) {
            console.log('[SET_ACTION] ===== SHOW ERROR CALLED =====');
            console.log('[SET_ACTION] Showing error message, will auto-clear in 30 seconds');
            
            const errorDiv = document.getElementById('setActionError');
            if (!errorDiv) {
                console.error('[SET_ACTION] ‚úó CRITICAL ERROR: Could not find setActionError element!');
                return;
            }
            
            document.getElementById('errorContent').innerHTML = typeof message === 'string' ? message : JSON.stringify(message);
            errorDiv.style.display = 'block';
            document.getElementById('setActionResponse').style.display = 'none';
            console.log('[SET_ACTION] ‚úì Error message displayed');
            
            // Clear previous timeout if exists
            if (setActionTimeoutId) {
                console.log('[SET_ACTION] ‚úì Cancelling previous timeout:', setActionTimeoutId);
                clearTimeout(setActionTimeoutId);
            }
            
            // Auto-clear notification and token after 30 seconds
            console.log('[SET_ACTION] Setting new timeout for 30 seconds (30000ms)...');
            const TIMEOUT_DURATION = 30000;
            console.log('[SET_ACTION] TIMEOUT_DURATION constant =', TIMEOUT_DURATION, 'ms');
            setActionTimeoutId = setTimeout(() => {
                console.log('[SET_ACTION] ===== TIMEOUT CALLBACK FIRED! =====');
                console.log('[SET_ACTION] 30-second timeout triggered, clearing notifications');
                clearSetActionNotifications();
            }, TIMEOUT_DURATION);
            
            console.log('[SET_ACTION] ‚úì Timeout set with ID:', setActionTimeoutId);
            
            // Scroll to error
            errorDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            console.log('[SET_ACTION] ===== SHOW ERROR COMPLETE =====\n');
        }
        
        function clearSetActionNotifications() {
            console.log('[SET_ACTION] ===== CLEAR NOTIFICATIONS CALLED =====');
            console.log('[SET_ACTION] Current timeout ID:', setActionTimeoutId);
            
            let cleared = false;
            
            // Clear success message
            const responseDiv = document.getElementById('setActionResponse');
            if (responseDiv) {
                if (responseDiv.style.display !== 'none') {
                    console.log('[SET_ACTION] ‚úì Hiding success response');
                    responseDiv.style.display = 'none';
                    cleared = true;
                } else {
                    console.log('[SET_ACTION] - Success response already hidden');
                }
            } else {
                console.log('[SET_ACTION] ‚úó ERROR: Could not find setActionResponse element!');
            }
            
            // Clear error message
            const errorDiv = document.getElementById('setActionError');
            if (errorDiv) {
                if (errorDiv.style.display !== 'none') {
                    console.log('[SET_ACTION] ‚úì Hiding error response');
                    errorDiv.style.display = 'none';
                    cleared = true;
                } else {
                    console.log('[SET_ACTION] - Error response already hidden');
                }
            } else {
                console.log('[SET_ACTION] ‚úó ERROR: Could not find setActionError element!');
            }
            
            // Clear Bearer token (security)
            const tokenField = document.getElementById('setActionToken');
            if (tokenField) {
                console.log('[SET_ACTION] ‚úì Clearing token field (value length before:', tokenField.value.length, ')');
                tokenField.value = '';
                console.log('[SET_ACTION] ‚úì Token cleared (value length after:', tokenField.value.length, ')');
                cleared = true;
            } else {
                console.log('[SET_ACTION] ‚úó ERROR: Could not find setActionToken element!');
            }
            
            // Clear timeout tracker
            if (setActionTimeoutId !== null) {
                console.log('[SET_ACTION] ‚úì Clearing timeout:', setActionTimeoutId);
                clearTimeout(setActionTimeoutId);
                setActionTimeoutId = null;
                console.log('[SET_ACTION] ‚úì Timeout ID cleared, now:', setActionTimeoutId);
            } else {
                console.log('[SET_ACTION] - No timeout to clear (ID is null)');
            }
            
            console.log('[SET_ACTION] ===== CLEAR COMPLETE - Items cleared:', cleared, '=====');
        }
        
        function switchTab(tab) {
            // Clear Set Action notifications when switching tabs (security + UX)
            // This prevents stale tokens and notifications from persisting
            if (tab !== 'set') {
                clearSetActionNotifications();
            }
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }
        
        function showSuccess(elementId, message) {
            const el = document.getElementById(elementId);
            if (!el) {
                console.warn(`Element with id "${elementId}" not found for success message:`, message);
                return;
            }
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }
        
        function showError(elementId, message) {
            const el = document.getElementById(elementId);
            if (!el) {
                console.warn(`Element with id "${elementId}" not found for error message:`, message);
                return;
            }
            el.textContent = message;
            el.style.display = 'block';
            setTimeout(() => el.style.display = 'none', 5000);
        }
        
        function clearToken() {
            // Clear main page token
            const mainToken = document.getElementById('bearerToken');
            if (mainToken) {
                mainToken.value = '';
            }
            
            // Clear app status token if exists
            const appToken = document.getElementById('appStatusToken');
            if (appToken) {
                appToken.value = '';
            }
            
            showSuccess('apiSuccess', 'Token cleared successfully');
        }
        
        function clearJSON() {
            document.getElementById('jsonInput').value = '';
        }
        
        async function fetchFromAPI() {
            const baseUrl = document.getElementById('apiBaseUrl').value.trim();
            const path = document.getElementById('transitionPath').value.trim();
            const token = document.getElementById('bearerToken').value.trim();
            const jobId = document.getElementById('jobIdFilter')?.value?.trim();
            const fetchBtn = document.getElementById('fetchBtn');
            
            if (!baseUrl || !path) {
                showError('apiError', 'Please enter API Base URL and Endpoint Path');
                return;
            }
            
            try {
                fetchBtn.disabled = true;
                fetchBtn.textContent = '‚è≥ Fetching...';
                document.getElementById('serverStatus').textContent = 'Fetching from API...';
                
                // If Job ID is provided, fetch job data first
                let filteredCids = null;
                if (jobId) {
                    console.log('[JOB_ID_FILTER] Fetching customers for job:', jobId);
                    const jobResponse = await fetch(`/api/jobs/${jobId}/customers`);
                    const jobResult = await jobResponse.json();
                    
                    if (!jobResult.success) {
                        showError('apiError', 'Invalid Job ID or no customers found for this job.');
                        document.getElementById('serverStatus').textContent = 'Job ID Error ‚úó';
                        fetchBtn.disabled = false;
                        fetchBtn.textContent = 'üîÑ Fetch Transition States';
                        return;
                    }
                    
                    if (!jobResult.customers || jobResult.customers.length === 0) {
                        showError('apiError', 'Invalid Job ID or no customers found for this job.');
                        document.getElementById('serverStatus').textContent = 'Job ID Error ‚úó';
                        fetchBtn.disabled = false;
                        fetchBtn.textContent = 'üîÑ Fetch Transition States';
                        return;
                    }
                    
                    filteredCids = jobResult.customers;
                    console.log('[JOB_ID_FILTER] Found', filteredCids.length, 'customers for job');
                }
                
                const fullUrl = baseUrl + path;
                
                // Use proxy endpoint to avoid CORS issues
                const response = await fetch('/proxy_fetch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url: fullUrl, token: token })
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    let dataToProcess = result.data;
                    let customerCountDisplay = Object.keys(result.data).length;
                    
                    // Filter to job's customers if Job ID was provided
                    if (jobId && filteredCids) {
                        console.log('[JOB_ID_FILTER] Filtering results to job customers...');
                        const cidSet = new Set(filteredCids);
                        dataToProcess = Object.entries(result.data)
                            .filter(([cid]) => cidSet.has(cid))
                            .reduce((obj, [cid, data]) => {
                                obj[cid] = data;
                                return obj;
                            }, {});
                        console.log('[JOB_ID_FILTER] Filtered to', Object.keys(dataToProcess).length, 'customers from upstream result');
                    }
                    
                    processData(dataToProcess);
                    currentMode = 'api';
                    
                    if (jobId && filteredCids) {
                        showSuccess('apiSuccess', `‚úì Job ID: ${jobId} - Found ${Object.keys(dataToProcess).length}/${customerCountDisplay} customers`);
                        document.getElementById('serverStatus').textContent = `API Connected (Job Filtered) ‚úì`;
                    } else {
                        showSuccess('apiSuccess', `‚úì Successfully fetched data from API (${Object.keys(dataToProcess).length} customers)`);
                        document.getElementById('serverStatus').textContent = 'API Connected ‚úì';
                    }
                } else {
                    showError('apiError', result.message || 'Failed to fetch data from API');
                    document.getElementById('serverStatus').textContent = 'API Error ‚úó';
                }
            } catch (error) {
                console.error('Error fetching from API:', error);
                
                // Detect and handle ReferenceError and other frontend runtime errors
                if (error instanceof ReferenceError) {
                    console.error('[FRONTEND_ERROR] ReferenceError - UI error occurred:', error);
                    showError('apiError', 'UI error occurred. Check console for details.');
                    document.getElementById('serverStatus').textContent = 'UI Error ‚úó';
                } else if (error instanceof TypeError) {
                    console.error('[FRONTEND_ERROR] TypeError - UI error occurred:', error);
                    showError('apiError', 'UI error occurred. Check console for details.');
                    document.getElementById('serverStatus').textContent = 'UI Error ‚úó';
                } else {
                    // Regular network or API errors
                    showError('apiError', `Network error: ${error.message}`);
                    document.getElementById('serverStatus').textContent = 'Connection Error ‚úó';
                }
            } finally {
                fetchBtn.disabled = false;
                fetchBtn.textContent = 'üîÑ Fetch Transition States';
            }
        }
        
        function loadFromJSON() {
            const jsonText = document.getElementById('jsonInput').value.trim();
            
            if (!jsonText) {
                showError('jsonError', 'Please paste JSON data');
                return;
            }
            
            try {
                const data = JSON.parse(jsonText);
                
                if (typeof data !== 'object' || Array.isArray(data)) {
                    showError('jsonError', 'Expected an object with customer IDs as keys');
                    return;
                }
                
                processData(data);
                currentMode = 'paste';
                showSuccess('jsonSuccess', `‚úì Successfully loaded ${Object.keys(data).length} customers from JSON`);
                document.getElementById('serverStatus').textContent = 'JSON Loaded ‚úì';
            } catch (error) {
                showError('jsonError', `Invalid JSON: ${error.message}`);
            }
        }
        
        // loadDemoData() removed - demo mode no longer supported
        
        function processData(data) {
            allData = Object.entries(data).map(([customerId, record]) => ({
                customerId,
                actionCode: record.action_code,
                actionDesc: record.action_desc,
                state: normalizeState(record.action_desc, record.action_code)
            }));
            updateStats();
            renderTable(allData);
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }
        
        function normalizeState(actionDesc, actionCode) {
            const d = (actionDesc || '').trim().toLowerCase();
            
            // Check more specific patterns first to avoid substring matches
            if (d.includes('tran-begin') || d.includes('transition-begin') || d === 'begin') return 'Tran-Begin';
            if (d.includes('pe-finalize') || d.includes('finalize')) return 'PE-Finalize';
            if (d.includes('pe-enable') || d === 'pe') return 'PE-Enable';
            if (d.includes('t-enable') || d === 't') return 'T-Enable';
            if (d.includes('pe-direct') || d === 'direct') return 'PE-Direct';
            
            if (actionCode === 1) return 'Tran-Begin';
            if (actionCode === 2) return 'PE-Enable';
            if (actionCode === 3) return 'T-Enable';
            if (actionCode === 4) return 'PE-Finalize';
            if (actionCode === 5) return 'PE-Direct';
            
            return 'Other';
        }
        
        function getActionCodeForName(actionName) {
            /**
             * Convert action name to action code
             * Action codes:
             * 1 = Tran-Begin
             * 2 = PE-Enable
             * 3 = T-Enable
             * 4 = PE-Finalize
             * 5 = PE-Direct
             */
            if (!actionName) return null;
            
            const name = actionName.trim().toLowerCase();
            
            if (name.includes('tran-begin') || name.includes('transition-begin') || name === 'begin') return 1;
            if (name.includes('pe-enable') || name === 'pe') return 2;
            if (name.includes('t-enable') || name === 't') return 3;
            if (name.includes('pe-finalize') || name.includes('finalize')) return 4;
            if (name.includes('pe-direct') || name === 'direct') return 5;
            
            return null;
        }
        
        function getStateBadgeClass(state) {
            const map = {
                'Tran-Begin': 'badge-info',
                'PE-Enable': 'badge-warning',
                'T-Enable': 'badge-warning',
                'PE-Finalize': 'badge-success',
                'PE-Direct': 'badge-warning',
                'Other': 'badge-secondary'
            };
            return map[state] || 'badge-secondary';
        }
        
        
        
        async function loadData() {
            try {
                let data;
                
                // Check if we have API configuration
                const baseUrl = document.getElementById('apiBaseUrl')?.value?.trim();
                const path = document.getElementById('transitionPath')?.value?.trim();
                const token = document.getElementById('bearerToken')?.value?.trim();
                
                if (currentMode === 'api' && baseUrl && path) {
                    // Use API mode
                    document.getElementById('serverStatus').textContent = 'Fetching from API...';
                    const fullUrl = baseUrl + path;
                    
                    const response = await fetch('/proxy_fetch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url: fullUrl, token: token })
                    });
                    
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        data = result.data;
                        document.getElementById('serverStatus').textContent = 'API Connected ‚úì';
                    } else {
                        // Check for token expiry
                        if (result.message && (result.message.includes('401') || result.message.includes('token') || result.message.includes('expired') || result.message.includes('Unauthorized'))) {
                            document.getElementById('serverStatus').textContent = 'Token Expired ‚úó';
                            document.getElementById('tableContainer').innerHTML = 
                                '<div class="alert alert-error">Token expired. Please re-authenticate and enter a valid Bearer Token.</div>';
                            return;
                        }
                        throw new Error(result.message || 'Failed to fetch data');
                    }
                } else if (currentMode === 'paste') {
                    // Paste mode data is handled separately, not in loadData()
                    throw new Error('Use Paste JSON tab to input data');
                } else {
                    // No mode selected - show helpful message
                    throw new Error('Please select API mode and enter API credentials, or use Paste JSON tab');
                }
                
                processData(data);
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('serverStatus').textContent = 'Error ‚úó';
                document.getElementById('tableContainer').innerHTML = 
                    `<div class="alert alert-error">Failed to load data: ${error.message}</div>`;
            }
        }
        
        function updateStats() {
            const counts = {
                'Tran-Begin': 0,
                'PE-Enable': 0,
                'T-Enable': 0,
                'PE-Finalize': 0,
                'PE-Direct': 0,
                'Other': 0
            };
            
            allData.forEach(row => {
                if (counts.hasOwnProperty(row.state)) {
                    counts[row.state]++;
                }
            });
            
            document.getElementById('totalCustomers').textContent = allData.length;
            document.getElementById('tranBegin').textContent = counts['Tran-Begin'];
            document.getElementById('peEnable').textContent = counts['PE-Enable'];
            document.getElementById('tEnable').textContent = counts['T-Enable'];
            document.getElementById('peFinalize').textContent = counts['PE-Finalize'];
            document.getElementById('peDirect').textContent = counts['PE-Direct'];
        }
        
        let currentSort = { column: null, direction: 'asc' };
        
        function sortTable(column) {
            // Toggle sort direction
            if (currentSort.column === column) {
                currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
            } else {
                currentSort.column = column;
                currentSort.direction = 'asc';
            }
            
            // Sort the data
            const sortedData = [...allData].sort((a, b) => {
                let valA, valB;
                
                if (column === 'actionCode') {
                    valA = a.actionCode !== null ? a.actionCode : 999;
                    valB = b.actionCode !== null ? b.actionCode : 999;
                } else if (column === 'state') {
                    valA = a.state || '';
                    valB = b.state || '';
                } else if (column === 'customerId') {
                    valA = a.customerId || '';
                    valB = b.customerId || '';
                } else {
                    return 0;
                }
                
                if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                return 0;
            });
            
            renderTable(sortedData);
        }
        
        function renderTable(data) {
            if (data.length === 0) {
                document.getElementById('tableContainer').innerHTML = 
                    '<div class="loading">No data available</div>';
                return;
            }
            
            const getSortClass = (column) => {
                if (currentSort.column === column) {
                    return currentSort.direction === 'asc' ? 'sort-asc' : 'sort-desc';
                }
                return '';
            };
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable ${getSortClass('customerId')}" onclick="sortTable('customerId')">Customer ID</th>
                            <th class="sortable ${getSortClass('state')}" onclick="sortTable('state')">State</th>
                            <th class="sortable ${getSortClass('actionCode')}" onclick="sortTable('actionCode')">Action Code</th>
                            <th>Action Description</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(row => {
                html += `
                    <tr>
                        <td><code class="customer-id-link" onclick="showAuditHistory('${row.customerId}')">${row.customerId}</code></td>
                        <td><span class="badge ${getStateBadgeClass(row.state)}">${row.state}</span></td>
                        <td>${row.actionCode !== null ? row.actionCode : '-'}</td>
                        <td>${row.actionDesc || '-'}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('tableContainer').innerHTML = html;
        }
        
        // Search functionality
        document.getElementById('searchBox').addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filtered = allData.filter(row => 
                row.customerId.toLowerCase().includes(searchTerm) ||
                row.state.toLowerCase().includes(searchTerm) ||
                (row.actionDesc && row.actionDesc.toLowerCase().includes(searchTerm))
            );
            
            // Apply current sort to filtered data
            if (currentSort.column) {
                const sortedFiltered = [...filtered].sort((a, b) => {
                    let valA, valB;
                    if (currentSort.column === 'actionCode') {
                        valA = a.actionCode !== null ? a.actionCode : 999;
                        valB = b.actionCode !== null ? b.actionCode : 999;
                    } else if (currentSort.column === 'state') {
                        valA = a.state || '';
                        valB = b.state || '';
                    } else if (currentSort.column === 'customerId') {
                        valA = a.customerId || '';
                        valB = b.customerId || '';
                    }
                    if (valA < valB) return currentSort.direction === 'asc' ? -1 : 1;
                    if (valA > valB) return currentSort.direction === 'asc' ? 1 : -1;
                    return 0;
                });
                renderTable(sortedFiltered);
            } else {
                renderTable(filtered);
            }
        });
        
        // View navigation
        let currentStateFilter = null;
        
        function showMainView() {
            const mainView = document.getElementById('mainView');
            const stateView = document.getElementById('stateView');
            mainView.classList.add('active');
            stateView.classList.remove('active');
            currentStateFilter = null;
            window.scrollTo(0, 0);
        }
        
        let currentStateCustomers = [];
        
        function showStateDetails(state) {
            try {
                console.log('=== DEBUG: showStateDetails START ===');
                console.log('State requested:', state);
                console.log('allData length:', allData.length);
                
                const stateCustomers = allData.filter(row => row.state === state);
                console.log('Customers found for state:', stateCustomers.length);
                console.log('Sample customer:', stateCustomers[0]);
                
                if (stateCustomers.length === 0) {
                    console.log('ERROR: No customers found for state:', state);
                    return;
                }
                
                currentStateFilter = state;
                currentStateCustomers = stateCustomers;
                
                // Clear APP Status cache and hide aggregated status when switching states
                appStatusCache = null;
                document.getElementById('aggregatedStatusContainer').classList.remove('active');
                document.getElementById('fetchAggregatedBtn').style.display = 'inline-block';
                document.getElementById('hideAggregatedBtn').style.display = 'none';
                // Destroy existing charts
                appStatusCharts.forEach(chart => chart.destroy());
                appStatusCharts = [];
                
                // Update header
                const titleEl = document.getElementById('stateViewTitle');
                const subtitleEl = document.getElementById('stateViewSubtitle');
                console.log('Title element found:', !!titleEl);
                console.log('Subtitle element found:', !!subtitleEl);
                
                titleEl.textContent = state;
                subtitleEl.textContent = 
                    `${stateCustomers.length} customer${stateCustomers.length !== 1 ? 's' : ''} in this state`;
                
                console.log('Header updated. Title:', titleEl.textContent, 'Subtitle:', subtitleEl.textContent);
                
                // Show action buttons only for Tran-Begin state
                const actionButtons = document.getElementById('stateActionButtons');
                console.log('Action buttons element found:', !!actionButtons);
                
                if (state === 'Tran-Begin' && stateCustomers.length > 0) {
                    actionButtons.style.display = 'flex';
                    console.log('Action buttons shown');

                } else {
                    actionButtons.style.display = 'none';
                    console.log('Action buttons hidden');
                }
                
                // Render table
                console.log('Calling renderStateTable...');
                renderStateTable(stateCustomers);
                console.log('renderStateTable completed');
                
                // Switch views - hide main dashboard, show detail as separate page
                const mainView = document.getElementById('mainView');
                const stateView = document.getElementById('stateView');
                mainView.classList.remove('active');
                stateView.classList.add('active');
                
                console.log('After class switch - mainView active:', mainView.classList.contains('active'), 'stateView active:', stateView.classList.contains('active'));
                
                // Jump to top of detail page
                window.scrollTo(0, 0);
                
                // Setup search for state view
                const searchBox = document.getElementById('stateSearchBox');
                console.log('Search box element found:', !!searchBox);
                searchBox.value = '';
                setupStateSearch(stateCustomers);
                console.log('=== DEBUG: showStateDetails END ===');
            } catch (error) {
                console.error('‚ùå EXCEPTION in showStateDetails:', error.message);
                console.error('Stack:', error.stack);
            }
        }
        
        function renderStateTable(data) {
            console.log('=== DEBUG: renderStateTable START ===');
            console.log('Data received:', data.length, 'items');
            
            const container = document.getElementById('stateTableContainer');
            console.log('Container found:', !!container);
            console.log('Container HTML before:', container.innerHTML.substring(0, 100));
            
            if (data.length === 0) {
                console.log('No data, showing empty message');
                container.innerHTML = 
                    '<div class="loading">No customers found</div>';
                return;
            }
            
            let html = `
                <table>
                    <thead>
                        <tr>
                            <th>Customer ID</th>
                            <th>State</th>
                            <th>Action Code</th>
                            <th>Action Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            data.forEach(row => {
                html += `
                    <tr>
                        <td><code class="customer-id-link" onclick="showAuditHistory('${row.customerId}')">${row.customerId}</code></td>
                        <td><span class="badge ${getStateBadgeClass(row.state)}">${row.state}</span></td>
                        <td>${row.actionCode !== null ? row.actionCode : '-'}</td>
                        <td>${row.actionDesc || '-'}</td>
                        <td><button style="background: #01A982; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.9em; cursor: pointer; font-weight: 600;" onclick="fetchCustomerAppStatus('${row.customerId}')">View All Apps</button></td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
            container.className = 'scrollable-table-container';
            
            console.log('Container HTML after:', container.innerHTML.substring(0, 100));
            console.log('=== DEBUG: renderStateTable END ===');
        }
        
        function setupStateSearch(originalData) {
            const searchBox = document.getElementById('stateSearchBox');
            searchBox.removeEventListener('input', handleStateSearch);
            
            function handleStateSearch(e) {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = originalData.filter(row => 
                    row.customerId.toLowerCase().includes(searchTerm) ||
                    (row.actionDesc && row.actionDesc.toLowerCase().includes(searchTerm))
                );
                renderStateTable(filtered);
            }
            
            searchBox.addEventListener('input', handleStateSearch);
        }
        
        // ===== RUNBOOK MAPPING =====
        const runbookMapping = {
            // Format: 'app:status:reason_pattern' => 'Confluence URL'
            'airmatch:failure:timeout': 'https://confluence.example.com/display/TMS/Airmatch+Timeout+Resolution',
            'airmatch:failure:connection': 'https://confluence.example.com/display/TMS/Airmatch+Connection+Issues',
            'kms:failure:invalid': 'https://confluence.example.com/display/TMS/KMS+Invalid+Credentials',
            'kms:failure:timeout': 'https://confluence.example.com/display/TMS/KMS+Timeout+Resolution',
            'airgroup:failure:': 'https://confluence.example.com/display/TMS/Airgroup+Failure+Handling',
            'wids:failure:': 'https://confluence.example.com/display/TMS/WIDS+Failure+Handling',
            'ucc:failure:': 'https://confluence.example.com/display/TMS/UCC+Failure+Handling',
            'scb:failure:': 'https://confluence.example.com/display/TMS/SCB+Failure+Handling',
            'oto-oms:failure:': 'https://confluence.example.com/display/TMS/OTO-OMS+Failure+Handling',
            'dpp:failure:': 'https://confluence.example.com/display/TMS/DPP+Failure+Handling'
        };

        function getRunbookUrl(appName, status, reason) {
            if (status.toLowerCase() !== 'failed') return null;
            const appKey = (appName || '').toLowerCase();
            const reasonKey = (reason || '').toLowerCase();
            const key = `${appKey}:failure:${reasonKey}`;
            if (runbookMapping[key]) return runbookMapping[key];
            if (runbookMapping[`${appKey}:failure:`]) return runbookMapping[`${appKey}:failure:`];
            return null;
        }

        // App Status Functions
        let appStatusCharts = [];
        let appStatusCache = null; // Cache API results

        function closeAppStatusModal() {
            document.getElementById('appStatusModal').classList.remove('active');
            // Destroy existing charts
            appStatusCharts.forEach(chart => chart.destroy());
            appStatusCharts = [];
        }
        
        function openAppStatusModal(title, content) {
            document.getElementById('modalTitle').textContent = title;
            document.getElementById('modalBody').innerHTML = content;
            document.getElementById('appStatusModal').classList.add('active');
        }
        
        async function fetchCustomerAppStatus(customerId) {
            const apiBaseUrl = document.getElementById('appStatusApiUrl')?.value?.trim() || 'https://cnx-apigw-evian3.arubadev.cloud.hpe.com/tms/v1/get/appstatus?app=ALL&cid=';
            const token = document.getElementById('appStatusToken')?.value?.trim() || '';
            
            openAppStatusModal(`App Status - ${customerId}`, '<div class="loading">Loading app status...</div>');
            
            try {
                // Construct the API URL - if base URL already ends with cid=, just append the customer ID
                let apiUrl;
                if (apiBaseUrl.includes('cid=')) {
                    apiUrl = apiBaseUrl + customerId;
                } else {
                    apiUrl = `${apiBaseUrl}/tms/v1/get/appstatus?app=ALL&cid=${customerId}`;
                }
                
                const response = await fetch('/proxy_fetch', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ url: apiUrl, token: token })
                });
                
                const result = await response.json();
                
                if (result.status === 'success' && Array.isArray(result.data)) {
                    renderCustomerAppStatus(result.data, customerId);
                } else {
                    document.getElementById('modalBody').innerHTML = 
                        `<div class="alert alert-error">Failed to fetch app status: ${result.message || 'Unknown error'}</div>`;
                }
            } catch (error) {
                document.getElementById('modalBody').innerHTML = 
                    `<div class="alert alert-error">Error: ${error.message}</div>`;
            }
        }
        
        function renderCustomerAppStatus(appData, customerId) {
            let html = `
                <div class="app-status-table">
                    <p><strong>Customer ID:</strong> <code>${customerId}</code></p>
                    <table>
                        <thead>
                            <tr>
                                <th>Application</th>
                                <th>Status</th>
                                <th>Reason</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            appData.forEach(app => {
                const statusClass = getAppStatusClass(app.status);
                const reason = app.reason || '-';
                
                html += `
                    <tr>
                        <td><strong>${app.app_name}</strong></td>
                        <td><span class="${statusClass}">${app.status}</span></td>
                        <td>${reason}</td>
                    </tr>
                `;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('modalBody').innerHTML = html;
        }
        
        function getAppStatusClass(status) {
            const statusLower = (status || '').toLowerCase();
            if (statusLower.includes('ready') || statusLower.includes('passed')) {
                return 'status-ready';
            } else if (statusLower.includes('fail')) {
                return 'status-failure';
            } else if (statusLower.includes('transit')) {
                return 'status-transiting';
            } else {
                return 'status-unknown';
            }
        }
        
        function hideAggregatedStatus() {
            document.getElementById('aggregatedStatusContainer').classList.remove('active');
            document.getElementById('fetchAggregatedBtn').style.display = 'inline-block';
            document.getElementById('hideAggregatedBtn').style.display = 'none';
            // Destroy existing charts
            appStatusCharts.forEach(chart => chart.destroy());
            appStatusCharts = [];
        }
        
        async function fetchAggregatedAppStatus() {
            const apiBaseUrl = document.getElementById('appStatusApiUrl')?.value?.trim() || 'https://cnx-apigw-evian3.arubadev.cloud.hpe.com/tms/v1/get/appstatus?app=ALL&cid=';
            const token = document.getElementById('appStatusToken')?.value?.trim() || '';
            
            if (currentStateCustomers.length === 0) {
                alert('No customers to fetch app status for');
                return;
            }
            
            // Check if token is provided
            if (!token) {
                alert('‚ö†Ô∏è Bearer Token Required\n\nPlease enter a valid Bearer Token to fetch app status data.');
                // Highlight the token field
                const tokenField = document.getElementById('appStatusToken');
                if (tokenField) {
                    tokenField.focus();
                    tokenField.style.borderColor = '#dc3545';
                    setTimeout(() => {
                        tokenField.style.borderColor = '';
                    }, 3000);
                }
                return;
            }
            
            // Show container and update UI
            document.getElementById('aggregatedStatusContainer').classList.add('active');
            document.getElementById('aggregatedSubtitle').textContent = `Fetching app status for ${currentStateCustomers.length} customers...`;
            document.getElementById('aggregatedStatusContent').innerHTML = '<div class="loading">Loading...</div>';
            document.getElementById('fetchAggregatedBtn').style.display = 'none';
            document.getElementById('hideAggregatedBtn').style.display = 'inline-block';
            
            // Check if we have cached results
            if (appStatusCache && appStatusCache.token === token && appStatusCache.customers === JSON.stringify(currentStateCustomers.map(c => c.customerId).sort())) {
                renderAggregatedAppStatusWithAllFeatures(appStatusCache.results);
                // Scroll to aggregated section
                setTimeout(() => {
                    document.getElementById('aggregatedStatusContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
                }, 100);
                return;
            }
            
            // Scroll to aggregated section
            setTimeout(() => {
                document.getElementById('aggregatedStatusContainer').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
            
            try {
                const promises = currentStateCustomers.map(customer => {
                    // Construct URL properly
                    let apiUrl;
                    if (apiBaseUrl.includes('cid=')) {
                        apiUrl = apiBaseUrl + customer.customerId;
                    } else {
                        apiUrl = `${apiBaseUrl}/tms/v1/get/appstatus?app=ALL&cid=${customer.customerId}`;
                    }
                    
                    return fetch('/proxy_fetch', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({ url: apiUrl, token: token })
                    })
                    .then(res => res.json())
                    .then(result => {
                        // Handle 401/403 errors
                        if (result.httpStatus === 401 || result.httpStatus === 403) {
                            throw new Error('Token expired or unauthorized');
                        }
                        return {
                            customerId: customer.customerId,
                            data: result.status === 'success' ? result.data : [],
                            error: result.status !== 'success' ? result.message : null
                        };
                    });
                });
                
                const results = await Promise.all(promises);
                // Cache results
                appStatusCache = {
                    token: token,
                    customers: JSON.stringify(currentStateCustomers.map(c => c.customerId).sort()),
                    results: results
                };
                renderAggregatedAppStatusWithAllFeatures(results);
            } catch (error) {
                const errorMsg = error.message.includes('Token') ? 'Token expired or unauthorized. Please enter a valid token.' : error.message;
                document.getElementById('aggregatedStatusContent').innerHTML = 
                    `<div class="alert alert-error">Error fetching aggregated status: ${errorMsg}</div>`;
            }
        }
        
        let appStatusDetails = {}; // Store app status details for drill-down

        function renderAggregatedAppStatusWithAllFeatures(results) {
            // ===== AGGREGATE DATA BY APP AND CUSTOMER HEALTH =====
            // Define expected apps list (8 total)
            const EXPECTED_APPS = ["airgroup", "airmatch", "dpp", "kms", "oto-oms", "scb", "ucc", "wids"];
            
            const appAggregation = {};
            const customerHealthStatus = {}; // Track each customer's overall status
            const allAppsData = {}; // For detailed drill-down
            appStatusDetails = {}; // Reset drill-down data
            
            results.forEach(result => {
                if (result.data && Array.isArray(result.data)) {
                    let customerAppCount = 0;
                    let customerReadyCount = 0;     // READY + INAPPLICABLE both count here
                    let customerFailureCount = 0;
                    let customerTransitingCount = 0;
                    let customerUnknownCount = 0;
                    const customerApps = [];
                    const reportedAppNames = new Set();
                    
                    result.data.forEach(app => {
                        customerAppCount++;
                        reportedAppNames.add(app.app_name);
                        
                        if (!appAggregation[app.app_name]) {
                            appAggregation[app.app_name] = {
                                ready: 0,
                                inapplicable: 0,
                                failure: 0,
                                transitioning: 0,
                                unknown: 0,
                                total: 0
                            };
                            appStatusDetails[app.app_name] = {
                                readyCustomers: [],
                                inapplicableCustomers: [],
                                failureCustomers: [],
                                transitingCustomers: [],
                                unknownCustomers: []
                            };
                        }
                        
                        const statusLower = (app.status || '').toLowerCase();
                        const customerData = {
                            customerId: result.customerId,
                            status: app.status,
                            reason: app.reason || ''
                        };
                        
                        if (statusLower.includes('ready') || statusLower.includes('passed')) {
                            appAggregation[app.app_name].ready++;
                            appStatusDetails[app.app_name].readyCustomers.push(customerData);
                            customerReadyCount++;
                        } else if (statusLower.includes('inapplicable')) {
                            // INAPPLICABLE treated like READY for health calculation
                            appAggregation[app.app_name].inapplicable++;
                            appStatusDetails[app.app_name].inapplicableCustomers.push(customerData);
                            customerReadyCount++;  // Count as ready-like status
                        } else if (statusLower.includes('fail')) {
                            appAggregation[app.app_name].failure++;
                            appStatusDetails[app.app_name].failureCustomers.push(customerData);
                            customerFailureCount++;
                        } else if (statusLower.includes('transit') || statusLower.includes('init')) {
                            appAggregation[app.app_name].transitioning++;
                            appStatusDetails[app.app_name].transitingCustomers.push(customerData);
                            customerTransitingCount++;
                        } else {
                            appAggregation[app.app_name].unknown++;
                            appStatusDetails[app.app_name].unknownCustomers.push(customerData);
                            customerUnknownCount++;
                        }
                        appAggregation[app.app_name].total++;
                        customerApps.push(app);
                    });
                    
                    allAppsData[result.customerId] = customerApps;
                    
                    // Determine customer health status with INAPPLICABLE treated as READY
                    // Count missing apps (expected 8, but some may not have reported yet)
                    const missingAppCount = EXPECTED_APPS.length - reportedAppNames.size;
                    
                    // Classification rules (in priority order):
                    // Rule 1: Any failure makes customer HAS_FAILURE
                    if (customerFailureCount > 0) {
                        customerHealthStatus[result.customerId] = 'HAS_FAILURE';
                    } 
                    // Rule 2: Missing apps means customer is still HAS_UNKNOWN_OR_TRANSITIONING
                    else if (missingAppCount > 0) {
                        customerHealthStatus[result.customerId] = 'HAS_UNKNOWN_OR_TRANSITIONING';
                    }
                    // Rule 3: All apps reported and all are Ready or Inapplicable, no Transiting/Init/Unknown
                    else if (customerReadyCount === EXPECTED_APPS.length && customerTransitingCount === 0 && customerUnknownCount === 0) {
                        customerHealthStatus[result.customerId] = 'ALL_READY';
                    }
                    // Rule 4: Fallback to transitioning
                    else {
                        customerHealthStatus[result.customerId] = 'HAS_UNKNOWN_OR_TRANSITIONING';
                    }
                }
            });
            
            // ===== COMPUTE SUMMARY COUNTS =====
            const healthCounts = {
                total: results.length,
                allReady: Object.values(customerHealthStatus).filter(s => s === 'ALL_READY').length,
                hasFailure: Object.values(customerHealthStatus).filter(s => s === 'HAS_FAILURE').length,
                hasUnknownOrTransitioning: Object.values(customerHealthStatus).filter(s => s === 'HAS_UNKNOWN_OR_TRANSITIONING').length
            };
            
            // ===== BUILD HTML =====
            let html = '';
            
            // Health Summary Section
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: #333; font-weight: 700; font-size: 1.1em;">üìä Overall Customer Health Summary</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div onclick="filterCustomersByHealth('ALL_READY')" style="cursor: pointer; padding: 20px; background: #e8f5e9; border-left: 4px solid #28a745; border-radius: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="font-size: 1.05em; color: #333; font-weight: 700;">‚úÖ All Apps Ready</div>
                            <div style="font-size: 2em; color: #28a745; font-weight: bold; margin-top: 5px;">${healthCounts.allReady}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">Click to filter</div>
                        </div>
                        <div onclick="filterCustomersByHealth('HAS_FAILURE')" style="cursor: pointer; padding: 20px; background: #ffebee; border-left: 4px solid #dc3545; border-radius: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="font-size: 1.05em; color: #333; font-weight: 700;">‚ùå At Least One Failed</div>
                            <div style="font-size: 2em; color: #dc3545; font-weight: bold; margin-top: 5px;">${healthCounts.hasFailure}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">Click to filter</div>
                        </div>
                        <div onclick="filterCustomersByHealth('HAS_UNKNOWN_OR_TRANSITIONING')" style="cursor: pointer; padding: 20px; background: #fff3cd; border-left: 4px solid #ffc107; border-radius: 8px; transition: all 0.3s ease;" onmouseover="this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'" onmouseout="this.style.boxShadow='none'">
                            <div style="font-size: 1.05em; color: #333; font-weight: 700;">‚ö†Ô∏è Unknown/Transitioning</div>
                            <div style="font-size: 2em; color: #ffc107; font-weight: bold; margin-top: 5px;">${healthCounts.hasUnknownOrTransitioning}</div>
                            <div style="font-size: 0.8em; color: #999; margin-top: 5px;">Click to filter</div>
                        </div>
                    </div>
                </div>
            `;
            
            // App Health Matrix Section
            html += `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin-bottom: 15px; color: #333;">üìã App Health Matrix</h3>
                    <div style="overflow-x: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
                        <table style="width: 100%; border-collapse: collapse; font-size: 1.05em;">
                            <thead>
                                <tr style="background: #f5f5f5; border-bottom: 2px solid #ddd;">
                                    <th style="padding: 15px; text-align: left; border-right: 1px solid #eee; font-weight: 700; font-size: 1.1em;">App</th>
                                    <th style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-weight: 700; font-size: 1.05em;" onclick="sortMatrixBy('ready')">‚úÖ Ready</th>
                                    <th style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-weight: 700; font-size: 1.05em;" onclick="sortMatrixBy('inapplicable')">‚äò Inapplicable</th>
                                    <th style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-weight: 700; font-size: 1.05em;" onclick="sortMatrixBy('failure')">‚ùå Failed</th>
                                    <th style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-weight: 700; font-size: 1.05em;" onclick="sortMatrixBy('unknown')">‚ùì Unknown</th>
                                    <th style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-weight: 700; font-size: 1.05em;" onclick="sortMatrixBy('transit')">üîÑ Transitioning</th>
                                    <th style="padding: 15px; text-align: center; font-weight: 700; font-size: 1.05em;">Stacked Bar</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            Object.keys(appAggregation).sort().forEach(appName => {
                const stats = appAggregation[appName];
                const total = stats.ready + stats.inapplicable + stats.failure + stats.transitioning + stats.unknown;
                const readyPct = total > 0 ? ((stats.ready / total) * 100).toFixed(0) : 0;
                const inapplicablePct = total > 0 ? ((stats.inapplicable / total) * 100).toFixed(0) : 0;
                const failPct = total > 0 ? ((stats.failure / total) * 100).toFixed(0) : 0;
                const unknownPct = total > 0 ? ((stats.unknown / total) * 100).toFixed(0) : 0;
                const transitPct = total > 0 ? ((stats.transitioning / total) * 100).toFixed(0) : 0;
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; hover-bg: #f9f9f9;">
                        <td style="padding: 15px; font-weight: 700; border-right: 1px solid #eee; background: #f9f9f9; font-size: 1.05em;">${appName}</td>
                        <td style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-size: 1em;" onclick="drillDownFromMatrix('${appName}', 'ready')" title="Click to view customers">
                            <span style="background: #e8f5e9; padding: 6px 10px; border-radius: 4px; font-weight: 700; color: #28a745; font-size: 1.05em;">${stats.ready}</span>
                        </td>
                        <td style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-size: 1em;" onclick="drillDownFromMatrix('${appName}', 'inapplicable')" title="Click to view customers">
                            <span style="background: #e0e0e0; padding: 6px 10px; border-radius: 4px; font-weight: 700; color: #666; font-size: 1.05em;">${stats.inapplicable}</span>
                        </td>
                        <td style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-size: 1em;" onclick="drillDownFromMatrix('${appName}', 'failure')" title="Click to view customers">
                            <span style="background: #ffebee; padding: 6px 10px; border-radius: 4px; font-weight: 700; color: #dc3545; font-size: 1.05em;">${stats.failure}</span>
                        </td>
                        <td style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-size: 1em;" onclick="drillDownFromMatrix('${appName}', 'unknown')" title="Click to view customers">
                            <span style="background: #f5f5f5; padding: 6px 10px; border-radius: 4px; font-weight: 700; color: #666; font-size: 1.05em;">${stats.unknown}</span>
                        </td>
                        <td style="padding: 15px; text-align: center; border-right: 1px solid #eee; cursor: pointer; font-size: 1em;" onclick="drillDownFromMatrix('${appName}', 'transitioning')" title="Click to view customers">
                            <span style="background: #fff3e0; padding: 6px 10px; border-radius: 4px; font-weight: 700; color: #ff9800; font-size: 1.05em;">${stats.transitioning}</span>
                        </td>
                        <td style="padding: 15px; text-align: center; font-size: 1em;">
                            <div style="display: flex; height: 20px; background: #f0f0f0; border-radius: 3px; overflow: hidden;">
                                <div style="width: ${readyPct}%; background: #28a745;" title="${readyPct}% Ready"></div>
                                <div style="width: ${inapplicablePct}%; background: #999;" title="${inapplicablePct}% Inapplicable"></div>
                                <div style="width: ${failPct}%; background: #dc3545;" title="${failPct}% Failed"></div>
                                <div style="width: ${unknownPct}%; background: #e0e0e0;" title="${unknownPct}% Unknown"></div>
                                <div style="width: ${transitPct}%; background: #ffc107;" title="${transitPct}% Transitioning"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Drill-down section
            html += `
                <div id="healthDrillDownSection" style="display: none; margin-top: 30px; padding: 20px; background: #f9f9f9; border-radius: 8px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <h3 id="drillDownSectionTitle" style="margin: 0; color: #333; font-weight: 700; font-size: 1.1em; flex: 1;"></h3>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <button id="downloadDrillDownBtn" onclick="downloadHealthDrillDownCSV()" style="background: #01A982; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 0.9em; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; margin: 0;">
                                üì• Download CSV
                            </button>
                            <button onclick="closeDrillDown()" style="background: none; border: none; font-size: 1.5em; cursor: pointer; color: #999;">‚úï</button>
                        </div>
                    </div>
                    <div style="margin-bottom: 15px;">
                        <input type="text" id="customerDrillDownSearch" placeholder="Search customer ID..." style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 0.9em;">
                    </div>
                    <div id="healthDrillDownContent" style="max-height: 600px; overflow-y: auto;"></div>
                </div>
            `;
            
            document.getElementById('aggregatedSubtitle').textContent = 
                `Showing app status aggregation across ${results.length} customers`;
            document.getElementById('aggregatedStatusContent').innerHTML = html;
            
            // Store data for drill-down
            window.appHealthData = {
                appAggregation,
                customerHealthStatus,
                allAppsData,
                appStatusDetails
            };
        }
        
        function filterCustomersByHealth(healthStatus) {
            const data = window.appHealthData;
            let customers = Object.entries(data.customerHealthStatus)
                .filter(([cid, status]) => status === healthStatus)
                .map(([cid]) => cid);
            
            showHealthDrillDown(`Customers - ${healthStatus}`, customers, healthStatus);
        }
        
        function drillDownFromMatrix(appName, statusType) {
            const data = window.appHealthData;
            let customers = [];
            let title = '';
            
            if (statusType === 'ready') {
                customers = (data.appStatusDetails[appName]?.readyCustomers || []).map(c => c.customerId);
                title = `${appName} - Ready Customers`;
            } else if (statusType === 'inapplicable') {
                customers = (data.appStatusDetails[appName]?.inapplicableCustomers || []).map(c => c.customerId);
                title = `${appName} - Inapplicable Customers`;
            } else if (statusType === 'failure') {
                customers = (data.appStatusDetails[appName]?.failureCustomers || []).map(c => c.customerId);
                title = `${appName} - Failed Customers`;
            } else if (statusType === 'unknown') {
                customers = (data.appStatusDetails[appName]?.unknownCustomers || []).map(c => c.customerId);
                title = `${appName} - Unknown Customers`;
            } else if (statusType === 'transitioning') {
                customers = (data.appStatusDetails[appName]?.transitingCustomers || []).map(c => c.customerId);
                title = `${appName} - Transitioning Customers`;
            }
            
            showHealthDrillDown(title, customers, statusType, appName);
        }
        
        function showHealthDrillDown(title, customerIds, statusType, appName) {
            // Store customer IDs globally for CSV download
            window.currentDrillDownCustomers = customerIds;
            window.currentDrillDownTitle = title;
            window.currentDrillDownAppName = appName || null;  // App name for App Health Matrix drill-downs
            window.currentDrillDownStatusType = statusType || null;  // Status type for both matrix and health summary
            
            document.getElementById('drillDownSectionTitle').textContent = title;
            document.getElementById('customerDrillDownSearch').value = '';
            document.getElementById('healthDrillDownSection').style.display = 'block';
            
            const data = window.appHealthData;
            renderHealthDrillDownList(customerIds, statusType, appName);
            
            document.getElementById('customerDrillDownSearch').oninput = (e) => {
                const searchTerm = e.target.value.toLowerCase();
                const filtered = customerIds.filter(cid => cid.toLowerCase().includes(searchTerm));
                renderHealthDrillDownList(filtered, statusType, appName);
            };
            
            setTimeout(() => {
                document.getElementById('healthDrillDownSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }
        
        function renderHealthDrillDownList(customerIds, statusType, appName) {
            const data = window.appHealthData;
            if (customerIds.length === 0) {
                document.getElementById('healthDrillDownContent').innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">No customers found.</p>';
                return;
            }
            
            // Set default runbook URL based on status type
            let defaultRunbookUrl = null;
            let defaultRunbookText = 'N/A';
            
            if (statusType === 'HAS_FAILURE' || statusType === 'failure') {
                defaultRunbookUrl = 'https://confluence.arubanetworks.com/spaces/ArubaEng/pages/1351848440/PE+Migration+Runbooks';
                defaultRunbookText = 'üìñ Open';
            } else if (statusType === 'HAS_UNKNOWN_OR_TRANSITIONING' || statusType === 'unknown' || statusType === 'transitioning') {
                defaultRunbookUrl = 'https://confluence.arubanetworks.com/spaces/ArubaEng/pages/1351848440/PE+Migration+Runbooks';
                defaultRunbookText = 'üìñ Open';
            } else if (statusType === 'ALL_READY' || statusType === 'ready') {
                defaultRunbookUrl = null;
                defaultRunbookText = 'Runbook not applicable';
            }
            
            let html = `
                <div style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.85em;">
                        <thead>
                            <tr style="background: #f0f0f0; border-bottom: 1px solid #ddd;">
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #ddd; font-weight: 700; font-size: 1.05em;">Customer ID</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #ddd; font-weight: 700; font-size: 1.05em;">App Status</th>
                                <th style="padding: 12px; text-align: left; border-right: 1px solid #ddd; font-weight: 700; font-size: 1.05em;">Failure Reason</th>
                                <th style="padding: 12px; text-align: center; border-right: 1px solid #ddd; font-weight: 700; font-size: 1.05em;">Runbook</th>
                                <th style="padding: 12px; text-align: center; font-weight: 700; font-size: 1.05em;">Action</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            customerIds.slice(0, 500).forEach(customerId => {
                const customerApps = data.allAppsData[customerId] || [];
                let statusStr = 'Unknown';
                let failureReason = '-';
                let runbookUrl = null;
                
                if (appName) {
                    const app = customerApps.find(a => a.app_name === appName);
                    if (app) {
                        statusStr = app.status;
                        failureReason = app.reason || '-';
                        runbookUrl = getRunbookUrl(appName, app.status, app.reason);
                    }
                } else {
                    const failedApp = customerApps.find(a => a.status && a.status.toLowerCase().includes('fail'));
                    if (failedApp) {
                        statusStr = failedApp.status;
                        failureReason = failedApp.reason || '-';
                        runbookUrl = getRunbookUrl(failedApp.app_name, failedApp.status, failedApp.reason);
                    }
                }
                
                const statusClass = statusStr.toLowerCase().includes('ready') ? 'status-ready' : 
                                    statusStr.toLowerCase().includes('fail') ? 'status-failure' :
                                    statusStr.toLowerCase().includes('transit') ? 'status-transiting' : 'status-unknown';
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; hover-bg: #f9f9f9;">
                        <td style="padding: 12px; border-right: 1px solid #eee; font-size: 1em;">
                            <code class="customer-id-link" style="background: #f5f5f5; padding: 4px 8px; border-radius: 3px; font-size: 0.95em; cursor: pointer;" onclick="showAuditHistory('${customerId}')" title="Click to view audit history">${customerId}</code>
                        </td>
                        <td style="padding: 12px; border-right: 1px solid #eee; font-size: 1em;">
                            <span class="${statusClass}" style="padding: 5px 10px; border-radius: 4px; font-weight: 700; font-size: 1.05em;">${statusStr}</span>
                        </td>
                        <td style="padding: 12px; border-right: 1px solid #eee; font-size: 1em; color: #666;">${failureReason}</td>
                        <td style="padding: 12px; border-right: 1px solid #eee; text-align: center; font-size: 1em;">
                            ${(runbookUrl || defaultRunbookUrl) 
                                ? `<a href="${runbookUrl || defaultRunbookUrl}" target="_blank" style="color: #01A982; text-decoration: none; font-weight: 700; font-size: 1.05em;">${defaultRunbookText}</a>` 
                                : `<span style="color: #999; font-size: 0.95em;">${defaultRunbookText}</span>`}
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="fetchCustomerAppStatus('${customerId}')" style="background: #01A982; color: white; border: none; padding: 6px 12px; border-radius: 4px; font-size: 0.95em; cursor: pointer; font-weight: 600;">View All Apps</button>
                        </td>
                    </tr>
                `;
            });
            
            if (customerIds.length > 500) {
                html += `
                    <tr>
                        <td colspan="5" style="padding: 12px; text-align: center; color: #999; font-size: 1em;">Showing first 500 of ${customerIds.length} customers</td>
                    </tr>
                `;
            }
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            document.getElementById('healthDrillDownContent').innerHTML = html;
        }
        
        function closeDrillDown() {
            document.getElementById('healthDrillDownSection').style.display = 'none';
        }
        
        function sortMatrixBy(field) {
            alert(`Sorting by ${field} - feature can be extended`);
        }
        
        function downloadHealthDrillDownCSV() {
            const customerIds = window.currentDrillDownCustomers || [];
            const title = window.currentDrillDownTitle || 'customers';
            const appName = window.currentDrillDownAppName || null;
            const statusType = window.currentDrillDownStatusType || null;
            
            if (customerIds.length === 0) {
                alert('No customers to download');
                return;
            }
            
            // Generate CSV content with header
            let csvContent = 'cust_id\n';
            customerIds.forEach(cid => {
                csvContent += cid + '\n';
            });
            
            // Create filename based on source (App Health Matrix vs Overall Health Summary)
            let filename = 'customers.csv';
            
            if (appName) {
                // App Health Matrix drill-down: <app>_<state>_customers.csv
                const sanitizedAppName = appName.toLowerCase().replace(/\s+/g, '_');
                let stateName = '';
                
                if (statusType === 'ready') {
                    stateName = 'ready';
                } else if (statusType === 'inapplicable') {
                    stateName = 'inapplicable';
                } else if (statusType === 'failure') {
                    stateName = 'failed';
                } else if (statusType === 'unknown') {
                    stateName = 'unknown';
                } else if (statusType === 'transitioning') {
                    stateName = 'transitioning';
                } else {
                    stateName = 'customers';
                }
                
                filename = `${sanitizedAppName}_${stateName}_customers.csv`;
            } else {
                // Overall Health Summary drill-down: overall_<bucket>_customers.csv
                if (statusType === 'ALL_READY') {
                    filename = 'overall_all_apps_ready_customers.csv';
                } else if (statusType === 'HAS_FAILURE') {
                    filename = 'overall_at_least_one_failed_customers.csv';
                } else if (statusType === 'HAS_UNKNOWN_OR_TRANSITIONING') {
                    filename = 'overall_unknown_transitioning_customers.csv';
                } else {
                    filename = 'overall_customers.csv';
                }
            }
            
            // Try to include job ID in filename if available (prepend to filename)
            const jobIdElement = document.getElementById('currentJobIdDisplay');
            if (jobIdElement && jobIdElement.textContent) {
                const jobId = jobIdElement.textContent.trim();
                // Extract base filename without extension and rebuild with job ID
                const baseFilename = filename.replace('.csv', '');
                filename = `job_${jobId}_${baseFilename}.csv`;
            }
            
            // Create and trigger download
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }
        
        function hideCustomerDrillDown() {
            document.getElementById('customerDrillDown').style.display = 'none';
        }
        
        
        // Close modal when clicking outside
        document.addEventListener('click', (e) => {
            const modal = document.getElementById('appStatusModal');
            if (e.target === modal) {
                closeAppStatusModal();
            }
        });
        
        // Load user info on page load (auto-load of demo data removed)
        loadCurrentUser();
        
        // ============================================================
        // AUDIT HISTORY MODAL FUNCTIONS
        // ============================================================
        
        async function showAuditHistory(customerId) {
            const modal = document.getElementById('auditModal');
            const modalBody = document.getElementById('auditModalBody');
            
            // Show modal with loading state
            modal.classList.add('active');
            modalBody.innerHTML = '<div class="loading-spinner">‚è≥ Loading audit history...</div>';
            
            try {
                const response = await fetch(`/api/audit/customer/${customerId}?limit=50`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                if (data.success && data.records && data.records.length > 0) {
                    renderAuditHistory(customerId, data.records);
                } else {
                    modalBody.innerHTML = `
                        <div class="no-audit-data">
                            <h3 style="color: #666; margin-bottom: 10px;">No Action History</h3>
                            <p>No actions have been logged for customer <strong>${customerId}</strong> yet.</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error fetching audit history:', error);
                modalBody.innerHTML = `
                    <div class="no-audit-data" style="color: #dc3545;">
                        <h3>‚ö†Ô∏è Error Loading History</h3>
                        <p>Failed to load audit history: ${error.message}</p>
                        <button class="btn btn-primary" onclick="showAuditHistory('${customerId}')" style="margin-top: 15px;">
                            üîÑ Retry
                        </button>
                    </div>
                `;
            }
        }
        
        function renderAuditHistory(customerId, records) {
            const modalBody = document.getElementById('auditModalBody');
            
            let html = `
                <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #e0e0e0;">
                    <h3 style="color: #333; margin-bottom: 5px;">Customer: <code style="background: #f5f5f5; padding: 5px 10px; border-radius: 5px;">${customerId}</code></h3>
                    <p style="color: #666; font-size: 0.95em;">Total actions: <strong>${records.length}</strong></p>
                </div>
            `;
            
            records.forEach(record => {
                const timestamp = new Date(record.timestamp);
                const formattedTime = timestamp.toLocaleString('en-US', {
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                
                const statusClass = record.status === 'success' ? 'success' : 'failure';
                const entryClass = record.status === 'success' ? '' : 'failure';
                
                html += `
                    <div class="audit-entry ${entryClass}">
                        <div class="audit-entry-header">
                            <span class="audit-action">${record.action_type}</span>
                            <span class="audit-timestamp">‚è∞ ${formattedTime}</span>
                        </div>
                        <div class="audit-details">
                            <div class="audit-detail-item">
                                <span class="audit-detail-label">User</span>
                                <span class="audit-detail-value">üë§ ${record.user_id}</span>
                            </div>
                            <div class="audit-detail-item">
                                <span class="audit-detail-label">Status</span>
                                <span class="audit-status-badge ${statusClass}">${record.status.toUpperCase()}</span>
                            </div>
                            <div class="audit-detail-item">
                                <span class="audit-detail-label">Duration</span>
                                <span class="audit-detail-value">${record.duration_ms ? record.duration_ms + ' ms' : '-'}</span>
                            </div>
                            <div class="audit-detail-item">
                                <span class="audit-detail-label">IP Address</span>
                                <span class="audit-detail-value">${record.ip_address || '-'}</span>
                            </div>
                        </div>
                        ${record.error_message ? `
                            <div style="margin-top: 10px; padding: 10px; background: rgba(220, 53, 69, 0.1); border-radius: 5px;">
                                <span class="audit-detail-label" style="color: #dc3545;">Error Message</span>
                                <p style="color: #721c24; margin-top: 5px; font-family: monospace; font-size: 0.9em;">${record.error_message}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            
            modalBody.innerHTML = html;
        }
        
        function closeAuditModal() {
            const modal = document.getElementById('auditModal');
            modal.classList.remove('active');
        }
        
        // Close modal when clicking outside
        document.getElementById('auditModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeAuditModal();
            }
        });
        
        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeAuditModal();
            }
        });
        
        // ==================== USER JOBS AUDIT TABLE ====================
        
        /**
         * Load and display user's jobs in the audit table
         * Fetches from GET /api/jobs/mine endpoint
         */
        async function loadUserJobsAudit() {
            const tbody = document.getElementById('userJobsTableBody');
            const jobsCount = document.getElementById('jobsCount');
            
            // Show loading state
            tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #999;">Loading jobs...</td></tr>';
            
            try {
                const response = await fetch('/api/jobs/mine');
                const data = await response.json();
                
                if (!data.success || !data.jobs || data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #999;">No jobs found. Run a Set Action to see history.</td></tr>';
                    jobsCount.textContent = 'No jobs found';
                    return;
                }
                
                // Helper function to get status badge
                function getStatusBadge(status, httpStatus, errorMessage) {
                    let badgeColor = '#999';
                    let textColor = '#fff';
                    let displayText = status || 'UNKNOWN';
                    let tooltip = '';
                    
                    if (status === 'SUCCESS') {
                        badgeColor = '#4caf50'; // Green
                        textColor = '#fff';
                    } else if (status === 'FAILED') {
                        badgeColor = '#dc3545'; // Red
                        textColor = '#fff';
                        if (httpStatus) {
                            tooltip = `HTTP ${httpStatus}`;
                        }
                        if (errorMessage) {
                            tooltip += `${tooltip ? ' - ' : ''}${errorMessage}`;
                        }
                    } else if (status === 'IN_PROGRESS') {
                        badgeColor = '#2196f3'; // Blue
                        textColor = '#fff';
                    }
                    
                    let badgeHtml = `<span style="background: ${badgeColor}; color: ${textColor}; padding: 6px 12px; border-radius: 6px; font-weight: 500; font-size: 0.85em;">
                        ${escapeHtml(displayText)}
                    </span>`;
                    
                    if (tooltip) {
                        badgeHtml = `<span title="${escapeHtml(tooltip)}">${badgeHtml}</span>`;
                    }
                    
                    return badgeHtml;
                }
                
                // Populate the table
                const jobs = data.jobs;
                tbody.innerHTML = jobs.map((job, index) => `
                    <tr style="border-bottom: 1px solid #e0e0e0; ${index % 2 === 0 ? 'background: #fafafa;' : ''}">
                        <td style="padding: 12px; font-family: monospace; font-size: 0.85em; color: #0066cc; word-break: break-all;">
                            <span style="cursor: pointer; text-decoration: underline;" onclick="copyToClipboard('${job.job_id}', this)" title="Click to copy Job ID">
                                ${escapeHtml(job.job_id)}
                            </span>
                        </td>
                        <td style="padding: 12px; color: #333;">${escapeHtml(job.action_name)}</td>
                        <td style="padding: 12px; text-align: center; color: #666;">
                            <span style="background: #e8f5e9; padding: 4px 8px; border-radius: 4px; font-weight: 500;">
                                ${job.customer_count || 0}
                            </span>
                        </td>
                        <td style="padding: 12px; text-align: center;">
                            ${getStatusBadge(job.status, job.http_status, job.error_message)}
                        </td>
                        <td style="padding: 12px; color: #666; font-size: 0.9em;">
                            ${formatTimestamp(job.created_at)}
                        </td>
                    </tr>
                `).join('');
                
                // Update count
                jobsCount.textContent = `Showing ${jobs.length} job${jobs.length !== 1 ? 's' : ''}`;
                
                console.log('[AUDIT_TABLE] Loaded', jobs.length, 'jobs for user');
                
            } catch (error) {
                console.error('[AUDIT_TABLE] Error loading jobs:', error);
                tbody.innerHTML = '<tr><td colspan="5" style="padding: 20px; text-align: center; color: #dc3545;">Error loading jobs. Please try again.</td></tr>';
                jobsCount.textContent = 'Error loading jobs';
            }
        }
        
        /**
         * Format ISO timestamp to readable format
         * Input: "2026-01-12T23:45:30"
         * Output: "Jan 12, 2026 11:45 PM"
         */
        function formatTimestamp(isoString) {
            try {
                const date = new Date(isoString);
                const options = { 
                    year: 'numeric', 
                    month: 'short', 
                    day: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                };
                return date.toLocaleDateString('en-US', options);
            } catch (e) {
                console.warn('[AUDIT_TABLE] Invalid timestamp:', isoString);
                return isoString || 'N/A';
            }
        }
        
        /**
         * Copy text to clipboard and show brief confirmation
         * @param {string} text - Text to copy to clipboard
         * @param {HTMLElement} element - Element to show confirmation in
         */
        function copyToClipboard(text, element) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = element.textContent;
                element.textContent = '‚úì Copied!';
                element.style.color = '#01A982';
                setTimeout(() => {
                    element.textContent = originalText;
                    element.style.color = '#0066cc';
                }, 2000);
            }).catch(err => {
                console.error('[AUDIT_TABLE] Failed to copy:', err);
                alert('Failed to copy Job ID');
            });
        }
        
        
        /**
         * Escape HTML special characters to prevent XSS
         */
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
        
        // ===== TOKEN SECURITY: CLEAR ON TAB VISIBILITY CHANGE =====
        // When user switches away from tab and comes back, clear the token panel
        // This prevents stale tokens from being visible on return
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                // User left the page/tab
                console.log('[TOKEN] Page hidden, clearing token state');
                // Don't hide immediately, just flag it
            } else {
                // User returned to the page/tab
                // If token panel is visible AND more than 1 second has passed, hide it
                const tokenPanel = document.getElementById('tokenResultSection');
                if (tokenPanel && tokenPanel.style.display !== 'none' && lastTokenGeneratedAt) {
                    const elapsedSeconds = (Date.now() - lastTokenGeneratedAt) / 1000;
                    if (elapsedSeconds > 1) {
                        // User was away, hide the token panel for security
                        hideTokenPanel();
                        console.log('[TOKEN] Cleared token panel on tab return (was away for ' + elapsedSeconds.toFixed(1) + 's)');
                    }
                }
            }
        });
        
        // Load jobs when Set Action tab becomes visible
        // This will be called after successful Set Action
        // Initial load on page load will happen through initialization
    </script>
    
    
    <!-- Audit History Modal -->
    <div id="auditModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Action History</h2>
                <button class="modal-close" onclick="closeAuditModal()">√ó</button>
            </div>
            <div class="modal-body" id="auditModalBody">
                <div class="loading-spinner">‚è≥ Loading audit history...</div>
            </div>
        </div>
    </div>
</body>
</html>
